<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Topic 2 セレクションバイアス | KUT 計量経済学応用</title>
  <meta name="description" content="Topic 2 セレクションバイアス | KUT 計量経済学応用" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Topic 2 セレクションバイアス | KUT 計量経済学応用" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Topic 2 セレクションバイアス | KUT 計量経済学応用" />
  
  
  

<meta name="author" content="矢内 勇生" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="RCT.html"/>
<script src="libs/header-attrs-2.2/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">KUT 計量経済学応用</a></li>
<li><a href="https://yukiyanai.github.io/" target="_blank">矢内 勇生 (Yuki Yanai)</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>はじめに</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#この資料について"><i class="fa fa-check"></i><b>0.1</b> この資料について</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#履修条件"><i class="fa fa-check"></i><b>0.2</b> 履修条件</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#r-とrstudio-のインストール"><i class="fa fa-check"></i><b>0.3</b> R とRStudio のインストール</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#授業計画"><i class="fa fa-check"></i><b>0.4</b> 授業計画</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> イントロダクション</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#予習と講義動画の視聴"><i class="fa fa-check"></i><b>1.1</b> 予習と講義動画の視聴</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#slack"><i class="fa fa-check"></i><b>1.2</b> Slack</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="introduction.html"><a href="introduction.html#slack-とは"><i class="fa fa-check"></i><b>1.2.1</b> Slack とは？</a></li>
<li class="chapter" data-level="1.2.2" data-path="introduction.html"><a href="introduction.html#授業用ワークスペースへの登録"><i class="fa fa-check"></i><b>1.2.2</b> 授業用ワークスペースへの登録</a></li>
<li class="chapter" data-level="1.2.3" data-path="introduction.html"><a href="introduction.html#利用上の注意"><i class="fa fa-check"></i><b>1.2.3</b> 利用上の注意</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#rstudio-cloud-の初期設定"><i class="fa fa-check"></i><b>1.3</b> RStudio Cloud の初期設定</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#ユーザ登録"><i class="fa fa-check"></i><b>1.3.1</b> ユーザ登録</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#授業用のプロジェクトを作る"><i class="fa fa-check"></i><b>1.3.2</b> 授業用のプロジェクトを作る</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#rstudio-のカスタマイズ"><i class="fa fa-check"></i><b>1.3.3</b> RStudio のカスタマイズ</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#パッケージのインストール"><i class="fa fa-check"></i><b>1.3.4</b> パッケージのインストール</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#ディレクトリの作成"><i class="fa fa-check"></i><b>1.3.5</b> ディレクトリの作成</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#図で日本語が使えるようにする"><i class="fa fa-check"></i><b>1.3.6</b> 図で日本語が使えるようにする</a></li>
<li class="chapter" data-level="1.3.7" data-path="introduction.html"><a href="introduction.html#r-markdown-からpdfファイルを作る"><i class="fa fa-check"></i><b>1.3.7</b> R Markdown からPDFファイルを作る</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#トピック1の課題"><i class="fa fa-check"></i><b>1.4</b> トピック1の課題</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="selection-bias.html"><a href="selection-bias.html"><i class="fa fa-check"></i><b>2</b> セレクションバイアス</a>
<ul>
<li class="chapter" data-level="2.1" data-path="selection-bias.html"><a href="selection-bias.html#準備"><i class="fa fa-check"></i><b>2.1</b> 準備</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="selection-bias.html"><a href="selection-bias.html#予習講義動画実習課題"><i class="fa fa-check"></i><b>2.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="2.1.2" data-path="selection-bias.html"><a href="selection-bias.html#rパッケージの読み込み"><i class="fa fa-check"></i><b>2.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="2.1.3" data-path="selection-bias.html"><a href="selection-bias.html#このトピックで使うrコードの説明"><i class="fa fa-check"></i><b>2.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="selection-bias.html"><a href="selection-bias.html#セレクションバイアスのシミュレーション"><i class="fa fa-check"></i><b>2.2</b> セレクションバイアスのシミュレーション</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="selection-bias.html"><a href="selection-bias.html#メールによる販促の効果"><i class="fa fa-check"></i><b>2.2.1</b> メールによる販促の効果</a></li>
<li class="chapter" data-level="2.2.2" data-path="selection-bias.html"><a href="selection-bias.html#通院と健康状態セルフセレクション"><i class="fa fa-check"></i><b>2.2.2</b> 通院と健康状態：セルフセレクション</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="selection-bias.html"><a href="selection-bias.html#トピック2の課題"><i class="fa fa-check"></i><b>2.3</b> トピック2の課題</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="RCT.html"><a href="RCT.html"><i class="fa fa-check"></i><b>3</b> RCT（ランダム化比較試験）</a>
<ul>
<li class="chapter" data-level="3.1" data-path="RCT.html"><a href="RCT.html#準備-1"><i class="fa fa-check"></i><b>3.1</b> 準備</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="RCT.html"><a href="RCT.html#予習講義動画実習課題-1"><i class="fa fa-check"></i><b>3.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="3.1.2" data-path="RCT.html"><a href="RCT.html#rパッケージの読み込み-1"><i class="fa fa-check"></i><b>3.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="3.1.3" data-path="RCT.html"><a href="RCT.html#このトピックで使うrコードの説明-1"><i class="fa fa-check"></i><b>3.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="RCT.html"><a href="RCT.html#ランダム化のシミュレーション"><i class="fa fa-check"></i><b>3.2</b> ランダム化のシミュレーション</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="RCT.html"><a href="RCT.html#母集団の設定"><i class="fa fa-check"></i><b>3.2.1</b> 母集団の設定</a></li>
<li class="chapter" data-level="3.2.2" data-path="RCT.html"><a href="RCT.html#ベルヌーイ実験"><i class="fa fa-check"></i><b>3.2.2</b> ベルヌーイ実験</a></li>
<li class="chapter" data-level="3.2.3" data-path="RCT.html"><a href="RCT.html#完全ランダム化実験"><i class="fa fa-check"></i><b>3.2.3</b> 完全ランダム化実験</a></li>
<li class="chapter" data-level="3.2.4" data-path="RCT.html"><a href="RCT.html#ブロック別ランダム化実験"><i class="fa fa-check"></i><b>3.2.4</b> ブロック別ランダム化実験</a></li>
<li class="chapter" data-level="3.2.5" data-path="RCT.html"><a href="RCT.html#ペア毎のランダム化実験"><i class="fa fa-check"></i><b>3.2.5</b> ペア毎のランダム化実験</a></li>
<li class="chapter" data-level="3.2.6" data-path="RCT.html"><a href="RCT.html#つのrct-を比較する"><i class="fa fa-check"></i><b>3.2.6</b> 4つのRCT を比較する</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="RCT.html"><a href="RCT.html#トピック3の課題"><i class="fa fa-check"></i><b>3.3</b> トピック3の課題</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regression.html"><a href="regression.html"><i class="fa fa-check"></i><b>4</b> 回帰分析</a>
<ul>
<li class="chapter" data-level="4.1" data-path="regression.html"><a href="regression.html#準備-2"><i class="fa fa-check"></i><b>4.1</b> 準備</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="regression.html"><a href="regression.html#予習講義動画実習課題-2"><i class="fa fa-check"></i><b>4.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="4.1.2" data-path="regression.html"><a href="regression.html#rパッケージの読み込み-2"><i class="fa fa-check"></i><b>4.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="4.1.3" data-path="regression.html"><a href="regression.html#関数の自作"><i class="fa fa-check"></i><b>4.1.3</b> 関数の自作</a></li>
<li class="chapter" data-level="4.1.4" data-path="regression.html"><a href="regression.html#このトピックで使うrコードの説明-2"><i class="fa fa-check"></i><b>4.1.4</b> このトピックで使うRコードの説明</a></li>
<li class="chapter" data-level="4.1.5" data-path="regression.html"><a href="regression.html#purrrmapと-sapply"><i class="fa fa-check"></i><b>4.1.5</b> <code>purrr::map()</code>と <code>sapply()</code></a></li>
<li class="chapter" data-level="4.1.6" data-path="regression.html"><a href="regression.html#purrrarray_tree"><i class="fa fa-check"></i><b>4.1.6</b> <code>purrr::array_tree()</code></a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="regression.html"><a href="regression.html#回帰分析のシミュレーション"><i class="fa fa-check"></i><b>4.2</b> 回帰分析のシミュレーション</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="regression.html"><a href="regression.html#単回帰"><i class="fa fa-check"></i><b>4.2.1</b> 単回帰</a></li>
<li class="chapter" data-level="4.2.2" data-path="regression.html"><a href="regression.html#重回帰"><i class="fa fa-check"></i><b>4.2.2</b> 重回帰</a></li>
<li class="chapter" data-level="4.2.3" data-path="regression.html"><a href="regression.html#重回帰によるブロッキング"><i class="fa fa-check"></i><b>4.2.3</b> 重回帰によるブロッキング</a></li>
<li class="chapter" data-level="4.2.4" data-path="regression.html"><a href="regression.html#重回帰分析によるセレクションバイアスの除去"><i class="fa fa-check"></i><b>4.2.4</b> 重回帰分析によるセレクションバイアスの除去</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="regression.html"><a href="regression.html#脱落変数バイアスと処置後変数バイアス"><i class="fa fa-check"></i><b>4.3</b> 脱落変数バイアスと処置後変数バイアス</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="regression.html"><a href="regression.html#脱落変数バイアス-ovb"><i class="fa fa-check"></i><b>4.3.1</b> 脱落変数バイアス (OVB)</a></li>
<li class="chapter" data-level="4.3.2" data-path="regression.html"><a href="regression.html#処置後変数バイアス"><i class="fa fa-check"></i><b>4.3.2</b> 処置後変数バイアス</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="regression.html"><a href="regression.html#dag有向非巡回グラフ"><i class="fa fa-check"></i><b>4.4</b> DAG（有向非巡回グラフ）</a></li>
<li class="chapter" data-level="4.5" data-path="regression.html"><a href="regression.html#トピック4の課題"><i class="fa fa-check"></i><b>4.5</b> トピック4の課題</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="propensity-score.html"><a href="propensity-score.html"><i class="fa fa-check"></i><b>5</b> 傾向スコア</a></li>
<li class="chapter" data-level="6" data-path="panel-data.html"><a href="panel-data.html"><i class="fa fa-check"></i><b>6</b> パネルデータ分析</a></li>
<li class="chapter" data-level="7" data-path="midterm-presentation.html"><a href="midterm-presentation.html"><i class="fa fa-check"></i><b>7</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#このトピックでやるべきこと"><i class="fa fa-check"></i><b>7.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="7.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#分析計画のプレゼンテーション-1"><i class="fa fa-check"></i><b>7.2</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの内容"><i class="fa fa-check"></i><b>7.2.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="7.2.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの方法"><i class="fa fa-check"></i><b>7.2.2</b> プレゼンテーションの方法</a></li>
<li class="chapter" data-level="7.2.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーション動画の作成法"><i class="fa fa-check"></i><b>7.2.3</b> プレゼンテーション動画の作成法</a></li>
<li class="chapter" data-level="7.2.4" data-path="midterm-presentation.html"><a href="midterm-presentation.html#提出方法と提出期限"><i class="fa fa-check"></i><b>7.2.4</b> 提出方法と提出期限</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#他の受講生へのコメントについて"><i class="fa fa-check"></i><b>7.3</b> 他の受講生へのコメントについて</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html"><i class="fa fa-check"></i><b>8</b> 回帰不連続デザイン</a></li>
<li class="chapter" data-level="9" data-path="instrumental-variable.html"><a href="instrumental-variable.html"><i class="fa fa-check"></i><b>9</b> 操作変数法</a></li>
<li class="chapter" data-level="10" data-path="final-presentation.html"><a href="final-presentation.html"><i class="fa fa-check"></i><b>10</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.1" data-path="final-presentation.html"><a href="final-presentation.html#このトピックでやるべきこと-1"><i class="fa fa-check"></i><b>10.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="10.2" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のレポート期末レポート"><i class="fa fa-check"></i><b>10.2</b> 分析結果のレポート（期末レポート）</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="final-presentation.html"><a href="final-presentation.html#レポートの内容"><i class="fa fa-check"></i><b>10.2.1</b> レポートの内容</a></li>
<li class="chapter" data-level="10.2.2" data-path="final-presentation.html"><a href="final-presentation.html#レポートの形式と提出方法"><i class="fa fa-check"></i><b>10.2.2</b> レポートの形式と提出方法</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のプレゼンテーション-1"><i class="fa fa-check"></i><b>10.3</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="final-presentation.html"><a href="final-presentation.html#プレゼンテーションの内容-1"><i class="fa fa-check"></i><b>10.3.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="10.3.2" data-path="final-presentation.html"><a href="final-presentation.html#提出方法と提出期限-1"><i class="fa fa-check"></i><b>10.3.2</b> 提出方法と提出期限</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>参考文献</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="_blank">Published with bookdown</a></li>  
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">KUT 計量経済学応用</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="セレクションバイアス" class="section level1" number="2">
<h1><span class="header-section-number">Topic 2</span> セレクションバイアス</h1>
<ul>
<li><a href="https://yukiyanai.github.io/jp/classes/econometrics2/contents/slides/metrics2_topic02_slides_pub.pdf">トピック2の講義スライド</a> (PDF, 2.6MB)</li>
</ul>
<div id="準備" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> 準備</h2>
<div id="予習講義動画実習課題" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> 予習、講義動画、実習課題</h3>
<p>このトピックでやるべきことは、以下のとおりである。</p>
<ol style="list-style-type: decimal">
<li><a href="http://yukiyanai.github.io/jp/classes/econometrics2/docs/syllabus-applied-econometrics_2020-2Q.pdf">シラバス(PDFファイル)</a> に記載されているトピック2の予習課題を読む。</li>
<li><a href="https://lms.kochi-tech.ac.jp/course/view.php?id=793">KUTLMS (Moodle)</a> にあるトピック2の講義動画を視聴する。</li>
<li>この資料の続きを読み、Rを使った実習を行うことでセレクションバイアスの理解を深める。</li>
</ol>
<ul>
<li>まず、書いてあるコードをそのまま実行する。</li>
<li>自分で数字（シミュレーションの条件）を変えて、結果がどう変わるか研究する（これが<strong>課題</strong>）。</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>（おまけ：希望者のみ）Josh Angrist による以下の解説動画（英語）を視聴する。</li>
</ol>
<ul>
<li><a href="https://www.youtube.com/watch?v=iPBV3BlV7jk">Ceteris Paribus</a> （他の条件が等しければ）</li>
<li><a href="https://www.youtube.com/watch?v=6YrIDhaUQOE">Selection Bias</a>（セレクションバイアス）</li>
</ul>
</div>
<div id="rパッケージの読み込み" class="section level3" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> Rパッケージの読み込み</h3>
<p>必要なパッケージを読み込み、作図用の日本語フォントを設定する。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="selection-bias.html#cb21-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(tidyverse)</span>
<span id="cb21-2"><a href="selection-bias.html#cb21-2"></a><span class="kw">theme_set</span>(<span class="kw">theme_gray</span>(<span class="dt">base_size =</span> <span class="dv">10</span>, <span class="dt">base_family =</span> <span class="st">&quot;HiraginoSans-W3&quot;</span>))  <span class="co"># macOS用</span></span>
<span id="cb21-3"><a href="selection-bias.html#cb21-3"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;Meiryo&quot;))        # Windows用</span></span>
<span id="cb21-4"><a href="selection-bias.html#cb21-4"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;ipaex&quot;))         # Ubuntu用</span></span>
<span id="cb21-5"><a href="selection-bias.html#cb21-5"></a><span class="co">#showtext::showtext_auto()                                            # Cloud用</span></span>
<span id="cb21-6"><a href="selection-bias.html#cb21-6"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;noto&quot;))          # Cloud用</span></span></code></pre></div>
</div>
<div id="このトピックで使うrコードの説明" class="section level3" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> このトピックで使うRコードの説明</h3>
<p>このトピックで新たに使うRの関数について説明する。</p>
<div id="dplyrcase_when" class="section level4" number="2.1.3.1">
<h4><span class="header-section-number">2.1.3.1</span> <code>dplyr::case_when()</code></h4>
<p><code>dplyr::case_when()</code> は、複数の条件によって変数の値を変えるときに使う。</p>
<p>例えば、gender という変数があり、値が「女」と「男」の二値だけであるとしよう。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="selection-bias.html#cb22-1"></a>gender &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;女&quot;</span>, <span class="st">&quot;男&quot;</span>), <span class="dt">size =</span> <span class="dv">100</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb22-2"><a href="selection-bias.html#cb22-2"></a><span class="kw">table</span>(gender)</span></code></pre></div>
<pre><code>## gender
## 女 男 
## 60 40</code></pre>
<p>この変数の値が「女」のときは1、「男」のときは0になる female というダミー変数は、<code>ifelse()</code> で作れる。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="selection-bias.html#cb24-1"></a>female &lt;-<span class="st"> </span><span class="kw">ifelse</span>(gender <span class="op">==</span><span class="st"> &quot;女&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb24-2"><a href="selection-bias.html#cb24-2"></a><span class="kw">table</span>(female)</span></code></pre></div>
<pre><code>## female
##  0  1 
## 40 60</code></pre>
<p>同様に、male ダミーは、</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="selection-bias.html#cb26-1"></a><span class="co">#male &lt;- 1 - female　# female が既にあるのでこれでもOK</span></span>
<span id="cb26-2"><a href="selection-bias.html#cb26-2"></a>male &lt;-<span class="st"> </span><span class="kw">ifelse</span>(gender <span class="op">==</span><span class="st"> &quot;男&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb26-3"><a href="selection-bias.html#cb26-3"></a><span class="kw">table</span>(male)</span></code></pre></div>
<pre><code>## male
##  0  1 
## 60 40</code></pre>
<p>で作れる。</p>
<p>このように、<code>ifelse()</code> は、条件が1つしかない場合分け（つまり、2つの場合に分けるとき）には便利である。</p>
<p>次に、gender2 という変数があり、取り得る値が「女」「男」「その他」の3種類であるとする。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="selection-bias.html#cb28-1"></a>gender2 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;女&quot;</span>, <span class="st">&quot;男&quot;</span>, <span class="st">&quot;その他&quot;</span>), <span class="dt">size =</span> <span class="dv">100</span>, </span>
<span id="cb28-2"><a href="selection-bias.html#cb28-2"></a>                  <span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.45</span>, <span class="fl">0.45</span>, <span class="fl">0.1</span>))</span>
<span id="cb28-3"><a href="selection-bias.html#cb28-3"></a><span class="kw">table</span>(gender2)</span></code></pre></div>
<pre><code>## gender2
## その他     女     男 
##      9     41     50</code></pre>
<p>この変数の値を英語に変換したいとする。これも、<code>ifelse()</code>でできる。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="selection-bias.html#cb30-1"></a>gender_eng1 &lt;-<span class="st"> </span><span class="kw">ifelse</span>(gender2 <span class="op">==</span><span class="st"> &quot;女&quot;</span>, <span class="st">&quot;female&quot;</span>,</span>
<span id="cb30-2"><a href="selection-bias.html#cb30-2"></a>                      <span class="kw">ifelse</span>(gender2 <span class="op">==</span><span class="st"> &quot;男&quot;</span>, <span class="st">&quot;male&quot;</span>, <span class="st">&quot;other&quot;</span>))</span>
<span id="cb30-3"><a href="selection-bias.html#cb30-3"></a><span class="kw">table</span>(gender_eng1)</span></code></pre></div>
<pre><code>## gender_eng1
## female   male  other 
##     41     50      9</code></pre>
<p>このように、<code>ifelse()</code> を入れ子にして使えば、変数を3つ以上の場合に分けることもできる。
しかし、<code>ifelse()</code> を入れ子にするとコードが読みにくい。3つの場合分けならまだマシだが、場合分けの数が増えると厄介だ。そこで、<code>dplyr::case_when()</code> を使う。</p>
<p>次のようにする。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="selection-bias.html#cb32-1"></a>gender_eng2 &lt;-<span class="st"> </span><span class="kw">case_when</span>(</span>
<span id="cb32-2"><a href="selection-bias.html#cb32-2"></a>  gender2 <span class="op">==</span><span class="st"> &quot;女&quot;</span> <span class="op">~</span><span class="st"> &quot;female&quot;</span>,</span>
<span id="cb32-3"><a href="selection-bias.html#cb32-3"></a>  gender2 <span class="op">==</span><span class="st"> &quot;男&quot;</span> <span class="op">~</span><span class="st"> &quot;male&quot;</span>,</span>
<span id="cb32-4"><a href="selection-bias.html#cb32-4"></a>  <span class="ot">TRUE</span>            <span class="op">~</span><span class="st"> &quot;other&quot;</span></span>
<span id="cb32-5"><a href="selection-bias.html#cb32-5"></a>)</span>
<span id="cb32-6"><a href="selection-bias.html#cb32-6"></a><span class="kw">table</span>(gender_eng2)</span></code></pre></div>
<pre><code>## gender_eng2
## female   male  other 
##     41     50      9</code></pre>
<p>このように、<code>case_when()</code> では、<code>条件 ~ 条件がTRUE のときの値</code> という書き方をする。条件の評価は、上から順番に行われる。したがって、上の例では <code>gender2 == "男"</code> の評価が終わった時点で残りは 「その他」だけなので、残り全てを “ohter” にするために、最後の条件を <code>TRUE</code> にしている。</p>
<p>条件が順番に評価されることを理解するために、もう1つ例をあげる。
まず、アルファベットをランダムに生成する。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="selection-bias.html#cb34-1"></a>rchs &lt;-<span class="st"> </span><span class="kw">sample</span>(letters, <span class="dt">size =</span> <span class="dv">500</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb34-2"><a href="selection-bias.html#cb34-2"></a><span class="kw">table</span>(rchs)</span></code></pre></div>
<pre><code>## rchs
##  a  b  c  d  e  f  g  h  i  j  k  l  m  n  o  p  q  r  s  t  u  v  w  x  y  z 
## 19 15 19 14 21 21 23 17 19 15 21 13 28 16 16 20 21 24 24 11 16 28 19 23 19 18</code></pre>
<p>これをアルファベット順に基づいて適当なグループに分ける。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="selection-bias.html#cb36-1"></a>group_chs &lt;-<span class="st"> </span><span class="kw">case_when</span>(</span>
<span id="cb36-2"><a href="selection-bias.html#cb36-2"></a>  rchs <span class="op">&lt;</span><span class="st"> &quot;e&quot;</span> <span class="op">~</span><span class="st"> &quot;a2d&quot;</span>,</span>
<span id="cb36-3"><a href="selection-bias.html#cb36-3"></a>  rchs <span class="op">&lt;</span><span class="st"> &quot;i&quot;</span> <span class="op">~</span><span class="st"> &quot;e2h&quot;</span>,</span>
<span id="cb36-4"><a href="selection-bias.html#cb36-4"></a>  rchs <span class="op">&lt;</span><span class="st"> &quot;o&quot;</span> <span class="op">~</span><span class="st"> &quot;i2n&quot;</span>,</span>
<span id="cb36-5"><a href="selection-bias.html#cb36-5"></a>  rchs <span class="op">&lt;</span><span class="st"> &quot;t&quot;</span> <span class="op">~</span><span class="st"> &quot;o2s&quot;</span>,</span>
<span id="cb36-6"><a href="selection-bias.html#cb36-6"></a>  rchs <span class="op">&lt;</span><span class="st"> &quot;y&quot;</span> <span class="op">~</span><span class="st"> &quot;t2x&quot;</span>,</span>
<span id="cb36-7"><a href="selection-bias.html#cb36-7"></a>  <span class="ot">TRUE</span>       <span class="op">~</span><span class="st"> &quot;y2z&quot;</span></span>
<span id="cb36-8"><a href="selection-bias.html#cb36-8"></a>)</span>
<span id="cb36-9"><a href="selection-bias.html#cb36-9"></a><span class="kw">table</span>(group_chs)</span></code></pre></div>
<pre><code>## group_chs
## a2d e2h i2n o2s t2x y2z 
##  67  82 112 105  97  37</code></pre>
</div>
</div>
</div>
<div id="セレクションバイアスのシミュレーション" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> セレクションバイアスのシミュレーション</h2>
<div id="メールによる販促の効果" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> メールによる販促の効果</h3>
<p>教科書 <span class="citation">(安井 <a href="#ref-yasui2020" role="doc-biblioref">2020</a>)</span> の第1章（pp.4-6）にある、メールによる販売促進施策のセレクションバイアスを、シミュレーションによって確かめてみよう。</p>
<p>まず、対象全体の人数を決める。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="selection-bias.html#cb38-1"></a>N &lt;-<span class="st"> </span><span class="dv">1000</span></span></code></pre></div>
<p>次に、N人をメールがないときに商品を買いやすいグループAと、商品をあまり買わないグループBに分けよう。ここでは、同じ人数に分けることにする。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="selection-bias.html#cb39-1"></a>d1 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">group =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dt">each =</span> N <span class="op">/</span><span class="dv">2</span>))</span></code></pre></div>
<p>グループAとBが、メールを受け取らなかったときに商品を買う確率 pA と pB を決める。ただし、pA <span class="math inline">\(&gt;\)</span> pB である。</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="selection-bias.html#cb40-1"></a>pA &lt;-<span class="st"> </span><span class="fl">0.6</span></span>
<span id="cb40-2"><a href="selection-bias.html#cb40-2"></a>pB &lt;-<span class="st"> </span><span class="fl">0.3</span></span></code></pre></div>
<p>次に、誰にメールを送るかを決めよう。教科書 <span class="citation">(安井 <a href="#ref-yasui2020" role="doc-biblioref">2020</a>)</span> に書かれているとおり、元々商品を買いそうな人にメールを送りやすいと考えて、各グループのメンバがメールを受け取る確率をそれぞれ pA / (pA + pB)、pB / (pA + pB ) としよう。また、メールは全部で N/2 人に送ることにする。メールを受け取れば1、受けとらなければ0をとる mail という変数を作る。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="selection-bias.html#cb41-1"></a>n_mail &lt;-<span class="st"> </span>N <span class="op">/</span><span class="st"> </span><span class="dv">2</span></span>
<span id="cb41-2"><a href="selection-bias.html#cb41-2"></a>n_receive &lt;-<span class="st"> </span><span class="kw">round</span>(n_mail <span class="op">*</span><span class="st"> </span><span class="kw">c</span>(pA, pB) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(pA, pB))</span>
<span id="cb41-3"><a href="selection-bias.html#cb41-3"></a>d1<span class="op">$</span>mail &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb41-4"><a href="selection-bias.html#cb41-4"></a>                 <span class="dt">times =</span> <span class="kw">c</span>(n_receive[<span class="dv">1</span>], N <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span>n_receive[<span class="dv">1</span>],</span>
<span id="cb41-5"><a href="selection-bias.html#cb41-5"></a>                 n_receive[<span class="dv">2</span>], N <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span>n_receive[<span class="dv">2</span>]))</span></code></pre></div>
<p>メールを送ることによって商品を購入する確率がどれくらい上がるか、つまり、メールの効果である tau (<span class="math inline">\(\tau\)</span>) の値を決める。ここでは、0.05ポイント上昇することにしよう。ここで設定する値が<strong>本当の因果効果</strong>である。</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="selection-bias.html#cb42-1"></a>tau &lt;-<span class="st"> </span><span class="fl">0.05</span></span></code></pre></div>
<p>メールの送信が終わった後の購買行動を決める。まず、メール送信後の各人の購買確率を計算する。
Aの購買確率はメールを受け取らなければ pA、受け取れば pA + tau である。同様に、Bの購買確率はメールを受け取らなければ pB、受け取れば pB + tau である。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="selection-bias.html#cb43-1"></a>d1 &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb43-2"><a href="selection-bias.html#cb43-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_after =</span> <span class="kw">ifelse</span>(group <span class="op">==</span><span class="st"> &quot;A&quot;</span>, </span>
<span id="cb43-3"><a href="selection-bias.html#cb43-3"></a>                          pA <span class="op">+</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>mail, </span>
<span id="cb43-4"><a href="selection-bias.html#cb43-4"></a>                          pB <span class="op">+</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>mail))</span></code></pre></div>
<p>確率によって、商品を買うかどうかをベルヌーイ 試行 (Bernoulli) で決める。つまり、確率 <span class="math inline">\(p\)</span> で表が出るコインを投げて、表が出たら購入し、裏が出たら購入しないと考える。
<span class="math inline">\(\mbox{Bernoulli}(p) = \mbox{Binomial}(1, p)\)</span> なので、Rでベルヌーイ試行を実行するには、二項分布 (binomial distribution) から乱数を生成する <code>rbinom()</code>を<code>size = 1</code> にして使えば良い。</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="selection-bias.html#cb44-1"></a><span class="kw">set.seed</span>(<span class="dv">2020</span>)</span>
<span id="cb44-2"><a href="selection-bias.html#cb44-2"></a>d1 &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-3"><a href="selection-bias.html#cb44-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">purchase =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_after))</span></code></pre></div>
<p>メール受信状況別の購入割合は</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="selection-bias.html#cb45-1"></a>d1_gr &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-2"><a href="selection-bias.html#cb45-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mail =</span> <span class="kw">factor</span>(mail, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;メールなし&quot;</span>, <span class="st">&quot;メールあり&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-3"><a href="selection-bias.html#cb45-3"></a><span class="st">  </span><span class="kw">group_by</span>(mail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-4"><a href="selection-bias.html#cb45-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">purchase_rate =</span> <span class="kw">mean</span>(purchase)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-5"><a href="selection-bias.html#cb45-5"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   mail       purchase_rate
##   &lt;fct&gt;              &lt;dbl&gt;
## 1 メールなし         0.366
## 2 メールあり         0.574</code></pre>
<p>である。図にすると、</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="selection-bias.html#cb47-1"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(d1_gr, <span class="kw">aes</span>(<span class="dt">x =</span> mail, <span class="dt">weight =</span> purchase_rate)) <span class="op">+</span></span>
<span id="cb47-2"><a href="selection-bias.html#cb47-2"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">width=</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb47-3"><a href="selection-bias.html#cb47-3"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;購買率&quot;</span>)</span>
<span id="cb47-4"><a href="selection-bias.html#cb47-4"></a><span class="kw">plot</span>(p1)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-37-1.png" width="288" /></p>
<p>となる。単純に比較すると、</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="selection-bias.html#cb48-1"></a>d1_gr <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-2"><a href="selection-bias.html#cb48-2"></a><span class="st">  </span><span class="kw">pull</span>(purchase_rate) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-3"><a href="selection-bias.html#cb48-3"></a><span class="st">  </span><span class="kw">diff</span>()</span></code></pre></div>
<pre><code>## [1] 0.208</code></pre>
<p>がメールの効果のように見えてしまう。しかし、実際のメールの効果は、先ほど設定したとおり0.05 である。</p>
<p>ちなみに、この「バイアスを含む効果」は単回帰によっても得られる。</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="selection-bias.html#cb50-1"></a>fit &lt;-<span class="st"> </span><span class="kw">lm</span>(purchase <span class="op">~</span><span class="st"> </span>mail, <span class="dt">data =</span> d1)</span>
<span id="cb50-2"><a href="selection-bias.html#cb50-2"></a><span class="kw">summary</span>(fit)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = purchase ~ mail, data = d1)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -0.574 -0.366 -0.366  0.426  0.634 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  0.36600    0.02185  16.749  &lt; 2e-16
## mail         0.20800    0.03090   6.731 2.85e-11
## 
## Residual standard error: 0.4886 on 998 degrees of freedom
## Multiple R-squared:  0.04342,    Adjusted R-squared:  0.04246 
## F-statistic:  45.3 on 1 and 998 DF,  p-value: 2.846e-11</code></pre>
<p>mail の効果の推定値は、0.21 である。また、その <span class="math inline">\(p\)</span>値が<span class="math inline">\(2.85 \times 10^{-11} &lt; 0.001\)</span> なので、この効果は有意水準0.001（0.1%）で統計的に有意である。<strong>単に「統計的に有意かどうか」を調べることには意味がない</strong>ことがよくわかるだろう。</p>
<p>このように、処置（介入）の値が結果（購入確率）に依存していると、バイアスが生じる。この場合は、効果が過大評価されてしまう。</p>
<p>1回のシミュレーションでは、偶然そうなっただけかもしれないので、これを複数回（できるだけ多く）繰り返そう。
そのために、関数を用意する。返り値（戻り値）は、単純比較から得られる効果の大きさとする。</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="selection-bias.html#cb52-1"></a>sim_mail &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">tau =</span> <span class="fl">0.05</span>, <span class="dt">N =</span> <span class="dv">1000</span>, <span class="dt">n_mail =</span> N <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">pA =</span> <span class="fl">0.6</span>, <span class="dt">pB =</span> <span class="fl">0.3</span>) {</span>
<span id="cb52-2"><a href="selection-bias.html#cb52-2"></a>  <span class="co"># 引数の条件を設定する：条件を満たさない場合はエラー</span></span>
<span id="cb52-3"><a href="selection-bias.html#cb52-3"></a>  <span class="cf">if</span> (pA <span class="op">&lt;=</span><span class="st"> </span>pB) <span class="kw">stop</span>(<span class="st">&quot;pA must be larger than pB.&quot;</span>)</span>
<span id="cb52-4"><a href="selection-bias.html#cb52-4"></a>  <span class="cf">if</span> (N <span class="op">&lt;</span><span class="st"> </span>n_mail) <span class="kw">stop</span>(<span class="st">&quot;N must be larger than n_mail.&quot;</span>)</span>
<span id="cb52-5"><a href="selection-bias.html#cb52-5"></a>  <span class="cf">if</span> (pA <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>pB <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">stop</span>(<span class="st">&quot;pA and pB must be in the range [0, 1].&quot;</span>)</span>
<span id="cb52-6"><a href="selection-bias.html#cb52-6"></a>  <span class="cf">if</span> (tau <span class="op">+</span><span class="st"> </span>pA <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="kw">stop</span>(<span class="st">&quot;beta + pA must be equal to or smaller than 1.&quot;</span>)</span>
<span id="cb52-7"><a href="selection-bias.html#cb52-7"></a>  <span class="cf">if</span> (tau <span class="op">+</span><span class="st"> </span>pB <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">stop</span>(<span class="st">&quot;beta + pB must be equal to or greater than 0.&quot;</span>)</span>
<span id="cb52-8"><a href="selection-bias.html#cb52-8"></a></span>
<span id="cb52-9"><a href="selection-bias.html#cb52-9"></a>  group &lt;-<span class="st">  </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dt">each =</span> N <span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb52-10"><a href="selection-bias.html#cb52-10"></a>  n_receive &lt;-<span class="st"> </span><span class="kw">round</span>(n_mail <span class="op">*</span><span class="st"> </span><span class="kw">c</span>(pA, pB) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(pA, pB))</span>
<span id="cb52-11"><a href="selection-bias.html#cb52-11"></a>  mail &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb52-12"><a href="selection-bias.html#cb52-12"></a>              <span class="dt">times =</span> <span class="kw">c</span>(n_receive[<span class="dv">1</span>], N <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span>n_receive[<span class="dv">1</span>],</span>
<span id="cb52-13"><a href="selection-bias.html#cb52-13"></a>              n_receive[<span class="dv">2</span>], N <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span>n_receive[<span class="dv">2</span>]))</span>
<span id="cb52-14"><a href="selection-bias.html#cb52-14"></a>  p_after &lt;-<span class="st"> </span><span class="kw">ifelse</span>(group <span class="op">==</span><span class="st"> &quot;A&quot;</span>, pA <span class="op">+</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>mail, pB <span class="op">+</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>mail)</span>
<span id="cb52-15"><a href="selection-bias.html#cb52-15"></a>  purchase &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_after)</span>
<span id="cb52-16"><a href="selection-bias.html#cb52-16"></a>  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(purchase <span class="op">~</span><span class="st"> </span>mail)</span>
<span id="cb52-17"><a href="selection-bias.html#cb52-17"></a>  <span class="kw">return</span>(<span class="kw">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb52-18"><a href="selection-bias.html#cb52-18"></a>}</span></code></pre></div>
<p>試しに、<code>tau = 0.05</code> で1回シミュレーションしてみる。</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="selection-bias.html#cb53-1"></a><span class="kw">sim_mail</span>(<span class="dt">tau =</span> <span class="fl">0.05</span>)</span></code></pre></div>
<pre><code>##  mail 
## 0.142</code></pre>
<p>tau、pA、pB の値を変えてみる。</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="selection-bias.html#cb55-1"></a><span class="kw">sim_mail</span>(<span class="dt">tau =</span> <span class="fl">0.1</span>, <span class="dt">pA =</span> <span class="fl">0.8</span>, <span class="dt">pB =</span> <span class="fl">0.7</span>)</span></code></pre></div>
<pre><code>##  mail 
## 0.154</code></pre>
<p>最初と同じ条件で、シミュレーションを1000回繰り繰り返してみる。</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="selection-bias.html#cb57-1"></a>s1_<span class="dv">1000</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_mail</span>())</span></code></pre></div>
<p>この結果を可視化する。本当の因果効果である 0.05 の位置を赤い縦線で示す。</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="selection-bias.html#cb58-1"></a>p_s1 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">tau =</span> s1_<span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-2"><a href="selection-bias.html#cb58-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tau, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb58-3"><a href="selection-bias.html#cb58-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">binwidth =</span> <span class="fl">0.02</span>) <span class="op">+</span></span>
<span id="cb58-4"><a href="selection-bias.html#cb58-4"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>) <span class="op">+</span></span>
<span id="cb58-5"><a href="selection-bias.html#cb58-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;単純比較から得られる「効果」&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb58-6"><a href="selection-bias.html#cb58-6"></a><span class="kw">plot</span>(p_s1)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-44-1.png" width="384" /></p>
<p>本当の効果は0.05なのに、推定された効果の平均値は0.15 、中央値は 0.15 である。</p>
<p>このように、サンプルセレクションのせいでセクションバイアスが生じ、効果が過大推定されることがわかる。
サンプルセレクションの内容によっては、効果が過小評価される場合もある。</p>
<div id="購買行動のモデリング発展的内容" class="section level4" number="2.2.1.1">
<h4><span class="header-section-number">2.2.1.1</span> 購買行動のモデリング：発展的内容*</h4>
<p>この内容はセレクションバイアスとはあまり関係ないので、興味と余力がある人のみ読めば良い。</p>
<p>上の説明では、メールによる販促効果が一定であると考えたが、実際には</p>
<ul>
<li>まったく買う気がない人にはあまり効果がない。</li>
<li>元々買う予定の人にはあまり効果がない。</li>
<li>買うか買わないか迷っている人には効果が大きい。</li>
</ul>
<p>ということが予想される。そのような効果をモデル化してみよう。</p>
<p>個人 <span class="math inline">\(i\)</span> が商品を買うかどうかを表す変数を <span class="math inline">\(Y_i\)</span> とする。<span class="math inline">\(Y_i = 1\)</span> ならば購入、<span class="math inline">\(Y_i = 0\)</span> ならば非購入とする。<span class="math inline">\(Y_i\)</span> は二値変数なので、個人<span class="math inline">\(i\)</span>が商品を買う確率を <span class="math inline">\(\theta_i\)</span> として、ベルヌーイ分布で購買モデルを考えることができる。すなわち、
<span class="math display">\[
Y_i \sim  \mbox{Bernoulli}(\theta_i)
\]</span>
と考える。ここで、購買確率 <span class="math inline">\(\theta_i\)</span> は、メールがない場合に商品を買おうと思っていた度合い <span class="math inline">\(\alpha\)</span> と、メールの効果 <span class="math inline">\(\tau\)</span> によって決まると考える。
<span class="math inline">\(\alpha\)</span> が0に近ければ買うかどうか迷っている状態、絶対値が大きい負の値ならほとんど買う気がない状態、大きい正の値ならば買うつもりの状態を表す。商品を買いやすい集団Aと買いにくい集団Bがいるとすると、<span class="math inline">\(\alpha\)</span> も集団ごとに異なると考えられる。そこで、個人 <span class="math inline">\(i\)</span> が属するグループを <span class="math inline">\(G_i \in \{A, B\}\)</span> とすると、この度合いは、<span class="math inline">\(\alpha_{G_i}\)</span> と表すことができる。</p>
<p><span class="math inline">\(M_i\)</span> をメールを受け取ったことを表すダミー変数、つまり、メールを受け取れば <span class="math inline">\(M_i = 1\)</span>、受け取らなければ <span class="math inline">\(M_i = 0\)</span> になる変数だとすると、個人 <span class="math inline">\(i\)</span> が商品を買おうと思う「度合い（確率ではない）」は、<span class="math inline">\(\alpha_{G_i} + \tau M_i\)</span> と表せる。</p>
<p>この「度合い」は確率ではなく、<span class="math inline">\((-\infty, \infty)\)</span> の値をとる。確率は <span class="math inline">\([0, 1]\)</span> でなければいけないので、<span class="math inline">\((-\infty, \infty)\)</span> を <span class="math inline">\([0, 1]\)</span> に変換する必要がある。
そのような変換を行うことができる関数の1つが、ロジスティック関数（ロジットの逆関数）である（詳しくは、<a href="https://github.com/yukiyanai/quant-methods-R">浅野
・矢内 (2018)</a> の第15章 を参照されたい）。</p>
<p>この関数を使うと、購買確率は
<span class="math display">\[
\theta_i = \mathrm{logit}^{-1}(\alpha_{G_i} + \tau M_i)
\]</span>
となる。ただし、
<span class="math display">\[
\mathrm{logit}^{-1}(x) = \frac{\exp(x)}{1 + \exp(x)} = \frac{1}{1 + \exp(-x)}
\]</span>
である。この関数をRで定義しよう。</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="selection-bias.html#cb59-1"></a>inv_logit &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb59-2"><a href="selection-bias.html#cb59-2"></a>  <span class="kw">return</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>x)))</span>
<span id="cb59-3"><a href="selection-bias.html#cb59-3"></a>}</span></code></pre></div>
<p>これを使うと、<span class="math inline">\(\tau\)</span> を1つの値に決めても、それが購買確率 <span class="math inline">\(\theta\)</span> に与える影響は一定ではなく、<span class="math inline">\(\alpha\)</span> の大きさに依存して影響の大きさが変化することになる。
グラフにすると、その様子がわかる。</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="selection-bias.html#cb60-1"></a>myd &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-5</span>, <span class="dt">to =</span> <span class="dv">5</span>, <span class="dt">length.out =</span> <span class="dv">1000</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb60-2"><a href="selection-bias.html#cb60-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">inv_logit</span>(x))</span>
<span id="cb60-3"><a href="selection-bias.html#cb60-3"></a>p_logistic &lt;-<span class="st"> </span><span class="kw">ggplot</span>(myd, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> p)) <span class="op">+</span></span>
<span id="cb60-4"><a href="selection-bias.html#cb60-4"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;royalblue&quot;</span>) <span class="op">+</span></span>
<span id="cb60-5"><a href="selection-bias.html#cb60-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(alpha[G[i]] <span class="op">+</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>M[i]), <span class="dt">y =</span> <span class="st">&quot;購買確率&quot;</span>)</span>
<span id="cb60-6"><a href="selection-bias.html#cb60-6"></a><span class="kw">plot</span>(p_logistic)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-46-1.png" width="480" /></p>
<p>グラフが直線ではなく曲線になっており、<span class="math inline">\(\alpha_{G_i} + \tau M_i\)</span> の増分が一定でも、横軸上でどこにいるかによって変化の大きさが変わることがわかる。</p>
<p>このような効果を想定してシミュレーションを行うと、結果は変わるだろうか？</p>
</div>
</div>
<div id="通院と健康状態セルフセレクション" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> 通院と健康状態：セルフセレクション</h3>
<p>講義で扱った、病院と健康状態の例 <span class="citation">(Angrist and Pischke <a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> を使い、セルフセレクションによるセレクションバイアスをシミュレーションによって確かめてみよう。</p>
<p>まず、全体の人数 <span class="math inline">\(N\)</span> を決める。</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="selection-bias.html#cb61-1"></a>N &lt;-<span class="st"> </span><span class="fl">1e4</span></span></code></pre></div>
<p>次に、元々の健康状態をランダムに決める（本当は、ここはランダムでなくても良い）。1が最悪の健康状態、5が最善の状態とする。中程度の健康状態の人のが多いことにする。これは、病院に行く前の「隠れた」健康状態であり、観測されない変数であることに注意しよう。</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="selection-bias.html#cb62-1"></a><span class="kw">set.seed</span>(<span class="dv">2020-06-09</span>)</span>
<span id="cb62-2"><a href="selection-bias.html#cb62-2"></a>d2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">h_hidden =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>,</span>
<span id="cb62-3"><a href="selection-bias.html#cb62-3"></a>                               <span class="dt">prob =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)))</span></code></pre></div>
<p>隠れた健康状態の分布を確認してみる。</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="selection-bias.html#cb63-1"></a>hist_h_hidden &lt;-<span class="st"> </span><span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x =</span> h_hidden)) <span class="op">+</span></span>
<span id="cb63-2"><a href="selection-bias.html#cb63-2"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">fill =</span> <span class="st">&quot;tomato&quot;</span>, <span class="dt">width =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb63-3"><a href="selection-bias.html#cb63-3"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;健康状態&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;人数&quot;</span>)</span>
<span id="cb63-4"><a href="selection-bias.html#cb63-4"></a><span class="kw">plot</span>(hist_h_hidden)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-49-1.png" width="288" /></p>
<p>この隠れた健康状態に基づき、各個人が病院に行くかどうか決められることにしよう。つまり、各個人が処置である「病院に行くこと」を、「隠れた健康状態」という結果に密接に関連する変数に基づいて自己選択する（セルフセレクション）という状況をシミュレートする。</p>
<p>他の条件が等しければ (ceteris paribus)、健康状態が悪いほど病院に行きやすいはずだ。ここではまず、健康状態ごとに病院に行く確率の平均値 <span class="math inline">\(\mu\)</span> が異なると考えよう。そして、各個人が病院に行く確率は、平均値 <span class="math inline">\(\mu\)</span> の正規分布からランダムに生成されると考える。話を単純にするため、標準偏差は同じだと仮定する。
（上の「購買行動のモデリング：発展的内容*」の節と同じように、健康状態を説明変数とする線形予測子を、ロジット関数を使って確率に結び付けても良い。）
つまり、健康状態が <span class="math inline">\(s\)</span> の人が病院に行く確率 <span class="math inline">\(p_s\)</span> は、<span class="math inline">\(p_s \sim \mbox{Normal}(\theta_s, \sigma)\)</span> によって決まる。ただし、<span class="math inline">\(0 \leq p_s \leq 1\)</span> になるように調整する。例として、健康状態ごとの <span class="math inline">\(\mu_s\)</span> を <span class="math inline">\((\mu_1, \mu_2, \mu_3, \mu_4, \mu_5) = (0.75, 0.6, 0.4, 0.3, 0.2)\)</span> としてみよう。<span class="math inline">\(\sigma\)</span> は0.1とする。</p>
<p>Rで以下を実行して、各個人の通院確率を決める。</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="selection-bias.html#cb64-1"></a>mu &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>)</span>
<span id="cb64-2"><a href="selection-bias.html#cb64-2"></a>sigma &lt;-<span class="st"> </span><span class="fl">0.1</span></span>
<span id="cb64-3"><a href="selection-bias.html#cb64-3"></a>d2 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb64-4"><a href="selection-bias.html#cb64-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob =</span> <span class="kw">rnorm</span>(<span class="kw">n</span>(), <span class="dt">mean =</span> mu[h_hidden], <span class="dt">sd =</span> sigma),</span>
<span id="cb64-5"><a href="selection-bias.html#cb64-5"></a>         <span class="dt">prob =</span> <span class="kw">case_when</span>(</span>
<span id="cb64-6"><a href="selection-bias.html#cb64-6"></a>           prob <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb64-7"><a href="selection-bias.html#cb64-7"></a>           prob <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb64-8"><a href="selection-bias.html#cb64-8"></a>           <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>prob</span>
<span id="cb64-9"><a href="selection-bias.html#cb64-9"></a>         ))</span></code></pre></div>
<p>健康状態別の通院確率の分布を図示する。</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="selection-bias.html#cb65-1"></a>hist_prob &lt;-<span class="st"> </span><span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x =</span> prob)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-2"><a href="selection-bias.html#cb65-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-3"><a href="selection-bias.html#cb65-3"></a><span class="st">  </span><span class="kw">facet_grid</span>(<span class="dt">rows =</span> <span class="kw">vars</span>(h_hidden)) <span class="op">+</span></span>
<span id="cb65-4"><a href="selection-bias.html#cb65-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;病院に行く確率&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;人数&quot;</span>)</span>
<span id="cb65-5"><a href="selection-bias.html#cb65-5"></a><span class="kw">plot</span>(hist_prob)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-51-1.png" width="384" /></p>
<p>健康状態が良い（5の）場合は、ランダムに生成した「確率」が0より小さくなってしまったものを後から0に調整しているので、0の度数が正規分布より大きくなっている。したがって、このモデルは通院を説明するものとしてはあまり望ましくない。しかし、ここでの目的はセルフセレクションによるセレクションバイアスを理解することなので、これで良しとしよう。（気になるなら、もっといいモデルを自分で考えよう！）</p>
<p>この確率に基づいて、ベルヌーイ試行で病院に行くかどうかを表す変数 <span class="math inline">\(D_i \in \{0,1\}\)</span> の値を決める。これが観察される処置の値である。</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="selection-bias.html#cb66-1"></a>d2 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb66-2"><a href="selection-bias.html#cb66-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">D =</span> <span class="kw">rbinom</span>(<span class="kw">n</span>(), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob))</span></code></pre></div>
<p>病院に行く人の割合は、</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="selection-bias.html#cb67-1"></a><span class="kw">mean</span>(d2<span class="op">$</span>D)</span></code></pre></div>
<pre><code>## [1] 0.4426</code></pre>
<p>である。（現実よりかなり大きな値になっているが、とりあえずこれで進める。気になるなら、シミュレーションの条件を変えていろいろ試してみよう！）</p>
<p>ここで、通院が健康状態に与える平均処置効果 (ATE) <code>beta</code> を設定する。単純化のため、ATE = ITE とする。つまり、処置効果はどの個人にとっても同じだと仮定する。試しに、<code>beta = 0.6</code> にしてみよう。これは、隠れた健康状態が3の人が病院に行くと健康状態が3.6 になるということである。実際には、健康状態は1から5の整数で観測される。隠れた健康状態が5の人が病院に行っても健康状態は5のままのはずであるが、ここでは5.6になることを許そう。どちらも、シミュレーションを単純化するための妥協である。（調査される整数値の健康状態の背景に連続的な健康状態があり、回答するときに最も近い値を選ぶと考えれば、それほど変な設定ではない。）</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="selection-bias.html#cb69-1"></a>beta &lt;-<span class="st"> </span><span class="fl">0.6</span></span></code></pre></div>
<p>この効果を、通院した人にのみ与え、健康状態 <span class="math inline">\(Y\)</span> を観測する。</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="selection-bias.html#cb70-1"></a>d2 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-2"><a href="selection-bias.html#cb70-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Y =</span> h_hidden <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D)</span></code></pre></div>
<p>これで、データが揃った。シミュレーションでなければ、観測されるのは <span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span>のみである。</p>
<p>病院に行った人と行かなかった人の健康状態を単純に比較してみよう。</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="selection-bias.html#cb71-1"></a>d2_D &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb71-2"><a href="selection-bias.html#cb71-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">D =</span> <span class="kw">factor</span>(D, <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;病院に行かなかった&quot;</span>, <span class="st">&quot;病院に行った&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb71-3"><a href="selection-bias.html#cb71-3"></a><span class="st">  </span><span class="kw">group_by</span>(D) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb71-4"><a href="selection-bias.html#cb71-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">health =</span> <span class="kw">mean</span>(Y)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb71-5"><a href="selection-bias.html#cb71-5"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   D                  health
##   &lt;fct&gt;               &lt;dbl&gt;
## 1 病院に行かなかった   3.34
## 2 病院に行った         3.18</code></pre>
<p>健康状態は、病院に行った人のほうが、病院に行かなかった人よりも悪いことがわかる。
このように、本当の ATE は 0.6 なのに、観察された値を単純比較すると、-0.16 だと誤解してしまう。</p>
<p>これはシミュレーションなので、本来は計算できないはずのセレクションバイアスも計算することができる。
セレクションバイアスは、
<span class="math display">\[
\mathbb{E}[Y(0) \mid D = 1 ] - \mathbb{E}[Y(0) \mid D = 0]
\]</span>
である。これを計算してみよう。
まず、<span class="math inline">\(\mathbb{E}[Y(0) \mid D = 1]\)</span>は、</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="selection-bias.html#cb73-1"></a>e1 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb73-2"><a href="selection-bias.html#cb73-2"></a><span class="st">  </span><span class="kw">filter</span>(D <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb73-3"><a href="selection-bias.html#cb73-3"></a><span class="st">  </span><span class="kw">pull</span>(h_hidden) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb73-4"><a href="selection-bias.html#cb73-4"></a><span class="st">  </span><span class="kw">mean</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb73-5"><a href="selection-bias.html#cb73-5"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## [1] 2.580434</code></pre>
<p>である。<span class="math inline">\(\mathbb{E}[Y(0) \mid D = 0]\)</span> は、</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="selection-bias.html#cb75-1"></a>e0 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb75-2"><a href="selection-bias.html#cb75-2"></a><span class="st">  </span><span class="kw">filter</span>(D <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb75-3"><a href="selection-bias.html#cb75-3"></a><span class="st">  </span><span class="kw">pull</span>(h_hidden) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb75-4"><a href="selection-bias.html#cb75-4"></a><span class="st">  </span><span class="kw">mean</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb75-5"><a href="selection-bias.html#cb75-5"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## [1] 3.336204</code></pre>
<p>である。よって、この場合のセレクションバイアスは、</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="selection-bias.html#cb77-1"></a>(sb &lt;-<span class="st"> </span>e1 <span class="op">-</span><span class="st"> </span>e0)</span></code></pre></div>
<pre><code>## [1] -0.75577</code></pre>
<p>である。セルフセレクションの影響で、負のセレクションバイアスが生じていることがわかる。ATEとセレクションバイアスを足した値</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="selection-bias.html#cb79-1"></a>beta <span class="op">+</span><span class="st"> </span>sb</span></code></pre></div>
<pre><code>## [1] -0.15577</code></pre>
<p>は、単純比較による効果の推定値</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="selection-bias.html#cb81-1"></a><span class="kw">diff</span>(d2_D<span class="op">$</span>health)</span></code></pre></div>
<pre><code>## [1] -0.15577</code></pre>
<p>に一致する。</p>
<p>単純比較による効果の推定を回帰分析で行ってみよう。</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="selection-bias.html#cb83-1"></a>fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> d2)</span>
<span id="cb83-2"><a href="selection-bias.html#cb83-2"></a><span class="kw">summary</span>(fit2)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = Y ~ D, data = d2)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.3362 -0.5804 -0.3362  0.6638  2.4196 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  3.33620    0.01465 227.735  &lt; 2e-16
## D           -0.15577    0.02202  -7.074 1.61e-12
## 
## Residual standard error: 1.094 on 9998 degrees of freedom
## Multiple R-squared:  0.00498,    Adjusted R-squared:  0.004881 
## F-statistic: 50.04 on 1 and 9998 DF,  p-value: 1.606e-12</code></pre>
<p>（当たり前だが）上と同じ推定値が得られた。また、その効果は有意水準0.001 で統計的に有意である。繰り返すが、<strong>「統計的に有意」な結果を見つけても、それ自体は因果推論の役に立たない</strong>ことが、ここからわかるだろう。</p>
<p>以上のシミュレーションを、繰り返し実行できるように関数にまとめよう。返り値は、単純比較によって得られる「バイ
アスを含んだ因果効果」とする。</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="selection-bias.html#cb85-1"></a>sim_hospital &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">beta =</span> <span class="fl">0.6</span>, <span class="dt">N =</span> <span class="fl">1e4</span>, </span>
<span id="cb85-2"><a href="selection-bias.html#cb85-2"></a>                         <span class="dt">mu =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>), </span>
<span id="cb85-3"><a href="selection-bias.html#cb85-3"></a>                         <span class="dt">sigma =</span> <span class="kw">rep</span>(<span class="fl">0.1</span>, <span class="dv">5</span>)) {</span>
<span id="cb85-4"><a href="selection-bias.html#cb85-4"></a>  </span>
<span id="cb85-5"><a href="selection-bias.html#cb85-5"></a>  <span class="co"># sigma は、健康状態ごとに変えても良いことにする</span></span>
<span id="cb85-6"><a href="selection-bias.html#cb85-6"></a>  <span class="cf">if</span> (<span class="kw">length</span>(sigma <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)) sigma &lt;-<span class="st"> </span><span class="kw">rep</span>(sigma, <span class="dv">5</span>)</span>
<span id="cb85-7"><a href="selection-bias.html#cb85-7"></a>  </span>
<span id="cb85-8"><a href="selection-bias.html#cb85-8"></a>  h_hidden &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>,</span>
<span id="cb85-9"><a href="selection-bias.html#cb85-9"></a>                    <span class="dt">prob =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb85-10"><a href="selection-bias.html#cb85-10"></a>  prob &lt;-<span class="st">  </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> mu[h_hidden], <span class="dt">sd =</span> sigma[h_hidden])</span>
<span id="cb85-11"><a href="selection-bias.html#cb85-11"></a>  prob &lt;-<span class="st"> </span><span class="kw">case_when</span>(</span>
<span id="cb85-12"><a href="selection-bias.html#cb85-12"></a>    prob <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb85-13"><a href="selection-bias.html#cb85-13"></a>    prob <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb85-14"><a href="selection-bias.html#cb85-14"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>prob</span>
<span id="cb85-15"><a href="selection-bias.html#cb85-15"></a>  )</span>
<span id="cb85-16"><a href="selection-bias.html#cb85-16"></a>  D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob)</span>
<span id="cb85-17"><a href="selection-bias.html#cb85-17"></a>  Y &lt;-<span class="st"> </span>h_hidden <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D</span>
<span id="cb85-18"><a href="selection-bias.html#cb85-18"></a>  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D)</span>
<span id="cb85-19"><a href="selection-bias.html#cb85-19"></a>  <span class="kw">return</span>(<span class="kw">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb85-20"><a href="selection-bias.html#cb85-20"></a>}</span></code></pre></div>
<p><code>beta = 0.6</code> でこの関数を1度だけ実行してみる。</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="selection-bias.html#cb86-1"></a><span class="kw">sim_hospital</span>(<span class="dt">beta =</span> <span class="fl">0.6</span>)</span></code></pre></div>
<pre><code>##          D 
## -0.1743207</code></pre>
<p>シミュレーションを1000回繰り返してみよう。</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="selection-bias.html#cb88-1"></a>s2_<span class="dv">1000</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_hospital</span>())</span></code></pre></div>
<p>この結果を図示する。</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="selection-bias.html#cb89-1"></a>p_s2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">beta =</span> s2_<span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb89-2"><a href="selection-bias.html#cb89-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> beta, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb89-3"><a href="selection-bias.html#cb89-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">binwidth =</span> <span class="fl">0.01</span>) <span class="op">+</span></span>
<span id="cb89-4"><a href="selection-bias.html#cb89-4"></a><span class="st">  </span><span class="co">#geom_vline(xintercept = 0.6, color = &quot;tomato&quot;) +</span></span>
<span id="cb89-5"><a href="selection-bias.html#cb89-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span> <span class="st">&quot;単純比較から得られる「効果」&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb89-6"><a href="selection-bias.html#cb89-6"></a><span class="kw">plot</span>(p_s2)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-66-1.png" width="384" /></p>
<p>本当の因果効果は0.6である。しかし、1,000回のシミュレーションで推定された因果効果の平均値は-0.17、中央値は-0.17であり、効果を大幅に過小推定している。
セルフセレクションによって、セレクションバイアスが生じているためである。</p>
<p>このように、セレクションバイアスは因果推論の敵である。今回の例では負のバイアスが生じ、本来は正であるはずの効果を負だと誤解する危険があることがわかった。しかし、セレクションの内容によっては、負の効果を正と誤解したり、弱い正の効果を強い正の効果だと誤解したりするようなことも考えられる。</p>
<p>セレクションバイアスが生じるような状況では、単純比較（単回帰）によって因果効果を推定することはできない。</p>
</div>
</div>
<div id="トピック2の課題" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> トピック2の課題</h2>
<p>上で行ったシミュレーションを、条件を変えて色々試しなさい。また、面白い結果や納得できない結果が出たら、Slack でシェアし、受講生同士で議論しなさい。</p>
<p>今回の課題は<strong>提出不要</strong>だが、必ず自分で実行すること。</p>

</div>
</div>
<h3>参考文献</h3>
<div id="refs" class="references">
<div id="ref-ang2009">
<p>Angrist, Joshua D., and Jörn-Steffen Pischke. 2009. <em>Mostly Harmless Econometrics: An Empiricist’s Companion</em>. Princeton: Princeton University Press.</p>
</div>
<div id="ref-yasui2020">
<p>安井翔太. 2020. <em>効果検証入門：正しい比較のための因果推論/計量経済学の基礎</em>. 技術評論社.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="RCT.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
