<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Topic 4 回帰分析 | KUT 計量経済学応用</title>
  <meta name="description" content="Topic 4 回帰分析 | KUT 計量経済学応用" />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Topic 4 回帰分析 | KUT 計量経済学応用" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Topic 4 回帰分析 | KUT 計量経済学応用" />
  
  
  

<meta name="author" content="矢内 勇生" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="RCT.html"/>
<link rel="next" href="propensity-score.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">KUT 計量経済学応用</a></li>
<li><a href="https://yukiyanai.github.io/" target="_blank">矢内 勇生 (Yuki Yanai)</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>はじめに</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#この資料について"><i class="fa fa-check"></i><b>0.1</b> この資料について</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#履修条件"><i class="fa fa-check"></i><b>0.2</b> 履修条件</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#r-とrstudio-のインストール"><i class="fa fa-check"></i><b>0.3</b> R とRStudio のインストール</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#授業計画"><i class="fa fa-check"></i><b>0.4</b> 授業計画</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> イントロダクション</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#予習と講義動画の視聴"><i class="fa fa-check"></i><b>1.1</b> 予習と講義動画の視聴</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#slack"><i class="fa fa-check"></i><b>1.2</b> Slack</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="introduction.html"><a href="introduction.html#slack-とは"><i class="fa fa-check"></i><b>1.2.1</b> Slack とは？</a></li>
<li class="chapter" data-level="1.2.2" data-path="introduction.html"><a href="introduction.html#授業用ワークスペースへの登録"><i class="fa fa-check"></i><b>1.2.2</b> 授業用ワークスペースへの登録</a></li>
<li class="chapter" data-level="1.2.3" data-path="introduction.html"><a href="introduction.html#利用上の注意"><i class="fa fa-check"></i><b>1.2.3</b> 利用上の注意</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#rstudio-cloud-の初期設定"><i class="fa fa-check"></i><b>1.3</b> RStudio Cloud の初期設定</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#ユーザ登録"><i class="fa fa-check"></i><b>1.3.1</b> ユーザ登録</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#授業用のプロジェクトを作る"><i class="fa fa-check"></i><b>1.3.2</b> 授業用のプロジェクトを作る</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#rstudio-のカスタマイズ"><i class="fa fa-check"></i><b>1.3.3</b> RStudio のカスタマイズ</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#パッケージのインストール"><i class="fa fa-check"></i><b>1.3.4</b> パッケージのインストール</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#ディレクトリの作成"><i class="fa fa-check"></i><b>1.3.5</b> ディレクトリの作成</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#図で日本語が使えるようにする"><i class="fa fa-check"></i><b>1.3.6</b> 図で日本語が使えるようにする</a></li>
<li class="chapter" data-level="1.3.7" data-path="introduction.html"><a href="introduction.html#r-markdown-からpdfファイルを作る"><i class="fa fa-check"></i><b>1.3.7</b> R Markdown からPDFファイルを作る</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#トピック1の課題"><i class="fa fa-check"></i><b>1.4</b> トピック1の課題</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="selection-bias.html"><a href="selection-bias.html"><i class="fa fa-check"></i><b>2</b> セレクションバイアス</a>
<ul>
<li class="chapter" data-level="2.1" data-path="selection-bias.html"><a href="selection-bias.html#準備"><i class="fa fa-check"></i><b>2.1</b> 準備</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="selection-bias.html"><a href="selection-bias.html#予習講義動画実習課題"><i class="fa fa-check"></i><b>2.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="2.1.2" data-path="selection-bias.html"><a href="selection-bias.html#rパッケージの読み込み"><i class="fa fa-check"></i><b>2.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="2.1.3" data-path="selection-bias.html"><a href="selection-bias.html#このトピックで使うrコードの説明"><i class="fa fa-check"></i><b>2.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="selection-bias.html"><a href="selection-bias.html#セレクションバイアスのシミュレーション"><i class="fa fa-check"></i><b>2.2</b> セレクションバイアスのシミュレーション</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="selection-bias.html"><a href="selection-bias.html#メールによる販促の効果"><i class="fa fa-check"></i><b>2.2.1</b> メールによる販促の効果</a></li>
<li class="chapter" data-level="2.2.2" data-path="selection-bias.html"><a href="selection-bias.html#通院と健康状態セルフセレクション"><i class="fa fa-check"></i><b>2.2.2</b> 通院と健康状態：セルフセレクション</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="selection-bias.html"><a href="selection-bias.html#トピック2の課題"><i class="fa fa-check"></i><b>2.3</b> トピック2の課題</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="RCT.html"><a href="RCT.html"><i class="fa fa-check"></i><b>3</b> RCT（ランダム化比較試験）</a>
<ul>
<li class="chapter" data-level="3.1" data-path="RCT.html"><a href="RCT.html#準備-1"><i class="fa fa-check"></i><b>3.1</b> 準備</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="RCT.html"><a href="RCT.html#予習講義動画実習課題-1"><i class="fa fa-check"></i><b>3.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="3.1.2" data-path="RCT.html"><a href="RCT.html#rパッケージの読み込み-1"><i class="fa fa-check"></i><b>3.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="3.1.3" data-path="RCT.html"><a href="RCT.html#このトピックで使うrコードの説明-1"><i class="fa fa-check"></i><b>3.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="RCT.html"><a href="RCT.html#ランダム化のシミュレーション"><i class="fa fa-check"></i><b>3.2</b> ランダム化のシミュレーション</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="RCT.html"><a href="RCT.html#母集団の設定"><i class="fa fa-check"></i><b>3.2.1</b> 母集団の設定</a></li>
<li class="chapter" data-level="3.2.2" data-path="RCT.html"><a href="RCT.html#ベルヌーイ実験"><i class="fa fa-check"></i><b>3.2.2</b> ベルヌーイ実験</a></li>
<li class="chapter" data-level="3.2.3" data-path="RCT.html"><a href="RCT.html#完全ランダム化実験"><i class="fa fa-check"></i><b>3.2.3</b> 完全ランダム化実験</a></li>
<li class="chapter" data-level="3.2.4" data-path="RCT.html"><a href="RCT.html#ブロック別ランダム化実験"><i class="fa fa-check"></i><b>3.2.4</b> ブロック別ランダム化実験</a></li>
<li class="chapter" data-level="3.2.5" data-path="RCT.html"><a href="RCT.html#ペア毎のランダム化実験"><i class="fa fa-check"></i><b>3.2.5</b> ペア毎のランダム化実験</a></li>
<li class="chapter" data-level="3.2.6" data-path="RCT.html"><a href="RCT.html#つのrct-を比較する"><i class="fa fa-check"></i><b>3.2.6</b> 4つのRCT を比較する</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="RCT.html"><a href="RCT.html#トピック3の課題"><i class="fa fa-check"></i><b>3.3</b> トピック3の課題</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regression.html"><a href="regression.html"><i class="fa fa-check"></i><b>4</b> 回帰分析</a>
<ul>
<li class="chapter" data-level="4.1" data-path="regression.html"><a href="regression.html#準備-2"><i class="fa fa-check"></i><b>4.1</b> 準備</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="regression.html"><a href="regression.html#予習講義動画実習課題-2"><i class="fa fa-check"></i><b>4.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="4.1.2" data-path="regression.html"><a href="regression.html#rパッケージの読み込み-2"><i class="fa fa-check"></i><b>4.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="4.1.3" data-path="regression.html"><a href="regression.html#関数の自作"><i class="fa fa-check"></i><b>4.1.3</b> 関数の自作</a></li>
<li class="chapter" data-level="4.1.4" data-path="regression.html"><a href="regression.html#このトピックで使うrコードの説明-2"><i class="fa fa-check"></i><b>4.1.4</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="regression.html"><a href="regression.html#回帰分析のシミュレーション"><i class="fa fa-check"></i><b>4.2</b> 回帰分析のシミュレーション</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="regression.html"><a href="regression.html#単回帰"><i class="fa fa-check"></i><b>4.2.1</b> 単回帰</a></li>
<li class="chapter" data-level="4.2.2" data-path="regression.html"><a href="regression.html#重回帰"><i class="fa fa-check"></i><b>4.2.2</b> 重回帰</a></li>
<li class="chapter" data-level="4.2.3" data-path="regression.html"><a href="regression.html#重回帰によるブロッキング"><i class="fa fa-check"></i><b>4.2.3</b> 重回帰によるブロッキング</a></li>
<li class="chapter" data-level="4.2.4" data-path="regression.html"><a href="regression.html#重回帰分析によるセレクションバイアスの除去"><i class="fa fa-check"></i><b>4.2.4</b> 重回帰分析によるセレクションバイアスの除去</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="regression.html"><a href="regression.html#脱落変数バイアスと処置後変数バイアス"><i class="fa fa-check"></i><b>4.3</b> 脱落変数バイアスと処置後変数バイアス</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="regression.html"><a href="regression.html#脱落変数バイアス-ovb"><i class="fa fa-check"></i><b>4.3.1</b> 脱落変数バイアス (OVB)</a></li>
<li class="chapter" data-level="4.3.2" data-path="regression.html"><a href="regression.html#処置後変数バイアス"><i class="fa fa-check"></i><b>4.3.2</b> 処置後変数バイアス</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="regression.html"><a href="regression.html#dag有向非巡回グラフ"><i class="fa fa-check"></i><b>4.4</b> DAG（有向非巡回グラフ）</a></li>
<li class="chapter" data-level="4.5" data-path="regression.html"><a href="regression.html#トピック4の課題"><i class="fa fa-check"></i><b>4.5</b> トピック4の課題</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="propensity-score.html"><a href="propensity-score.html"><i class="fa fa-check"></i><b>5</b> 傾向スコア</a>
<ul>
<li class="chapter" data-level="5.1" data-path="propensity-score.html"><a href="propensity-score.html#準備-3"><i class="fa fa-check"></i><b>5.1</b> 準備</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="propensity-score.html"><a href="propensity-score.html#予習講義動画実習課題-3"><i class="fa fa-check"></i><b>5.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="5.1.2" data-path="propensity-score.html"><a href="propensity-score.html#rパッケージの読み込み-3"><i class="fa fa-check"></i><b>5.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="5.1.3" data-path="propensity-score.html"><a href="propensity-score.html#関数の自作-1"><i class="fa fa-check"></i><b>5.1.3</b> 関数の自作</a></li>
<li class="chapter" data-level="5.1.4" data-path="propensity-score.html"><a href="propensity-score.html#このトピックで使うrコードの説明-3"><i class="fa fa-check"></i><b>5.1.4</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="propensity-score.html"><a href="propensity-score.html#傾向スコアを用いた因果推論の手順"><i class="fa fa-check"></i><b>5.2</b> 傾向スコアを用いた因果推論の手順</a></li>
<li class="chapter" data-level="5.3" data-path="propensity-score.html"><a href="propensity-score.html#共変量の選定"><i class="fa fa-check"></i><b>5.3</b> 共変量の選定</a></li>
<li class="chapter" data-level="5.4" data-path="propensity-score.html"><a href="propensity-score.html#傾向スコアの推定"><i class="fa fa-check"></i><b>5.4</b> 傾向スコアの推定</a></li>
<li class="chapter" data-level="5.5" data-path="propensity-score.html"><a href="propensity-score.html#バランス調整バランスチェック因果効果の推定"><i class="fa fa-check"></i><b>5.5</b> バランス調整、バランスチェック、因果効果の推定</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="propensity-score.html"><a href="propensity-score.html#重み付け"><i class="fa fa-check"></i><b>5.5.1</b> 重み付け</a></li>
<li class="chapter" data-level="5.5.2" data-path="propensity-score.html"><a href="propensity-score.html#層別"><i class="fa fa-check"></i><b>5.5.2</b> 層別</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="propensity-score.html"><a href="propensity-score.html#トピック5-の課題"><i class="fa fa-check"></i><b>5.6</b> トピック5 の課題</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="panel-data.html"><a href="panel-data.html"><i class="fa fa-check"></i><b>6</b> パネルデータ分析</a></li>
<li class="chapter" data-level="7" data-path="midterm-presentation.html"><a href="midterm-presentation.html"><i class="fa fa-check"></i><b>7</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#このトピックでやるべきこと"><i class="fa fa-check"></i><b>7.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="7.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#分析計画のプレゼンテーション-1"><i class="fa fa-check"></i><b>7.2</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの内容"><i class="fa fa-check"></i><b>7.2.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="7.2.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの方法"><i class="fa fa-check"></i><b>7.2.2</b> プレゼンテーションの方法</a></li>
<li class="chapter" data-level="7.2.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーション動画の作成法"><i class="fa fa-check"></i><b>7.2.3</b> プレゼンテーション動画の作成法</a></li>
<li class="chapter" data-level="7.2.4" data-path="midterm-presentation.html"><a href="midterm-presentation.html#提出方法と提出期限"><i class="fa fa-check"></i><b>7.2.4</b> 提出方法と提出期限</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#他の受講生へのコメントについて"><i class="fa fa-check"></i><b>7.3</b> 他の受講生へのコメントについて</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html"><i class="fa fa-check"></i><b>8</b> 回帰不連続デザイン</a></li>
<li class="chapter" data-level="9" data-path="instrumental-variable.html"><a href="instrumental-variable.html"><i class="fa fa-check"></i><b>9</b> 操作変数法</a></li>
<li class="chapter" data-level="10" data-path="final-presentation.html"><a href="final-presentation.html"><i class="fa fa-check"></i><b>10</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.1" data-path="final-presentation.html"><a href="final-presentation.html#このトピックでやるべきこと-1"><i class="fa fa-check"></i><b>10.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="10.2" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のレポート期末レポート"><i class="fa fa-check"></i><b>10.2</b> 分析結果のレポート（期末レポート）</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="final-presentation.html"><a href="final-presentation.html#レポートの内容"><i class="fa fa-check"></i><b>10.2.1</b> レポートの内容</a></li>
<li class="chapter" data-level="10.2.2" data-path="final-presentation.html"><a href="final-presentation.html#レポートの形式と提出方法"><i class="fa fa-check"></i><b>10.2.2</b> レポートの形式と提出方法</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のプレゼンテーション-1"><i class="fa fa-check"></i><b>10.3</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="final-presentation.html"><a href="final-presentation.html#プレゼンテーションの内容-1"><i class="fa fa-check"></i><b>10.3.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="10.3.2" data-path="final-presentation.html"><a href="final-presentation.html#提出方法と提出期限-1"><i class="fa fa-check"></i><b>10.3.2</b> 提出方法と提出期限</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>参考文献</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="_blank">Published with bookdown</a></li>
<li >&nbsp;&nbsp;&nbsp;&copy 2020 Yuki Yanai</li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">KUT 計量経済学応用</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="回帰分析" class="section level1" number="4">
<h1><span class="header-section-number">Topic 4</span> 回帰分析</h1>
<ul>
<li><a href="https://yukiyanai.github.io/jp/classes/econometrics2/contents/slides/metrics2_topic04_slides.pdf">トピック4の講義スライド</a> (PDF, 1.4MB)</li>
</ul>
<div id="準備-2" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> 準備</h2>
<div id="予習講義動画実習課題-2" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> 予習、講義動画、実習課題</h3>
<p>このトピックでやるべきことは、以下のとおりである。</p>
<ol style="list-style-type: decimal">
<li><a href="http://yukiyanai.github.io/jp/classes/econometrics2/docs/syllabus-applied-econometrics_2020-2Q.pdf">シラバス(PDFファイル)</a> に記載されているトピック4の予習課題を読む。</li>
<li><a href="https://lms.kochi-tech.ac.jp/course/view.php?id=793">KUTLMS (Moodle)</a> にあるトピック4の講義動画を視聴する。</li>
<li>この資料の続きを読み、Rを使った実習を行うことで、回帰分析の理解を深める。特に、因果推論で回帰分析を使う意味を理解する。</li>
</ol>
<ul>
<li>まず、書いてあるコードをそのまま実行する。</li>
<li>自分で数字（シミュレーションの条件）を変えて、結果がどう変わるか研究する（<strong>課題</strong>）。</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>教科書 <span class="citation">(安井 <a href="#ref-yasui2020" role="doc-biblioref">2020</a>)</span> 第2章のRを使った分析を自分でやってみる。</li>
<li>課題を提出する。</li>
</ol>
<p>このトピックの説明は、以下の事項を理解しているという前提で書かれている。</p>
<ul>
<li>回帰直線とは何か</li>
<li>回帰係数とは何か</li>
<li>Rで回帰分析を実行する方法
<ul>
<li><code>lm()</code> の使い方</li>
<li><code>broom::tidy()</code> の使い方</li>
<li>推定結果の読み方</li>
</ul></li>
</ul>
<p>これらの理解に不安がある場合は、<span class="citation">浅野 and 矢内 (<a href="#ref-asano-yanai2018" role="doc-biblioref">2018</a>)</span> の第10–14章や<a href="http://yukiyanai.github.io/jp/classes/econometrics1/contents/">計量経済学の講義資料</a> などを参照されたい。より厳密な説明は、計量経済学の教科書（たとえば、<span class="citation">Angrist and Pischke (<a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> の第3章、 <span class="citation">Hansen (<a href="#ref-hansen2020" role="doc-biblioref">2020</a>)</span> の第2章から第5章、 <span class="citation">縄田 (<a href="#ref-nawata2013" role="doc-biblioref">2013</a>)</span> の第6章、<span class="citation">西山 et al. (<a href="#ref-nishiyama2019" role="doc-biblioref">2019</a>)</span> の第6章、<span class="citation">末石 (<a href="#ref-sueishi2015" role="doc-biblioref">2015</a>)</span> の第1章など）を参照。</p>
<p><strong>注意：</strong> 下の説明では、<code>replicate()</code> でシミュレーションを繰り返す回数を1,000 に設定しているが、自分の環境合わせて調整するように。あまり処理能力が高くないパソコンを使っている場合は、繰り返し回数を少なめ（例えば、500）にしたほうがよい。シミュレーションの結果を安定させたいなら、繰り返し回数をさらに大きくしたほうが良い。また、<code>set.seed()</code> で指定する値は適宜変えるように。</p>
</div>
<div id="rパッケージの読み込み-2" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Rパッケージの読み込み</h3>
<p>必要なパッケージを読み込み、作図用の日本語フォントを設定する。</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="regression.html#cb178-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(tidyverse, ggbeeswarm, broom, patchwork,</span>
<span id="cb178-2"><a href="regression.html#cb178-2"></a>               dagitty, ggdag)</span>
<span id="cb178-3"><a href="regression.html#cb178-3"></a><span class="kw">theme_set</span>(<span class="kw">theme_gray</span>(<span class="dt">base_size =</span> <span class="dv">10</span>, <span class="dt">base_family =</span> <span class="st">&quot;HiraginoSans-W3&quot;</span>))  <span class="co"># macOS用</span></span>
<span id="cb178-4"><a href="regression.html#cb178-4"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;Meiryo&quot;))        # Windows用</span></span>
<span id="cb178-5"><a href="regression.html#cb178-5"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;ipaex&quot;))         # Ubuntu用</span></span>
<span id="cb178-6"><a href="regression.html#cb178-6"></a><span class="co">#showtext::showtext_auto()                                            # Cloud用</span></span>
<span id="cb178-7"><a href="regression.html#cb178-7"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;noto&quot;))          # Cloud用</span></span></code></pre></div>
</div>
<div id="関数の自作" class="section level3" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> 関数の自作</h3>
<p>ロジットの逆関数（ロジスティック関数）を用意する。</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="regression.html#cb179-1"></a>inv_logit &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb179-2"><a href="regression.html#cb179-2"></a>  <span class="kw">return</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>x)))</span>
<span id="cb179-3"><a href="regression.html#cb179-3"></a>}</span></code></pre></div>
</div>
<div id="このトピックで使うrコードの説明-2" class="section level3" number="4.1.4">
<h3><span class="header-section-number">4.1.4</span> このトピックで使うRコードの説明</h3>
<div id="weighted.mean" class="section level4" number="4.1.4.1">
<h4><span class="header-section-number">4.1.4.1</span> <code>weighted.mean()</code></h4>
<p><code>weighted.mean()</code>は加重平均を計算する。</p>
<p>10と20の単純な算術平均は</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="regression.html#cb180-1"></a>a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">A =</span> <span class="dv">10</span>, <span class="dt">B =</span> <span class="dv">20</span>)</span>
<span id="cb180-2"><a href="regression.html#cb180-2"></a><span class="kw">mean</span>(a)</span></code></pre></div>
<pre><code>## [1] 15</code></pre>
<p>である。A と B の重みを 5:2 にする。</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="regression.html#cb182-1"></a>weight &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>)</span></code></pre></div>
<p>この重みを使って加重平均を計算する。</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="regression.html#cb183-1"></a><span class="kw">weighted.mean</span>(a, <span class="dt">w =</span> weight)</span></code></pre></div>
<pre><code>## [1] 12.85714</code></pre>
<p>これは、</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="regression.html#cb185-1"></a><span class="kw">sum</span>(a <span class="op">*</span><span class="st"> </span>weight) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(weight)</span></code></pre></div>
<pre><code>## [1] 12.85714</code></pre>
<p>である。つまり、</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="regression.html#cb187-1"></a>(<span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="dv">5</span> <span class="op">+</span><span class="st"> </span><span class="dv">20</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(<span class="dv">5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] 12.85714</code></pre>
<p>である。</p>
</div>
<div id="purrrmapと-sapply" class="section level4" number="4.1.4.2">
<h4><span class="header-section-number">4.1.4.2</span> <code>purrr::map()</code>と <code>sapply()</code></h4>
<p><code>purrr::map()</code> は、関数をリストまたはベクトルの各要素に適用し、リストを返す。
<code>sapply()</code> も同様の働きをするが、返り値を単純なもの（次元が低いもの）にできる場合には単純化して値を返してくれる。例えば、各要素の長さが1で全体の長さが L のリストを返す代わりに、長さ L のベクトルを返す。
（実は、 <code>sapply()</code> は <code>lapply()</code> を <code>simplify = TRUE</code> として使っているだけである。）</p>
<p>例として、ある数を s 倍にする関数を作る。s の既定値は10にする。</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="regression.html#cb189-1"></a>multiply_s &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">s =</span> <span class="dv">10</span>) {</span>
<span id="cb189-2"><a href="regression.html#cb189-2"></a>  <span class="kw">return</span>(x <span class="op">*</span><span class="st"> </span>s)</span>
<span id="cb189-3"><a href="regression.html#cb189-3"></a>}</span></code></pre></div>
<p>この関数は、次のように使う。</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="regression.html#cb190-1"></a><span class="kw">multiply_s</span>(<span class="dv">5</span>)        <span class="co"># 5 の10倍</span></span></code></pre></div>
<pre><code>## [1] 50</code></pre>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="regression.html#cb192-1"></a><span class="kw">multiply_s</span>(<span class="dv">5</span>, <span class="dt">s =</span> <span class="dv">8</span>) <span class="co"># 5の8倍  </span></span></code></pre></div>
<pre><code>## [1] 40</code></pre>
<p>この関数を、あるベクトルの各要素に対して使いたいとする。まず、対象となるベクトルを作る。</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="regression.html#cb194-1"></a>(vec1 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<p>このベクトルの各要素に関数を適用する。まずは、<code>for</code> ループでやってみる。</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="regression.html#cb196-1"></a>res_for &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">length</span>(vec1))  <span class="co"># 結果を保存するベクトル</span></span>
<span id="cb196-2"><a href="regression.html#cb196-2"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(vec1)) {</span>
<span id="cb196-3"><a href="regression.html#cb196-3"></a>  res_for[i] &lt;-<span class="st"> </span><span class="kw">multiply_s</span>(vec1[i])</span>
<span id="cb196-4"><a href="regression.html#cb196-4"></a>}</span>
<span id="cb196-5"><a href="regression.html#cb196-5"></a>res_for</span></code></pre></div>
<pre><code>##  [1]  10  20  30  40  50  60  70  80  90 100</code></pre>
<p>これを <code>purrr::map()</code> で実行すると、次のように書ける。<code>%&gt;% print()</code> は結果を表示するために使っているだけなので、表示しなくていいなら不要（以下も同じ）。</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="regression.html#cb198-1"></a>res_map &lt;-<span class="st"> </span>vec1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb198-2"><a href="regression.html#cb198-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="dt">.f =</span> multiply_s) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb198-3"><a href="regression.html#cb198-3"></a><span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb198-4"><a href="regression.html#cb198-4"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>##  [1]  10  20  30  40  50  60  70  80  90 100</code></pre>
<p>このように、<code>map()</code> は、<code>map(.x = 対象となるベクトルまたはリスト, .f = 適用する関数, .x 以外の引数)</code> という形式で使う。<code>map()</code> はリストを返すので、ここではリストをベクトルにするために <code>unlist()</code> を使っている。</p>
<p>使用する関数の引数も指定できる。<code>multiply_s()</code> で <code>s = 20</code> を指定する。</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="regression.html#cb200-1"></a>res_map_<span class="dv">20</span> &lt;-<span class="st"> </span>vec1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb200-2"><a href="regression.html#cb200-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="dt">.f =</span> multiply_s, <span class="dt">s =</span> <span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb200-3"><a href="regression.html#cb200-3"></a><span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb200-4"><a href="regression.html#cb200-4"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>##  [1]  20  40  60  80 100 120 140 160 180 200</code></pre>
<p>この例の場合には、<code>sapply()</code> を使うほうが簡単である。<code>sapply()</code> は <code>sapply(X = ベクトル, FUN = 適用する関数, X以外の引数)</code> というように使う。X に指定できるのはベクトルであり、結果もベクトルで返される。</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="regression.html#cb202-1"></a>res_apply &lt;-<span class="st"> </span>vec1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb202-2"><a href="regression.html#cb202-2"></a><span class="st">  </span><span class="kw">sapply</span>(<span class="dt">FUN =</span> multiply_s, <span class="dt">s =</span> <span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb202-3"><a href="regression.html#cb202-3"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>##  [1]  20  40  60  80 100 120 140 160 180 200</code></pre>
<p><code>map()</code> はリストに対しても同様に使える。</p>
<p>まず、データを生成する関数を作る。</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="regression.html#cb204-1"></a>dgp_example &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">100</span>) {</span>
<span id="cb204-2"><a href="regression.html#cb204-2"></a>  X &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>)</span>
<span id="cb204-3"><a href="regression.html#cb204-3"></a>  Y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="fl">0.6</span> <span class="op">*</span><span class="st"> </span>X, <span class="dt">sd =</span> <span class="dv">1</span>)</span>
<span id="cb204-4"><a href="regression.html#cb204-4"></a>  <span class="kw">return</span>(<span class="kw">tibble</span>(X, Y))</span>
<span id="cb204-5"><a href="regression.html#cb204-5"></a>}</span></code></pre></div>
<p>この関数を使って、N = 50 のデータセットを100個作る。</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="regression.html#cb205-1"></a>df_list &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">50</span>, <span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb205-2"><a href="regression.html#cb205-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="dt">.f =</span> dgp_example)</span>
<span id="cb205-3"><a href="regression.html#cb205-3"></a><span class="kw">class</span>(df_list)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<p>このリストに含まれる100個のデータセットのそれぞれで、<code>lm()</code> を使った回帰分析を実行する。</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="regression.html#cb207-1"></a>fit_list &lt;-<span class="st"> </span>df_list <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb207-2"><a href="regression.html#cb207-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="dt">.f =</span> lm, <span class="dt">formula =</span> Y <span class="op">~</span><span class="st"> </span>X)</span></code></pre></div>
<p>fit_list の各要素が、<code>lm()</code> で回帰分析を行った結果になっている。例えば、32番目のデータセットを使った結果は、</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="regression.html#cb208-1"></a>fit_list[[<span class="dv">32</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tidy</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 (Intercept)   0.0585     0.277     0.211   0.834
## 2 X             0.714      0.494     1.44    0.155</code></pre>
<p>である。</p>
<p><code>sapply()</code> も使えるが、結果が行列になって使いにくいので、この場合には <code>lapply()</code> を使ったほうが良い。</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="regression.html#cb210-1"></a>fit_list_<span class="dv">2</span> &lt;-<span class="st"> </span>df_list <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb210-2"><a href="regression.html#cb210-2"></a><span class="st">  </span><span class="kw">lapply</span>(<span class="dt">FUN =</span> lm, <span class="dt">formula =</span> Y <span class="op">~</span><span class="st"> </span>X)</span></code></pre></div>
<p>32番目のデータセットを使った結果は</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="regression.html#cb211-1"></a>fit_list_<span class="dv">2</span>[[<span class="dv">32</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tidy</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 (Intercept)   0.0585     0.277     0.211   0.834
## 2 X             0.714      0.494     1.44    0.155</code></pre>
<p>で、上と同じ結果が出る。</p>
<p><code>map()</code> や <code>sapply()</code>（あるいはその他の apply 系関数）では、適用する関数に無名関数 (anonymous function) を
使うことができる。無名関数とは、その名の通り名前がついていない関数である。簡単にいうと、使う時点でまだ関数として定義されていないものである。
例えば、1から10の整数ベクトルの各要素に、それぞれの数に2を足した数をかける、つまり、
<span class="math display">\[
f(x) = x (x + 2) = x^2 + 2x
\]</span>
を計算してみる。ただし、関数はあらかじめ定義せず、無名関数を使う。</p>
<p><code>map()</code> の場合：</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="regression.html#cb213-1"></a><span class="dv">1</span><span class="op">:</span><span class="dv">10</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-2"><a href="regression.html#cb213-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="dt">.f =</span> <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span>(x <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-3"><a href="regression.html#cb213-3"></a><span class="st">  </span><span class="kw">unlist</span>()</span></code></pre></div>
<pre><code>##  [1]   3   8  15  24  35  48  63  80  99 120</code></pre>
<p>このように、.f のところに関数自体を書いてしまえばよい。</p>
<p><code>sapply()</code> の場合：</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="regression.html#cb215-1"></a><span class="dv">1</span><span class="op">:</span><span class="dv">10</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb215-2"><a href="regression.html#cb215-2"></a><span class="st">  </span><span class="kw">sapply</span>(<span class="dt">FUN =</span> <span class="cf">function</span>(x) x<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x)</span></code></pre></div>
<pre><code>##  [1]   3   8  15  24  35  48  63  80  99 120</code></pre>
<p>とできる。</p>
<p><code>map()</code> や<code>sapply()</code> を使うほうが、<code>for</code> ループを使うより計算が速くなる。また、コードもシンプルに書けることが多い。
しかし、どうしても使い方が難しいと思うなら、無理に使おうとせず、<code>for</code> ループを使えば良い。</p>
</div>
<div id="purrrarray_tree" class="section level4" number="4.1.4.3">
<h4><span class="header-section-number">4.1.4.3</span> <code>purrr::array_tree()</code></h4>
<p>行列（正確には配列 [array] に使えるが、行列で説明する）をリストに変換するために、<code>purrr::array_tree()</code> を使う。</p>
<p>まず、行列を作る。</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="regression.html#cb217-1"></a>m1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>, <span class="dt">nrow =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-2"><a href="regression.html#cb217-2"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]    1    2    3    4
## [2,]    5    6    7    8
## [3,]    9   10   11   12</code></pre>
<p>この行列の各行を要素にもつリストを作る。つまり、各要素が [1, 2, 3, 4]、[5, 6, 7, 8]、[9, 10, 11, 12] で全体の長さが3のリストを作る。</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="regression.html#cb219-1"></a>list_row &lt;-<span class="st"> </span>m1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb219-2"><a href="regression.html#cb219-2"></a><span class="st">  </span><span class="kw">array_tree</span>(<span class="dt">margin =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb219-3"><a href="regression.html#cb219-3"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1 2 3 4
## 
## [[2]]
## [1] 5 6 7 8
## 
## [[3]]
## [1]  9 10 11 12</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="regression.html#cb221-1"></a><span class="kw">length</span>(list_row)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>このように、<code>margin = 1</code> で <code>array_tree()</code> を使うと、行列の各行を要素にもつリストができる。</p>
<p>同様に、行列の各列を要素にもつリストを作る。つまり、各要素が [1, 5, 9]、[2, 6, 10]、[3, 7, 11]、[4, 8, 12] で全体の長さが4のリストを作る。</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="regression.html#cb223-1"></a>list_col &lt;-<span class="st"> </span>m1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb223-2"><a href="regression.html#cb223-2"></a><span class="st">  </span><span class="kw">array_tree</span>(<span class="dt">margin =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb223-3"><a href="regression.html#cb223-3"></a><span class="st">  </span><span class="kw">print</span>()</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1 5 9
## 
## [[2]]
## [1]  2  6 10
## 
## [[3]]
## [1]  3  7 11
## 
## [[4]]
## [1]  4  8 12</code></pre>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="regression.html#cb225-1"></a><span class="kw">length</span>(list_col)</span></code></pre></div>
<pre><code>## [1] 4</code></pre>
<p>このように、<code>margin = 2</code> で <code>array_tree()</code> を使うと、行列の各列を要素にもつリストができる。</p>
<p><br></p>
<p><code>tibble::enframe()</code> については、教科書 <span class="citation">(安井 <a href="#ref-yasui2020" role="doc-biblioref">2020</a>)</span> の pp.55-56 を参照。</p>
</div>
</div>
</div>
<div id="回帰分析のシミュレーション" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> 回帰分析のシミュレーション</h2>
<div id="単回帰" class="section level3" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> 単回帰</h3>
<p><strong>(1) 処置変数が二値の場合</strong></p>
<p>処置変数 <span class="math inline">\(D_i \in \{0, 1\}\)</span> と結果変数 <span class="math inline">\(Y_i \in \mathbb{R}\)</span> を考える。
<span class="math inline">\(Y_i\)</span> が <span class="math inline">\(D_i\)</span> の関数で
<span class="math display">\[
Y_i = 0.5 + 0.7 D_i + e_i
\]</span>
と表されるとする。この状況をシミュレートする。</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="regression.html#cb227-1"></a><span class="kw">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb227-2"><a href="regression.html#cb227-2"></a>N &lt;-<span class="st"> </span><span class="dv">500</span>  <span class="co"># sample size</span></span>
<span id="cb227-3"><a href="regression.html#cb227-3"></a>D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.4</span>)</span>
<span id="cb227-4"><a href="regression.html#cb227-4"></a>Y &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.8</span> <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb227-5"><a href="regression.html#cb227-5"></a>df_simple &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D)</span></code></pre></div>
<p><span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span> の関係を可視化する。</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="regression.html#cb228-1"></a>scat_simple &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df_simple, <span class="kw">aes</span>(<span class="dt">x =</span> D, <span class="dt">y =</span> Y)) <span class="op">+</span></span>
<span id="cb228-2"><a href="regression.html#cb228-2"></a><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb228-3"><a href="regression.html#cb228-3"></a><span class="st">  </span><span class="kw">geom_beeswarm</span>(<span class="dt">shape =</span> <span class="dv">20</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb228-4"><a href="regression.html#cb228-4"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>)</span>
<span id="cb228-5"><a href="regression.html#cb228-5"></a><span class="kw">plot</span>(scat_simple)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-127-1.png" width="288" /></p>
<p>回帰直線の傾きは、</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="regression.html#cb229-1"></a>fit_simple &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df_simple)</span>
<span id="cb229-2"><a href="regression.html#cb229-2"></a><span class="kw">coef</span>(fit_simple)[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>##         D 
## 0.8061476</code></pre>
<p>である。これは、処置群（D = 1 の群）の Y の平均値と、統制群（D = 0 の群）の Y の平均値の差である。</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="regression.html#cb231-1"></a><span class="kw">with</span>(df_simple, <span class="kw">mean</span>(Y[D <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[D <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]))</span></code></pre></div>
<pre><code>## [1] 0.8061476</code></pre>
<p>このように、回帰直線の傾きは、説明変数の値で条件付けた結果変数の期待値の差である。</p>
<p>また、回帰直線の切片は</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="regression.html#cb233-1"></a><span class="kw">coef</span>(fit_simple)[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## (Intercept) 
##   0.5173247</code></pre>
<p>であり、これは統制群（D = 0 の群）の Y の平均値</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="regression.html#cb235-1"></a><span class="kw">with</span>(df_simple, <span class="kw">mean</span>(Y[D <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]))</span></code></pre></div>
<pre><code>## [1] 0.5173247</code></pre>
<p>に等しい。</p>
<p><strong>(2) 処置変数が連続の場合</strong></p>
<p>処置変数 <span class="math inline">\(D_i \sim \mbox{U}(-2, 2)\)</span> と結果変数 <span class="math inline">\(Y_i \in \mathbb{R}\)</span> を考える。
<span class="math inline">\(Y_i\)</span> が <span class="math inline">\(D_i\)</span> の関数で
<span class="math display">\[
Y_i = 0.5 + 0.7 D_i + e_i
\]</span>
と表されるとする。この状況をシミュレートする。</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="regression.html#cb237-1"></a><span class="kw">set.seed</span>(<span class="dv">321</span>)</span>
<span id="cb237-2"><a href="regression.html#cb237-2"></a>N &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># sample size</span></span>
<span id="cb237-3"><a href="regression.html#cb237-3"></a>D &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-2</span>, <span class="dt">max =</span> <span class="dv">2</span>)</span>
<span id="cb237-4"><a href="regression.html#cb237-4"></a>Y &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.7</span> <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb237-5"><a href="regression.html#cb237-5"></a>df_cont &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D)</span></code></pre></div>
<p><span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span> の関係を可視化する。</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="regression.html#cb238-1"></a>scat_cont &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df_cont, <span class="kw">aes</span>(<span class="dt">x =</span> D, <span class="dt">y =</span> Y)) <span class="op">+</span></span>
<span id="cb238-2"><a href="regression.html#cb238-2"></a><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb238-3"><a href="regression.html#cb238-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape =</span> <span class="dv">20</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb238-4"><a href="regression.html#cb238-4"></a><span class="kw">plot</span>(scat_cont)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-133-1.png" width="384" /></p>
<p>回帰直線の傾きは、</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="regression.html#cb239-1"></a>fit_cont &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df_cont)</span>
<span id="cb239-2"><a href="regression.html#cb239-2"></a><span class="kw">coef</span>(fit_cont)[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>##        D 
## 0.710264</code></pre>
<p>である。これは、処置の値を1単位増やしたとき、平均するとY の平均値がどれだけ増加するかを示している。</p>
<p>観測された個体をD の値によって [-2, -1), [-1, 0), [0, 1), [1, 2] の4つのグループに分け、それぞれのグループでY の平均値を計算し、さらに隣のグループとの差をとる。</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="regression.html#cb241-1"></a>df_cont &lt;-<span class="st"> </span>df_cont <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb241-2"><a href="regression.html#cb241-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">case_when</span>(</span>
<span id="cb241-3"><a href="regression.html#cb241-3"></a>    D <span class="op">&lt;</span><span class="st"> </span><span class="dv">-1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb241-4"><a href="regression.html#cb241-4"></a>    D <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb241-5"><a href="regression.html#cb241-5"></a>    D <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">3</span>,</span>
<span id="cb241-6"><a href="regression.html#cb241-6"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span><span class="dv">4</span></span>
<span id="cb241-7"><a href="regression.html#cb241-7"></a>  ))</span>
<span id="cb241-8"><a href="regression.html#cb241-8"></a>(b1 &lt;-<span class="st"> </span><span class="kw">with</span>(df_cont, <span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>]) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">1</span>])))</span></code></pre></div>
<pre><code>## [1] 0.6512046</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="regression.html#cb243-1"></a>(b2 &lt;-<span class="st"> </span><span class="kw">with</span>(df_cont, <span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">3</span>]) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>])))</span></code></pre></div>
<pre><code>## [1] 0.7395212</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="regression.html#cb245-1"></a>(b3 &lt;-<span class="st"> </span><span class="kw">with</span>(df_cont, <span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">4</span>]) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[group <span class="op">==</span><span class="st"> </span><span class="dv">3</span>])))</span></code></pre></div>
<pre><code>## [1] 0.7123079</code></pre>
<p>説明変数である D の値が1増えるごとに、回帰係数に概ね近い値の分だけ、Y の平均値が増加していることがわかる。
それぞれのグループに属する観測値の数を重みにして加重平均をとると、</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="regression.html#cb247-1"></a>n_groups &lt;-<span class="st"> </span><span class="kw">table</span>(df_cont<span class="op">$</span>group)[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>)]</span>
<span id="cb247-2"><a href="regression.html#cb247-2"></a>weight &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">sum</span>(n_groups[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]), </span>
<span id="cb247-3"><a href="regression.html#cb247-3"></a>            <span class="kw">sum</span>(n_groups[<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>]), </span>
<span id="cb247-4"><a href="regression.html#cb247-4"></a>            <span class="kw">sum</span>(n_groups[<span class="dv">5</span><span class="op">:</span><span class="dv">6</span>]))</span>
<span id="cb247-5"><a href="regression.html#cb247-5"></a><span class="kw">weighted.mean</span>(<span class="kw">c</span>(b1, b2, b3), <span class="dt">w =</span> weight)</span></code></pre></div>
<pre><code>## [1] 0.7016254</code></pre>
<p>となり、傾きの推定値に近い値が得られる。</p>
<p>このように、回帰直線の傾きは、説明変数の値で条件付けた結果変数の期待値の差である。</p>
<p>また、回帰直線の切片は</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="regression.html#cb249-1"></a><span class="kw">coef</span>(fit_cont)[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## (Intercept) 
##   0.5032906</code></pre>
<p>であり、これは D = 0 のときのYの期待値の推定値である。シミュレーションデータで、D が 0に近い値の Y の平均値を計算すると、</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="regression.html#cb251-1"></a>epsilon &lt;-<span class="st"> </span><span class="fl">0.2</span></span>
<span id="cb251-2"><a href="regression.html#cb251-2"></a><span class="kw">with</span>(df_cont, <span class="kw">mean</span>(Y[D <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span>epsilon <span class="op">&amp;</span><span class="st"> </span>D <span class="op">&lt;</span><span class="st"> </span>epsilon]))</span></code></pre></div>
<pre><code>## [1] 0.4909429</code></pre>
<p>となり、推定値におおむね一致する。</p>
<p>このような結果はいつも成り立つのか、1回だけのシミュレーションでは信じられないだろう。
シミュレーションを繰り返す方法を自分で考えて実行してみよう。</p>
</div>
<div id="重回帰" class="section level3" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> 重回帰</h3>
<p>処置変数 <span class="math inline">\(D_i \in \{0, 1\}\)</span> と結果変数 <span class="math inline">\(Y_i \in \mathbb{R}\)</span> に加え、共変量 <span class="math inline">\(X \in \{-4, -3, \dots, 4\}\)</span> を考える。
<span class="math inline">\(Y_i\)</span> が <span class="math inline">\(D_i\)</span> と <span class="math inline">\(X_i\)</span> の関数で
<span class="math display">\[
Y_i = 0.5 + 0.7 D_i + 0.4 X_i +  e_i
\]</span>
と表されるとする。また、<span class="math inline">\(D_i\)</span> の値は<span class="math inline">\(X_i\)</span> に依存して、次のように決まることにする。
<span class="math display">\[
D_i \sim \mbox{Bernoulli}(\theta_i)\\
\theta_i = \mathrm{logit}^{-1}(0.5 X_i)
\]</span>
つまり、<span class="math inline">\(X\)</span> が大きくなるほど、<span class="math inline">\(D_i\)</span> が1になる確率が大きくなると仮定する。
<span class="math inline">\(\theta\)</span> と <span class="math inline">\(X\)</span> の関係を可視化すると、以下のようになる。</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="regression.html#cb253-1"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">X =</span> <span class="dv">-4</span><span class="op">:</span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb253-2"><a href="regression.html#cb253-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">theta =</span> <span class="kw">inv_logit</span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>X))</span>
<span id="cb253-3"><a href="regression.html#cb253-3"></a>p_logistic &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df, <span class="kw">aes</span>(<span class="dt">x =</span> X, <span class="dt">y =</span> theta)) <span class="op">+</span></span>
<span id="cb253-4"><a href="regression.html#cb253-4"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>) <span class="op">+</span></span>
<span id="cb253-5"><a href="regression.html#cb253-5"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;dodgerblue&quot;</span>) <span class="op">+</span></span>
<span id="cb253-6"><a href="regression.html#cb253-6"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(theta))</span>
<span id="cb253-7"><a href="regression.html#cb253-7"></a><span class="kw">plot</span>(p_logistic)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-139-1.png" width="384" /></p>
<p>この状況をシミュレートする。</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="regression.html#cb254-1"></a><span class="kw">set.seed</span>(<span class="dv">111</span>)</span>
<span id="cb254-2"><a href="regression.html#cb254-2"></a>N &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># sample size</span></span>
<span id="cb254-3"><a href="regression.html#cb254-3"></a>X &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="op">-</span><span class="dv">4</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb254-4"><a href="regression.html#cb254-4"></a>theta &lt;-<span class="st"> </span><span class="kw">inv_logit</span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>X)</span>
<span id="cb254-5"><a href="regression.html#cb254-5"></a>D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> theta)</span>
<span id="cb254-6"><a href="regression.html#cb254-6"></a>Y &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.7</span> <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.3</span> <span class="op">*</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb254-7"><a href="regression.html#cb254-7"></a>df_multiple &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D, X)</span></code></pre></div>
<p>Y を D と X に回帰する (long regression) と、D の係数の推定値は、</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="regression.html#cb255-1"></a>fit_long &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X, <span class="dt">data =</span> df_multiple)</span>
<span id="cb255-2"><a href="regression.html#cb255-2"></a><span class="kw">coef</span>(fit_long)[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>##         D 
## 0.6905941</code></pre>
<p>となる。</p>
<p>Y を D のみに回帰する (short regression)と、D の係数の推定値は、</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="regression.html#cb257-1"></a>fit_short &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df_multiple)</span>
<span id="cb257-2"><a href="regression.html#cb257-2"></a><span class="kw">coef</span>(fit_short)[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>##        D 
## 1.516601</code></pre>
<p>となり、推定値が過大推定されている。この値は、観測された平均値の2群間の差である。</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="regression.html#cb259-1"></a><span class="kw">with</span>(df_multiple, <span class="kw">mean</span>(Y[D <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[D <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])))</span></code></pre></div>
<pre><code>## [1] 1.516601</code></pre>
</div>
<div id="重回帰によるブロッキング" class="section level3" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> 重回帰によるブロッキング</h3>
<p>重回帰を行う代わりに、上のデータ df_multiple を共変量<span class="math inline">\(X\)</span> の値ごとにブロックに分け、単回帰によってブロックごとに D の係数を推定してみよう。</p>
<p><span class="math inline">\(X = x\)</span> のブロックで傾きを推定する関数を用意する。</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="regression.html#cb261-1"></a>beta_X &lt;-<span class="st"> </span><span class="cf">function</span>(x, data) {</span>
<span id="cb261-2"><a href="regression.html#cb261-2"></a>  fit &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-3"><a href="regression.html#cb261-3"></a><span class="st">    </span><span class="kw">filter</span>(X <span class="op">==</span><span class="st"> </span>x) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-4"><a href="regression.html#cb261-4"></a><span class="st">    </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> .)</span>
<span id="cb261-5"><a href="regression.html#cb261-5"></a>  <span class="kw">return</span>(<span class="kw">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb261-6"><a href="regression.html#cb261-6"></a>}</span></code></pre></div>
<p>Xの値ごとに、傾きを推定する。</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="regression.html#cb262-1"></a>beta_vec &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="op">-</span><span class="dv">4</span><span class="op">:</span><span class="dv">4</span>, beta_X, <span class="dt">data =</span> df_multiple)</span>
<span id="cb262-2"><a href="regression.html#cb262-2"></a><span class="kw">names</span>(beta_vec) &lt;-<span class="st"> </span><span class="kw">str_c</span>(<span class="st">&quot;X=&quot;</span>, <span class="dv">-4</span><span class="op">:</span><span class="dv">4</span>)</span>
<span id="cb262-3"><a href="regression.html#cb262-3"></a>beta_vec</span></code></pre></div>
<pre><code>##      X=-4      X=-3      X=-2      X=-1       X=0       X=1       X=2 
## 0.8446962 0.6572588 0.7475040 0.6917050 0.6252307 0.7681240 0.5260543 
##       X=3       X=4 
## 0.7046942 0.6230728</code></pre>
<p>ブロックごとに処置効果を求めることができた。このように、ブロックに分けて単回帰を行えば、過大推定にはならないことがわかる。これらの値を元に、全体の処置効果を加重平均で求めてみよう。</p>
<p>ATE を求めるために <span class="math inline">\(X = x\)</span> となるブロックの重みを<span class="math inline">\(\Pr (X_i = x)\)</span>とすると、</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="regression.html#cb264-1"></a>w_ate &lt;-<span class="st"> </span><span class="kw">table</span>(df_multiple<span class="op">$</span>X)</span>
<span id="cb264-2"><a href="regression.html#cb264-2"></a><span class="kw">weighted.mean</span>(beta_vec, <span class="dt">w =</span> w_ate)</span></code></pre></div>
<pre><code>## [1] 0.687105</code></pre>
<p>となる。重回帰によって求めた推定値との差は、</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="regression.html#cb266-1"></a><span class="kw">coef</span>(fit_long)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">weighted.mean</span>(beta_vec, <span class="dt">w =</span> w_ate)</span></code></pre></div>
<pre><code>##           D 
## 0.003489067</code></pre>
<p>である。2つの推定方法にはあまり違いがないようである。</p>
<p>同様に、ATT（処置群における平均処置効果）を求めるために <span class="math inline">\(X = x\)</span> となるブロックの重みを<span class="math inline">\(\Pr (X_i = x \mid D_i = 1)\)</span>とすると、</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="regression.html#cb268-1"></a>df_treated &lt;-<span class="st"> </span>df_multiple <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(D <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb268-2"><a href="regression.html#cb268-2"></a>w_att &lt;-<span class="st"> </span><span class="kw">table</span>(df_treated<span class="op">$</span>X)</span>
<span id="cb268-3"><a href="regression.html#cb268-3"></a><span class="kw">weighted.mean</span>(beta_vec, <span class="dt">w =</span> w_att)</span></code></pre></div>
<pre><code>## [1] 0.6648775</code></pre>
<p>となる。重回帰によって求めた推定値との差は、</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="regression.html#cb270-1"></a><span class="kw">coef</span>(fit_long)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">weighted.mean</span>(beta_vec, <span class="dt">w =</span> w_att)</span></code></pre></div>
<pre><code>##          D 
## 0.02571656</code></pre>
<p>となる。</p>
<p>1回だけでは信じられないので、重回帰の推定値とブロックごとの単回帰から求めた ATEの推定値の差をとるシミュレーションを繰り返してみよう。</p>
<p>まずは、2つの推定値の差を1回計算するための関数を作る。</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="regression.html#cb272-1"></a>sim_reg_block &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">1000</span>, <span class="dt">beta =</span> <span class="fl">0.7</span>, <span class="dt">gamma =</span> <span class="fl">0.3</span>, <span class="dt">lambda =</span> <span class="fl">0.5</span>) {</span>
<span id="cb272-2"><a href="regression.html#cb272-2"></a>  <span class="co">## beta: D の因果効果</span></span>
<span id="cb272-3"><a href="regression.html#cb272-3"></a>  <span class="co">## gamma: X と Y の関係の強さ</span></span>
<span id="cb272-4"><a href="regression.html#cb272-4"></a>  <span class="co">## lambda X と D の関係の強さ</span></span>
<span id="cb272-5"><a href="regression.html#cb272-5"></a>  X &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="op">-</span><span class="dv">4</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb272-6"><a href="regression.html#cb272-6"></a>  theta &lt;-<span class="st"> </span><span class="kw">inv_logit</span>(lambda <span class="op">*</span><span class="st"> </span>X)</span>
<span id="cb272-7"><a href="regression.html#cb272-7"></a>  D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> theta)</span>
<span id="cb272-8"><a href="regression.html#cb272-8"></a>  Y &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>gamma <span class="op">*</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb272-9"><a href="regression.html#cb272-9"></a>  df &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D, X)</span>
<span id="cb272-10"><a href="regression.html#cb272-10"></a>  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X)</span>
<span id="cb272-11"><a href="regression.html#cb272-11"></a>  beta_vec &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="op">-</span><span class="dv">4</span><span class="op">:</span><span class="dv">4</span>, beta_X, <span class="dt">data =</span> df)</span>
<span id="cb272-12"><a href="regression.html#cb272-12"></a>  weight &lt;-<span class="st"> </span><span class="kw">table</span>(X)</span>
<span id="cb272-13"><a href="regression.html#cb272-13"></a>  dif &lt;-<span class="st"> </span><span class="kw">coef</span>(fit)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">weighted.mean</span>(beta_vec, <span class="dt">w =</span> weight)</span>
<span id="cb272-14"><a href="regression.html#cb272-14"></a>  <span class="kw">names</span>(dif) &lt;-<span class="st"> &quot;difference&quot;</span></span>
<span id="cb272-15"><a href="regression.html#cb272-15"></a>  <span class="kw">return</span>(dif)</span>
<span id="cb272-16"><a href="regression.html#cb272-16"></a>}</span></code></pre></div>
<p>この関数を1回使ってみる。</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="regression.html#cb273-1"></a><span class="kw">sim_reg_block</span>()</span></code></pre></div>
<pre><code>##  difference 
## -0.02281703</code></pre>
<p>1000回繰り返して結果を可視化する。</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="regression.html#cb275-1"></a>sim_rb &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_reg_block</span>())</span>
<span id="cb275-2"><a href="regression.html#cb275-2"></a>hist_sim_rb &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">difference =</span> sim_rb) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-3"><a href="regression.html#cb275-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> difference, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb275-4"><a href="regression.html#cb275-4"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.005</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb275-5"><a href="regression.html#cb275-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;「重回帰」と「ブロックの単回帰の加重平均」の差&quot;</span>,</span>
<span id="cb275-6"><a href="regression.html#cb275-6"></a>       <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb275-7"><a href="regression.html#cb275-7"></a><span class="kw">plot</span>(hist_sim_rb)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-152-1.png" width="384" /></p>
<p>5パーセンタイルと95パーセンタイルをとると、</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="regression.html#cb276-1"></a><span class="kw">quantile</span>(sim_rb, <span class="dt">p =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))</span></code></pre></div>
<pre><code>##          5%         95% 
## -0.02336985  0.02359641</code></pre>
<p>となる。つまり、シミュレーションの値のうち90% が <span class="math inline">\([-0.023, 0.024]\)</span> の間にある。推定しようとしている値は 0.70 なので、2つの推定方法の間には平均的には差がないと考えてよさそうだ。</p>
<p>このように、重回帰の結果は、ブロックごとに単回帰してその加重平均を求めた場合とほぼ同じ結果になることがわかる。</p>
</div>
<div id="重回帰分析によるセレクションバイアスの除去" class="section level3" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> 重回帰分析によるセレクションバイアスの除去</h3>
<p><a href="selection-bias.html">トピック2</a> で考えた、病院と健康状態の例をもう1度考える。</p>
<p>トピック2では、以下の関数でセレクションバイアスのシミュレーションをした（一部書き換え）。</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="regression.html#cb278-1"></a>sim_hospital &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">beta =</span> <span class="fl">0.6</span>, <span class="dt">N =</span> <span class="fl">1e4</span>, </span>
<span id="cb278-2"><a href="regression.html#cb278-2"></a>                         <span class="dt">mu =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>), </span>
<span id="cb278-3"><a href="regression.html#cb278-3"></a>                         <span class="dt">sigma =</span> <span class="kw">rep</span>(<span class="fl">0.1</span>, <span class="dv">5</span>)) {</span>
<span id="cb278-4"><a href="regression.html#cb278-4"></a>  </span>
<span id="cb278-5"><a href="regression.html#cb278-5"></a>  <span class="co"># sigma は、健康状態ごとに変えても良いことにする</span></span>
<span id="cb278-6"><a href="regression.html#cb278-6"></a>  <span class="cf">if</span> (<span class="kw">length</span>(sigma <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)) sigma &lt;-<span class="st"> </span><span class="kw">rep</span>(sigma, <span class="dv">5</span>)</span>
<span id="cb278-7"><a href="regression.html#cb278-7"></a>  </span>
<span id="cb278-8"><a href="regression.html#cb278-8"></a>  h_hidden &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>,</span>
<span id="cb278-9"><a href="regression.html#cb278-9"></a>                    <span class="dt">prob =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb278-10"><a href="regression.html#cb278-10"></a>  prob &lt;-<span class="st">  </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> mu[h_hidden], <span class="dt">sd =</span> sigma[h_hidden])</span>
<span id="cb278-11"><a href="regression.html#cb278-11"></a>  prob &lt;-<span class="st"> </span><span class="kw">case_when</span>(</span>
<span id="cb278-12"><a href="regression.html#cb278-12"></a>    prob <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb278-13"><a href="regression.html#cb278-13"></a>    prob <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb278-14"><a href="regression.html#cb278-14"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>prob</span>
<span id="cb278-15"><a href="regression.html#cb278-15"></a>  )</span>
<span id="cb278-16"><a href="regression.html#cb278-16"></a>  D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob)</span>
<span id="cb278-17"><a href="regression.html#cb278-17"></a>  Y &lt;-<span class="st"> </span>h_hidden <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N)  <span class="co"># この行を書き換え：Y にノイズを加える</span></span>
<span id="cb278-18"><a href="regression.html#cb278-18"></a>  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D)</span>
<span id="cb278-19"><a href="regression.html#cb278-19"></a>  <span class="kw">return</span>(<span class="kw">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb278-20"><a href="regression.html#cb278-20"></a>}</span></code></pre></div>
<p>シミュレーションを1000回実行してみよう。</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="regression.html#cb279-1"></a>sb1 &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_hospital</span>())</span></code></pre></div>
<p>この結果を図示する。</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="regression.html#cb280-1"></a>hist_sb1 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">beta =</span> sb1) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb280-2"><a href="regression.html#cb280-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> beta, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb280-3"><a href="regression.html#cb280-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">binwidth =</span> <span class="fl">0.01</span>) <span class="op">+</span></span>
<span id="cb280-4"><a href="regression.html#cb280-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span> <span class="st">&quot;単純比較から得られる「効果」&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb280-5"><a href="regression.html#cb280-5"></a><span class="kw">plot</span>(hist_sb1)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-156-1.png" width="384" /></p>
<p>処置効果を0.6 に設定しているのに、セルフセレクションのせいで効果が過小推定されている。問題は、セルフセレクションに使われる、元の健康状態 h_hidden が未観測であることだった。</p>
<p>h_hidden が観測されていれば、重回帰によってセレクションバイアスを取り除くことができる。
関数を書き換えて、確かめてみよう。</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="regression.html#cb281-1"></a>sim_hospital2 &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">beta =</span> <span class="fl">0.6</span>, <span class="dt">N =</span> <span class="fl">1e4</span>, </span>
<span id="cb281-2"><a href="regression.html#cb281-2"></a>                          <span class="dt">mu =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>), </span>
<span id="cb281-3"><a href="regression.html#cb281-3"></a>                          <span class="dt">sigma =</span> <span class="kw">rep</span>(<span class="fl">0.1</span>, <span class="dv">5</span>)) {</span>
<span id="cb281-4"><a href="regression.html#cb281-4"></a>  </span>
<span id="cb281-5"><a href="regression.html#cb281-5"></a>  <span class="co"># sigma は、健康状態ごとに変えても良いことにする</span></span>
<span id="cb281-6"><a href="regression.html#cb281-6"></a>  <span class="cf">if</span> (<span class="kw">length</span>(sigma <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)) sigma &lt;-<span class="st"> </span><span class="kw">rep</span>(sigma, <span class="dv">5</span>)</span>
<span id="cb281-7"><a href="regression.html#cb281-7"></a>  </span>
<span id="cb281-8"><a href="regression.html#cb281-8"></a>  h_hidden &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">size =</span> N, <span class="dt">replace =</span> <span class="ot">TRUE</span>,</span>
<span id="cb281-9"><a href="regression.html#cb281-9"></a>                    <span class="dt">prob =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb281-10"><a href="regression.html#cb281-10"></a>  prob &lt;-<span class="st">  </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> mu[h_hidden], <span class="dt">sd =</span> sigma[h_hidden])</span>
<span id="cb281-11"><a href="regression.html#cb281-11"></a>  prob &lt;-<span class="st"> </span><span class="kw">case_when</span>(</span>
<span id="cb281-12"><a href="regression.html#cb281-12"></a>    prob <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb281-13"><a href="regression.html#cb281-13"></a>    prob <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb281-14"><a href="regression.html#cb281-14"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>prob</span>
<span id="cb281-15"><a href="regression.html#cb281-15"></a>  )</span>
<span id="cb281-16"><a href="regression.html#cb281-16"></a>  D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob)</span>
<span id="cb281-17"><a href="regression.html#cb281-17"></a>  Y &lt;-<span class="st"> </span>h_hidden <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N) </span>
<span id="cb281-18"><a href="regression.html#cb281-18"></a>  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>h_hidden)   <span class="co"># この行を書き換え：h_hidden を含む重回帰分析を行う</span></span>
<span id="cb281-19"><a href="regression.html#cb281-19"></a>  <span class="kw">return</span>(<span class="kw">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb281-20"><a href="regression.html#cb281-20"></a>}</span></code></pre></div>
<p>書き換えたのは、1行だけである。</p>
<p>この関数で、シミュレーションを1000回実行してみよう。</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="regression.html#cb282-1"></a>sb2 &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_hospital2</span>())</span></code></pre></div>
<p>この結果を可視化しよう。</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="regression.html#cb283-1"></a>hist_sb2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">beta =</span> sb2) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb283-2"><a href="regression.html#cb283-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> beta, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb283-3"><a href="regression.html#cb283-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">binwidth =</span> <span class="fl">0.01</span>) <span class="op">+</span></span>
<span id="cb283-4"><a href="regression.html#cb283-4"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.6</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>) <span class="op">+</span></span>
<span id="cb283-5"><a href="regression.html#cb283-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span> <span class="st">&quot;重回帰によって推定される「効果」&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb283-6"><a href="regression.html#cb283-6"></a><span class="kw">plot</span>(hist_sb2)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-159-1.png" width="384" /></p>
<p>このように、セレクションの原因となっている変数を重回帰モデルに加えることができれば、セレクションバイアスを除去することができる。</p>
<p>これができるのは、セレクションの原因が観測されているときだけである。</p>
</div>
</div>
<div id="脱落変数バイアスと処置後変数バイアス" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> 脱落変数バイアスと処置後変数バイアス</h2>
<p>重回帰分析では複数の説明変数を使う。複数の説明変数を使う理由の1つは、ある結果に影響を与える原因が複数あると考えられるからである。そのようなとき、原因と考えられる複数の説明変数を回帰分析に含めるというのは自然な発想である。しかし、結果変数の原因となる変数のなかには、因果推論のために必ず回帰分析に含める必要があるものもあれば、回帰分析に含めても含めなくてもよいものや、回帰分析に含んではいけないものもある。統計的因果推論のための回帰分析で、統制 (control) すべき変数はどのようなものだろうか。シミュレーションを通じて理解しよう。</p>
<div id="脱落変数バイアス-ovb" class="section level3" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> 脱落変数バイアス (OVB)</h3>
<p>2つの変数 <span class="math inline">\(Y\)</span> と<span class="math inline">\(D\)</span> があり、この2変数の間に強い相関があるとする。このとき、<span class="math inline">\(D\)</span> が <span class="math inline">\(Y\)</span> の原因であるとは限らない。1つの可能性は、<span class="math inline">\(Y\)</span> が <span class="math inline">\(D\)</span> の原因であるというものである。因果の向きが逆の場合については、ここでは考えない（実際の研究においては、それぞれの変数がお互いの原因であるという「同時性 (simulteneity)」も重要な問題である）。</p>
<p>もう1つの可能性は、第三の変数 <span class="math inline">\(X\)</span> が存在し、<span class="math inline">\(X\)</span> が <span class="math inline">\(D\)</span> の原因であると同時に、<span class="math inline">\(Y\)</span> の原因でもあるという場合である。
<span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span> の相関が <span class="math inline">\(X\)</span> によって説明されてしまうとき、<span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span> の相関は、<strong>見せかけの因果関係 (spurious correlation)</strong> と呼ばれる。また、実際に <span class="math inline">\(D\)</span> が <span class="math inline">\(Y\)</span> の原因だとしても、
<span class="math inline">\(X\)</span> のように <span class="math inline">\(D\)</span> と <span class="math inline">\(Y\)</span> の両者に影響する変数があるかもしれない。このような <span class="math inline">\(X\)</span> は、<strong>交絡変数 [交絡因子]</strong> (<strong>confouding variable</strong> or <strong>confounder</strong>) または<strong>共変量</strong> (<strong>covariate</strong>) と呼ばれる。</p>
<p>回帰分析で <span class="math inline">\(D\)</span> が<span class="math inline">\(Y\)</span> に及ぼす因果効果を推定するためには、交絡変数を必ず統制する必要がある（厳密には、バックドアパスをブロックすればよい）。交絡変数を統制しないと、推定にバイアスが生じる。このバイアスを<strong>脱落変数バイアス (omitted variable bias; OVB)</strong> と呼ぶ。OVBは、回帰分析におけるセレクションバイアスである。</p>
<p><span class="math inline">\(Y\)</span> と <span class="math inline">\(D\)</span> の両者に影響を与える <span class="math inline">\(X\)</span> という交絡変数があるとき、<span class="math inline">\(X\)</span> を無視して、
<span class="math display">\[
Y_i = \alpha^s + \beta^s D_i + u_i
\]</span>
という回帰式を考えると、<span class="math inline">\(X\)</span> は誤差項 <span class="math inline">\(u\)</span> に含まれることになる。
そうすると、<span class="math inline">\(\beta^s\)</span> は <span class="math inline">\(D\)</span> が <span class="math inline">\(Y\)</span> に与える因果効果の推定量ではなく、バイアスを含んだ推定量になってしまう。そのバイアスが、脱落変数バイアスである。</p>
<p>このことを、シミュレーションで確認してみよう。まず、データを作る。ここでは、D, X1, X2 という3つの変数が Y の原因となっている（muを計算する行を参照）。また、X1 は D の原因でもあるので、X1 は交絡変数である。したがって、X1 を統制（コントロール）しないと、D の係数が正しく推定できないはずである。X3 は結果変数とは無関係の変数である。</p>
<p>この関係を図にしよう。X3は他の変数に影響しないので、省略する。（この図の作り方は後で説明する。）</p>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-160-1.png" width="384" /></p>
<p>まず、D が Y に与える因果効果 beta の値を決める。</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="regression.html#cb284-1"></a>beta &lt;-<span class="st"> </span><span class="fl">0.4</span></span></code></pre></div>
<p>次に、データを生成する。</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="regression.html#cb285-1"></a><span class="co">## シミュレーションを再度実行したときに同じ結果が得られるように、乱数の種を指定する</span></span>
<span id="cb285-2"><a href="regression.html#cb285-2"></a><span class="co">## 異なる結果を得たいときは、set.seed() の中身を変える</span></span>
<span id="cb285-3"><a href="regression.html#cb285-3"></a><span class="kw">set.seed</span>(<span class="dv">777</span>)   </span>
<span id="cb285-4"><a href="regression.html#cb285-4"></a>N &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb285-5"><a href="regression.html#cb285-5"></a>X1 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>)</span>
<span id="cb285-6"><a href="regression.html#cb285-6"></a>X2 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>) </span>
<span id="cb285-7"><a href="regression.html#cb285-7"></a>X3 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>)</span>
<span id="cb285-8"><a href="regression.html#cb285-8"></a>D &lt;-<span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N)</span>
<span id="cb285-9"><a href="regression.html#cb285-9"></a>mu &lt;-<span class="st"> </span><span class="fl">1.5</span> <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>X1 <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>X2 </span>
<span id="cb285-10"><a href="regression.html#cb285-10"></a>Y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> mu, <span class="dt">sd =</span> <span class="dv">1</span>)</span>
<span id="cb285-11"><a href="regression.html#cb285-11"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D, X1, X2, X3)</span></code></pre></div>
<p>正しいモデルを作り、パラメタを推定する。</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="regression.html#cb286-1"></a>true_model &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2, <span class="dt">data =</span> df)</span>
<span id="cb286-2"><a href="regression.html#cb286-2"></a><span class="kw">tidy</span>(true_model)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)    1.58     0.114      13.8  1.55e-24
## 2 D              0.419    0.104       4.04 1.07e- 4
## 3 X1             0.507    0.0432     11.7  3.19e-20
## 4 X2            -0.159    0.0415     -3.83 2.26e- 4</code></pre>
<p>D の係数に注目すると、パラメタとして設定した 0.4 にある程度近い値 0.42 が得られる。</p>
<p>次に、交絡変数であるX1を除外した「正しくない」モデル (short regression) でパラメタを推定する。</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="regression.html#cb288-1"></a>omitted_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X2, <span class="dt">data =</span> df)</span>
<span id="cb288-2"><a href="regression.html#cb288-2"></a><span class="kw">tidy</span>(omitted_<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)    1.55     0.177       8.77 6.16e-14
## 2 D              0.983    0.142       6.91 5.14e-10
## 3 X2            -0.157    0.0644     -2.44 1.64e- 2</code></pre>
<p>このモデルでは、Dの係数の推定値が 0.98 になり、D の Y に対する影響がかなり過大に推定されている。</p>
<p>続いて、<span class="math inline">\(Y\)</span> の原因ではあるが、交絡変数ではないX2 を除外してみる。</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="regression.html#cb290-1"></a>omitted_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1, <span class="dt">data =</span> df)</span>
<span id="cb290-2"><a href="regression.html#cb290-2"></a><span class="kw">tidy</span>(omitted_<span class="dv">2</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)    1.62     0.121      13.3  1.18e-23
## 2 D              0.384    0.110       3.48 7.48e- 4
## 3 X1             0.506    0.0462     11.0  1.16e-18</code></pre>
<p>ここでは D の係数が 0.38 であり、正しい値である 0.4 に近い。</p>
<p>最後に、Y の原因ではない（関係のない）X3 を加えて回帰分析をしてみよう。</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="regression.html#cb292-1"></a>extra_model &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2 <span class="op">+</span><span class="st"> </span>X3, <span class="dt">data =</span> df)</span>
<span id="cb292-2"><a href="regression.html#cb292-2"></a><span class="kw">tidy</span>(extra_model)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)  1.57       0.115     13.7   2.82e-24
## 2 D            0.422      0.105      4.02  1.17e- 4
## 3 X1           0.507      0.0435    11.7   5.21e-20
## 4 X2          -0.159      0.0417    -3.81  2.46e- 4
## 5 X3          -0.00954    0.0395    -0.241 8.10e- 1</code></pre>
<p>D の係数についてはほぼ正しい値に近い推定値が得られた。また、X3の係数が0に近く、影響がないという事実と整合的な結果が得られた。</p>
<p>ここまでのシミュレーションは、データセットを1つ生成し、それを分析しただけである。1つのデータだけでは偶然そうなっただけかもしれないので、上のシミュレーションを繰り返し行い、推定結果を調べてみよう。</p>
<p>まず、繰り返しシミュレーションを行うための関数を作る。</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="regression.html#cb294-1"></a>sim_regression &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">50</span>, <span class="dt">beta =</span> <span class="fl">0.4</span>, </span>
<span id="cb294-2"><a href="regression.html#cb294-2"></a>                           <span class="dt">gamma =</span> <span class="fl">0.2</span>, <span class="dt">lambda =</span> <span class="fl">0.5</span>) {</span>
<span id="cb294-3"><a href="regression.html#cb294-3"></a>    <span class="co">## 重回帰分析をシミュレートするための関数</span></span>
<span id="cb294-4"><a href="regression.html#cb294-4"></a>    <span class="co">## 引数：N = 標本サイズ（既定値は50）</span></span>
<span id="cb294-5"><a href="regression.html#cb294-5"></a>    <span class="co">##       beta =  処置効果</span></span>
<span id="cb294-6"><a href="regression.html#cb294-6"></a>    <span class="co">##       gamma = 処置と交絡の関係の強さ</span></span>
<span id="cb294-7"><a href="regression.html#cb294-7"></a>    <span class="co">##       lambda = 結果と交絡の関係の強さ</span></span>
<span id="cb294-8"><a href="regression.html#cb294-8"></a>    <span class="co">## 返り値：モデルの名前、beta の推定値、標準誤差の3列をもつデータフレーム</span></span>
<span id="cb294-9"><a href="regression.html#cb294-9"></a>    </span>
<span id="cb294-10"><a href="regression.html#cb294-10"></a>    X1 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>)</span>
<span id="cb294-11"><a href="regression.html#cb294-11"></a>    X2 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>)</span>
<span id="cb294-12"><a href="regression.html#cb294-12"></a>    X3 &lt;-<span class="st"> </span><span class="kw">runif</span>(N, <span class="dt">min =</span> <span class="dv">-5</span>, <span class="dt">max =</span> <span class="dv">5</span>)</span>
<span id="cb294-13"><a href="regression.html#cb294-13"></a>    D &lt;-<span class="st"> </span>gamma <span class="op">*</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</span>
<span id="cb294-14"><a href="regression.html#cb294-14"></a>    mu &lt;-<span class="st"> </span><span class="fl">1.5</span> <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>lambda <span class="op">*</span><span class="st"> </span>X1 <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>X2 </span>
<span id="cb294-15"><a href="regression.html#cb294-15"></a>    Y &lt;-<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</span>
<span id="cb294-16"><a href="regression.html#cb294-16"></a>    df &lt;-<span class="st"> </span><span class="kw">tibble</span>(Y, D, X1, X2, X3)</span>
<span id="cb294-17"><a href="regression.html#cb294-17"></a>    </span>
<span id="cb294-18"><a href="regression.html#cb294-18"></a>    models &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">true =</span> Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2,</span>
<span id="cb294-19"><a href="regression.html#cb294-19"></a>                   <span class="dt">omit1 =</span> Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X2,</span>
<span id="cb294-20"><a href="regression.html#cb294-20"></a>                   <span class="dt">omit2 =</span> Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1,</span>
<span id="cb294-21"><a href="regression.html#cb294-21"></a>                   <span class="dt">extra =</span> Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2 <span class="op">+</span><span class="st"> </span>X3) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb294-22"><a href="regression.html#cb294-22"></a><span class="st">      </span><span class="kw">enframe</span>(<span class="dt">name =</span> <span class="st">&quot;model&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;formula&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb294-23"><a href="regression.html#cb294-23"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">fit =</span> <span class="kw">map</span>(<span class="dt">.x =</span> formula, <span class="dt">.f =</span> lm, <span class="dt">data =</span> df),</span>
<span id="cb294-24"><a href="regression.html#cb294-24"></a>             <span class="dt">res =</span> <span class="kw">map</span>(<span class="dt">.x =</span> fit, <span class="dt">.f =</span> tidy)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb294-25"><a href="regression.html#cb294-25"></a><span class="st">      </span><span class="kw">unnest</span>(<span class="dt">cols =</span> res)</span>
<span id="cb294-26"><a href="regression.html#cb294-26"></a>    </span>
<span id="cb294-27"><a href="regression.html#cb294-27"></a>    beta &lt;-<span class="st"> </span>models <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb294-28"><a href="regression.html#cb294-28"></a><span class="st">      </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb294-29"><a href="regression.html#cb294-29"></a><span class="st">      </span><span class="kw">select</span>(model, estimate, std.error)</span>
<span id="cb294-30"><a href="regression.html#cb294-30"></a></span>
<span id="cb294-31"><a href="regression.html#cb294-31"></a>    <span class="kw">return</span>(beta)</span>
<span id="cb294-32"><a href="regression.html#cb294-32"></a>}</span></code></pre></div>
<p>この関数を、1度だけ使ってみよう。</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="regression.html#cb295-1"></a><span class="kw">sim_regression</span>() </span></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   model estimate std.error
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 true     0.346     0.188
## 2 omit1    1.00      0.240
## 3 omit2    0.574     0.200
## 4 extra    0.345     0.190</code></pre>
<p>各モデルによる beta の推定値とその標準誤差が計算される。</p>
<p>作った関数を使い、シミュレーションを1000回行ってみよう。</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="regression.html#cb297-1"></a>n_trials &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb297-2"><a href="regression.html#cb297-2"></a>sim_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(n_trials, <span class="kw">sim_regression</span>())</span></code></pre></div>
<p>この結果は行列になっていて使いにくいので、リストに変換する。</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="regression.html#cb298-1"></a>sim1 &lt;-<span class="st"> </span><span class="kw">array_tree</span>(sim_<span class="dv">1</span>, <span class="dt">margin =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>モデルごとの推定値を取り出して、データフレームにまとめる。</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="regression.html#cb299-1"></a>sim1_beta &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">sim_id =</span> <span class="dv">1</span><span class="op">:</span>n_trials) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb299-2"><a href="regression.html#cb299-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">true =</span> <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>n_trials, <span class="cf">function</span>(i) sim1[[i]]<span class="op">$</span>estimate[<span class="dv">1</span>]),</span>
<span id="cb299-3"><a href="regression.html#cb299-3"></a>         <span class="dt">omit1 =</span> <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>n_trials, <span class="cf">function</span>(i) sim1[[i]]<span class="op">$</span>estimate[<span class="dv">2</span>]),</span>
<span id="cb299-4"><a href="regression.html#cb299-4"></a>         <span class="dt">omit2 =</span> <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>n_trials, <span class="cf">function</span>(i) sim1[[i]]<span class="op">$</span>estimate[<span class="dv">3</span>]),</span>
<span id="cb299-5"><a href="regression.html#cb299-5"></a>         <span class="dt">extra =</span> <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>n_trials, <span class="cf">function</span>(i) sim1[[i]]<span class="op">$</span>estimate[<span class="dv">4</span>]))</span></code></pre></div>
<p>モデルごとの推定値の平均値を確認する。</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="regression.html#cb300-1"></a><span class="co">#sim1_beta %&gt;% summarize(across(true:extra, mean)) # across() の使い方がわかるならこれで </span></span>
<span id="cb300-2"><a href="regression.html#cb300-2"></a>sim1_beta <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb300-3"><a href="regression.html#cb300-3"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>sim_id) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb300-4"><a href="regression.html#cb300-4"></a><span class="st">  </span><span class="kw">colMeans</span>()</span></code></pre></div>
<pre><code>##      true     omit1     omit2     extra 
## 0.3996831 1.0281552 0.4005514 0.3995259</code></pre>
<p>この結果をみると、問題がある（推定値の平均が設定した処置効果である0.4から外れている）のはomit1だけである。それぞれのモデルから得られた係数betaの推定値の分布を図示してみよう。</p>
<p>正しいモデル (true)：</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="regression.html#cb302-1"></a>hist1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sim1_beta, <span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb302-2"><a href="regression.html#cb302-2"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;処置効果の推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb302-3"><a href="regression.html#cb302-3"></a>hist1_true &lt;-<span class="st"> </span>hist1 <span class="op">+</span><span class="st"> </span></span>
<span id="cb302-4"><a href="regression.html#cb302-4"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> true), <span class="dt">binwidth =</span> <span class="fl">0.1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb302-5"><a href="regression.html#cb302-5"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>)</span>
<span id="cb302-6"><a href="regression.html#cb302-6"></a><span class="kw">plot</span>(hist1_true)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-173-1.png" width="384" /></p>
<p>交絡変数が脱落したモデル (omit1)：</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="regression.html#cb303-1"></a>hist1_omit1 &lt;-<span class="st"> </span>hist1 <span class="op">+</span><span class="st"> </span></span>
<span id="cb303-2"><a href="regression.html#cb303-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> omit1), <span class="dt">binwidth =</span> <span class="fl">0.1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb303-3"><a href="regression.html#cb303-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>)</span>
<span id="cb303-4"><a href="regression.html#cb303-4"></a><span class="kw">plot</span>(hist1_omit1)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-174-1.png" width="384" /></p>
<p>交絡ではない変数を除いたモデル (omit2)：</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="regression.html#cb304-1"></a>hist1_omit2 &lt;-<span class="st"> </span>hist1 <span class="op">+</span><span class="st"> </span></span>
<span id="cb304-2"><a href="regression.html#cb304-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> omit2), <span class="dt">binwidth =</span> <span class="fl">0.1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb304-3"><a href="regression.html#cb304-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>)</span>
<span id="cb304-4"><a href="regression.html#cb304-4"></a><span class="kw">plot</span>(hist1_omit2)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-175-1.png" width="384" /></p>
<p>結果変数の原因ではない余分な変数を加えたモデル (extra)：</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="regression.html#cb305-1"></a>hist1_extra &lt;-<span class="st"> </span>hist1 <span class="op">+</span><span class="st"> </span></span>
<span id="cb305-2"><a href="regression.html#cb305-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> extra), <span class="dt">binwidth =</span> <span class="fl">0.1</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb305-3"><a href="regression.html#cb305-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>)</span>
<span id="cb305-4"><a href="regression.html#cb305-4"></a><span class="kw">plot</span>(hist1_extra)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-176-1.png" width="384" /></p>
<p>このシミュレーションから、交絡変数ではない原因を入れ損ねたり、原因ではない変数を入れてしまうのは問題ないが、交絡変数を説明変数に加え忘れると、平均して誤った分析結果を出してしまうことがわかる。したがって、<strong>交絡変数は必ず回帰分析に加える</strong>必要がある。</p>
<p>交絡を入れ損ねるとバイアスが生じ、関係ない変数を入れても問題がないのであれば、できるだけ多くの変数を統制したほうがよさそうである。実際、脱落変数バイアスを防ぐためには、できるだけたくさんの要因を統制した方がよい。ただし、手当たり次第に変数を投入すると起きる問題が（少なくとも）2つある。</p>
<p>まず、モデルが現実（真実）から乖離する確率が大きくなる。
この問題が起きるのは、モデルに含む説明変数が増えるにつれて、変数同士の関係のあり方のパタン（例えば、2変数以上の相互作用があるかどうか）が増えるのに対し、実際に正しいモデル（実際にデータが生成される過程）は1つしかないはずだからである。この問題は、ノンパラメトリックな方法を使えば回避することができる（今回は考えない）。</p>
<p>もう1つの問題は、処置後変数バイアスという異なる種類のバイアスが生じる可能性である。
この問題を次のシミュレーションで理解しよう。</p>
</div>
<div id="処置後変数バイアス" class="section level3" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> 処置後変数バイアス</h3>
<p>処置後変数バイアス (post-treatment variable bias) とは、処置変数 <span class="math inline">\(D\)</span> の影響を受けて生成される変数を説明変数として使うことによって生じるバイアスである。
処置後変数バイアスがあると、<span class="math inline">\(D\)</span> が <span class="math inline">\(Y\)</span> に及ぼす因果効果を正しく推定することができない。</p>
<p>以下のシミュレーションで、処置後変数バイアスを確認してみよう。</p>
<p>処置後変数 X を含むデータ生成過程を表す関数を作る。
D が Y に与える因果効果を beta、D が X に与える影響を gamma とする。</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="regression.html#cb306-1"></a>ptb_dgp &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">100</span>, <span class="dt">beta =</span> <span class="fl">0.4</span>, <span class="dt">gamma =</span> <span class="fl">0.2</span>) {</span>
<span id="cb306-2"><a href="regression.html#cb306-2"></a>    D &lt;-<span class="st"> </span><span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">.5</span>)</span>
<span id="cb306-3"><a href="regression.html#cb306-3"></a>    X &lt;-<span class="st"> </span><span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span>gamma <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.1</span>)</span>
<span id="cb306-4"><a href="regression.html#cb306-4"></a>    Y &lt;-<span class="st"> </span><span class="fl">0.2</span> <span class="op">+</span><span class="st"> </span>(beta <span class="op">/</span><span class="st"> </span>gamma) <span class="op">*</span><span class="st"> </span>X  <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.1</span>)</span>
<span id="cb306-5"><a href="regression.html#cb306-5"></a>    <span class="kw">return</span>(<span class="kw">tibble</span>(Y, D, X))</span>
<span id="cb306-6"><a href="regression.html#cb306-6"></a>}</span></code></pre></div>
<p>試しにデータセットを1つ作る。</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="regression.html#cb307-1"></a><span class="kw">set.seed</span>(<span class="dv">2020-06-12</span>)</span>
<span id="cb307-2"><a href="regression.html#cb307-2"></a>df_pt1 &lt;-<span class="st"> </span><span class="kw">ptb_dgp</span>()</span>
<span id="cb307-3"><a href="regression.html#cb307-3"></a><span class="kw">glimpse</span>(df_pt1)</span></code></pre></div>
<pre><code>## Observations: 100
## Variables: 3
## $ Y &lt;dbl&gt; 0.6508057, 1.0442136, 1.3875204, 0.7219868, 1.3689279, 1.27171…
## $ D &lt;int&gt; 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ X &lt;dbl&gt; 0.30434106, 0.42179182, 0.52854906, 0.24054385, 0.53575256, 0.…</code></pre>
<p>ここで、<span class="math inline">\(D\)</span> と <span class="math inline">\(X\)</span> の相関関係を確認してみよう。</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="regression.html#cb309-1"></a><span class="kw">with</span>(df_pt1, <span class="kw">cor</span>(D, X))</span></code></pre></div>
<pre><code>## [1] 0.6946692</code></pre>
<p><span class="math inline">\(D\)</span> と <span class="math inline">\(X\)</span> に正の相関があることがわかる。また、<span class="math inline">\(Y\)</span> と <span class="math inline">\(X\)</span> については、</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="regression.html#cb311-1"></a><span class="kw">with</span>(df_pt1, <span class="kw">cor</span>(Y, X))</span></code></pre></div>
<pre><code>## [1] 0.9449683</code></pre>
<p>となり、やはり強い正の相関がある。</p>
<p>ここで、「脱落変数バイアスを避けるため」（実際には、この考え方は誤りである）に、<span class="math inline">\(X\)</span> を説明変数に含む以下のモデルを考える。
<span class="math display">\[
Y_i = \alpha^p + \beta^p D_i + \lambda X_i + u_i.
\]</span>
このモデルのパラメタを推定してみよう。</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="regression.html#cb313-1"></a>fit_with &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X, <span class="dt">data =</span> df_pt1)</span>
<span id="cb313-2"><a href="regression.html#cb313-2"></a><span class="kw">tidy</span>(fit_with)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)   0.213     0.0336     6.33  7.64e- 9
## 2 D             0.0265    0.0268     0.991 3.24e- 1
## 3 X             1.96      0.0985    19.9   5.58e-36</code></pre>
<p>推定値を見ると、Dの係数 <span class="math inline">\(\beta\)</span> は0.03 であり、正しい値である 0.4 よりも過小推定されている。</p>
<p>ここで、説明変数 <span class="math inline">\(X\)</span> を除外して、以下のモデルを考えてみよう。
<span class="math display">\[
Y_i = \alpha + \beta D_i + e_i.
\]</span>
このモデルのパラメタを推定しよう。</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="regression.html#cb315-1"></a>fit_wo &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df_pt1)</span>
<span id="cb315-2"><a href="regression.html#cb315-2"></a><span class="kw">tidy</span>(fit_wo)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)    0.831    0.0289     28.7  1.64e-49
## 2 D              0.396    0.0431      9.18 7.26e-15</code></pre>
<p>コントロール変数 <span class="math inline">\(X\)</span> を除外したことにより、<span class="math inline">\(\beta\)</span> の推定値 0.4 となり、設定した値である 0.4 に近づいた。これは偶然だろうか？シミュレーションで確かめてみよう。</p>
<p>1回シミュレーションを実行し、処置後変数を含むモデルと含まないモデルの係数の推定値を返す関数を作る。</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="regression.html#cb317-1"></a>sim_ptb &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">100</span>, <span class="dt">beta =</span> <span class="fl">0.4</span>, <span class="dt">gamma =</span> <span class="fl">0.2</span>) {</span>
<span id="cb317-2"><a href="regression.html#cb317-2"></a>    df &lt;-<span class="st"> </span><span class="kw">ptb_dgp</span>(<span class="dt">N =</span> N, <span class="dt">beta =</span> beta, <span class="dt">gamma =</span> gamma)</span>
<span id="cb317-3"><a href="regression.html#cb317-3"></a>    fit_with &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X, <span class="dt">data =</span> df)</span>
<span id="cb317-4"><a href="regression.html#cb317-4"></a>    fit_wo &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df)</span>
<span id="cb317-5"><a href="regression.html#cb317-5"></a>    betas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">coef</span>(fit_with)[<span class="dv">2</span>], <span class="kw">coef</span>(fit_wo)[<span class="dv">2</span>])</span>
<span id="cb317-6"><a href="regression.html#cb317-6"></a>    <span class="kw">names</span>(betas) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;with&#39;</span>, <span class="st">&#39;without&#39;</span>)</span>
<span id="cb317-7"><a href="regression.html#cb317-7"></a>    <span class="kw">return</span>(betas)</span>
<span id="cb317-8"><a href="regression.html#cb317-8"></a>}</span></code></pre></div>
<p>この関数を、<code>replicate()</code> で複数回実行する。1000回繰り返してみよう。</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="regression.html#cb318-1"></a>sim_ptb &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_ptb</span>())</span></code></pre></div>
<p>結果をヒストグラムで確認する。</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="regression.html#cb319-1"></a>df_beta_ptb &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">with =</span> sim_ptb[<span class="dv">1</span>, ],</span>
<span id="cb319-2"><a href="regression.html#cb319-2"></a>                      <span class="dt">without =</span> sim_ptb[<span class="dv">2</span>, ]) </span>
<span id="cb319-3"><a href="regression.html#cb319-3"></a>hist2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df_beta_ptb,  <span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb319-4"><a href="regression.html#cb319-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;処置効果の推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb319-5"><a href="regression.html#cb319-5"></a>hist2_with &lt;-<span class="st"> </span>hist2 <span class="op">+</span></span>
<span id="cb319-6"><a href="regression.html#cb319-6"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> with), <span class="dt">binwidth =</span> <span class="fl">0.025</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb319-7"><a href="regression.html#cb319-7"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>) <span class="op">+</span></span>
<span id="cb319-8"><a href="regression.html#cb319-8"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;処置後変数を含むモデル&quot;</span>)</span>
<span id="cb319-9"><a href="regression.html#cb319-9"></a>hist2_wo &lt;-<span class="st"> </span>hist2 <span class="op">+</span></span>
<span id="cb319-10"><a href="regression.html#cb319-10"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> without), <span class="dt">binwidth =</span> <span class="fl">0.025</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb319-11"><a href="regression.html#cb319-11"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.4</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>) <span class="op">+</span></span>
<span id="cb319-12"><a href="regression.html#cb319-12"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;処置後変数を含まないモデル&quot;</span>)</span>
<span id="cb319-13"><a href="regression.html#cb319-13"></a><span class="kw">plot</span>(hist2_with <span class="op">+</span><span class="st"> </span>hist2_wo)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-185-1.png" width="576" /></p>
<p>このように、ある処置変数 <span class="math inline">\(D\)</span> の効果を推定したいとき、その変数の結果として出てくる変数を<strong>統制してはいけない</strong>。変数間に時間的な前後関係があれば、このバイアスを回避するのは比較的容易である。しかし、時間的な前後関係が不明なとき、ある変数が交絡変数か処置後変数かを見抜くのは難しい場合がある。調査・観察データを分析する場合だけでなく、実験においてもこのバイアスには注意が必要である <span class="citation">(Montgomery, Nyhan, and Torres <a href="#ref-montgomery2018" role="doc-biblioref">2018</a>)</span>。</p>
<p>統計モデルを作るときには、自分が統制する変数は交絡であり、処置後変数ではないことを<strong>理論的</strong>に示すことが求められる。そのためには、<strong>実質科学的知見（経済学や経営学など、分析対象に関するドメイン知識）が必須</strong>である。</p>
</div>
</div>
<div id="dag有向非巡回グラフ" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> DAG（有向非巡回グラフ）</h2>
<p>DAG (irected acyclic graph, 有向非巡回グラフ) をR で描く方法を簡単に説明する。</p>
<p>R で DAG を描くために、<strong>dagitty</strong> と<strong>ggdag</strong> の2つのパッケージを使う。どちらか片方だけでもDAG は描けるが、両方使えると便利である。</p>
<p>まず、<strong>dagitty</strong> だけで描いてみる。<code>daggity::dagitty()</code> で DAG を定義し、それぞれの変数の位置を
<code>dagitty::coordinates()</code> で指定する。</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="regression.html#cb320-1"></a>dag_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{D -&gt; Y; X -&gt; D; X -&gt; Y}&quot;</span>)</span>
<span id="cb320-2"><a href="regression.html#cb320-2"></a><span class="kw">coordinates</span>(dag_<span class="dv">1</span>) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">X =</span> <span class="dv">1</span>, <span class="dt">Y =</span> <span class="dv">2</span>),</span>
<span id="cb320-3"><a href="regression.html#cb320-3"></a>                           <span class="dt">y =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">X =</span> <span class="dv">1</span>, <span class="dt">Y =</span> <span class="dv">0</span>))</span>
<span id="cb320-4"><a href="regression.html#cb320-4"></a><span class="kw">plot</span>(dag_<span class="dv">1</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-186-1.png" width="288" /></p>
<p>同じ DAG を描くための dag の指定法はいろいろ考えられる。例えば、次のようにしても同じ図ができる。</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="regression.html#cb321-1"></a>dag_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{D &lt;- X -&gt; Y; D -&gt; Y}&quot;</span>)</span>
<span id="cb321-2"><a href="regression.html#cb321-2"></a><span class="kw">coordinates</span>(dag_<span class="dv">2</span>) &lt;-<span class="st"> </span><span class="kw">coordinates</span>(dag_<span class="dv">1</span>)</span>
<span id="cb321-3"><a href="regression.html#cb321-3"></a><span class="kw">plot</span>(dag_<span class="dv">2</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-187-1.png" width="288" /></p>
<p>あるいは、次のようにしても同じ図ができる。</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="regression.html#cb322-1"></a>dag_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{X -&gt; {D Y}; D -&gt; Y}&quot;</span>)</span>
<span id="cb322-2"><a href="regression.html#cb322-2"></a><span class="kw">coordinates</span>(dag_<span class="dv">3</span>) &lt;-<span class="st"> </span><span class="kw">coordinates</span>(dag_<span class="dv">1</span>)</span>
<span id="cb322-3"><a href="regression.html#cb322-3"></a><span class="kw">plot</span>(dag_<span class="dv">3</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-188-1.png" width="288" /></p>
<p>変数の役割を指定することもできる。その際、処置は <code>exposure</code>（暴露）、結果は <code>outcome</code>、未観測の変数は <code>unobserved</code> とする。</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="regression.html#cb323-1"></a>dag_<span class="dv">4</span> &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{</span></span>
<span id="cb323-2"><a href="regression.html#cb323-2"></a><span class="st">  X -&gt; {D Y}; D -&gt; Y</span></span>
<span id="cb323-3"><a href="regression.html#cb323-3"></a><span class="st">  D [exposure]</span></span>
<span id="cb323-4"><a href="regression.html#cb323-4"></a><span class="st">  Y [outcome]</span></span>
<span id="cb323-5"><a href="regression.html#cb323-5"></a><span class="st">  X [unobserved]</span></span>
<span id="cb323-6"><a href="regression.html#cb323-6"></a><span class="st">}&quot;</span>)</span>
<span id="cb323-7"><a href="regression.html#cb323-7"></a><span class="kw">coordinates</span>(dag_<span class="dv">4</span>) &lt;-<span class="st"> </span><span class="kw">coordinates</span>(dag_<span class="dv">1</span>)</span>
<span id="cb323-8"><a href="regression.html#cb323-8"></a><span class="kw">plot</span>(dag_<span class="dv">4</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-189-1.png" width="288" /></p>
<p>これを、<code>ggdag::tidy_dagitty</code> で tidy なデータに変換する。</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="regression.html#cb324-1"></a>tidy_dag_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">tidy_dagitty</span>(dag_<span class="dv">4</span>)</span></code></pre></div>
<p><code>ggdag::ggdag()</code> で ggplot風のDAGを描く。</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="regression.html#cb325-1"></a><span class="kw">ggdag</span>(tidy_dag_<span class="dv">1</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-191-1.png" width="384" /></p>
<p>テーマを <code>theme_dag()</code> に変える。</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="regression.html#cb326-1"></a><span class="kw">ggdag</span>(tidy_dag_<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-192-1.png" width="384" /></p>
<p>dagitty を使わずに、<code>ggdag::dagify()</code> でDAG を描くこともできる。ggdag でDAG を描くときは、各ノードの座標はしてしなくても良い（勝手に決めてくれる）。</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="regression.html#cb327-1"></a>tidy_dag_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">dagify</span>(</span>
<span id="cb327-2"><a href="regression.html#cb327-2"></a>  Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X,</span>
<span id="cb327-3"><a href="regression.html#cb327-3"></a>  D <span class="op">~</span><span class="st"> </span>Z,</span>
<span id="cb327-4"><a href="regression.html#cb327-4"></a>  X <span class="op">~</span><span class="st"> </span>Z,</span>
<span id="cb327-5"><a href="regression.html#cb327-5"></a>  <span class="dt">exposure =</span> <span class="st">&quot;D&quot;</span>, <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb327-6"><a href="regression.html#cb327-6"></a>  <span class="dt">outcome =</span> <span class="st">&quot;Y&quot;</span>   <span class="co"># 結果変数を指定</span></span>
<span id="cb327-7"><a href="regression.html#cb327-7"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb327-8"><a href="regression.html#cb327-8"></a><span class="st">  </span><span class="kw">tidy_dagitty</span>() </span>
<span id="cb327-9"><a href="regression.html#cb327-9"></a><span class="kw">ggdag</span>(tidy_dag_<span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-193-1.png" width="384" /></p>
<p>この DAG から、処置 D と 結果 Y の間には交絡因子があることがわかる。
では、どの変数を重回帰に含めれば良いだろうか？
<code>ggdag::ggdag_adjustment_set()</code> で明らかにすることができる。</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="regression.html#cb328-1"></a><span class="kw">ggdag_adjustment_set</span>(tidy_dag_<span class="dv">2</span>) </span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-194-1.png" width="576" /></p>
<p>“adjusted” とされている変数を重回帰に含めると、そこで経路が塞がれ、バックドア経路が断ち切られることがわかる。ここでは、X または Z をコントロールすれば良いことがわかる。</p>
<p>Z が未観測だったらどうなるだろうか？</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="regression.html#cb329-1"></a>tidy_dag_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">dagify</span>(</span>
<span id="cb329-2"><a href="regression.html#cb329-2"></a>  Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X,</span>
<span id="cb329-3"><a href="regression.html#cb329-3"></a>  D <span class="op">~</span><span class="st"> </span>Z,</span>
<span id="cb329-4"><a href="regression.html#cb329-4"></a>  X <span class="op">~</span><span class="st"> </span>Z,</span>
<span id="cb329-5"><a href="regression.html#cb329-5"></a>  <span class="dt">exposure =</span> <span class="st">&quot;D&quot;</span>,  <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb329-6"><a href="regression.html#cb329-6"></a>  <span class="dt">outcome =</span> <span class="st">&quot;Y&quot;</span>,   <span class="co"># 結果変数を指定</span></span>
<span id="cb329-7"><a href="regression.html#cb329-7"></a>  <span class="dt">latent =</span> <span class="st">&quot;Z&quot;</span>,    <span class="co"># 未観測（潜在 [latent]）変数を指定</span></span>
<span id="cb329-8"><a href="regression.html#cb329-8"></a>  <span class="dt">coords =</span> <span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">Y =</span> <span class="dv">1</span>, <span class="dt">Z =</span> <span class="dv">0</span>, <span class="dt">X =</span> <span class="dv">1</span>),</span>
<span id="cb329-9"><a href="regression.html#cb329-9"></a>                <span class="dt">y =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">Y =</span> <span class="dv">0</span>, <span class="dt">Z =</span> <span class="dv">1</span>, <span class="dt">X =</span> <span class="dv">1</span>))</span>
<span id="cb329-10"><a href="regression.html#cb329-10"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb329-11"><a href="regression.html#cb329-11"></a><span class="st">  </span><span class="kw">tidy_dagitty</span>() </span>
<span id="cb329-12"><a href="regression.html#cb329-12"></a><span class="kw">ggdag</span>(tidy_dag_<span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-195-1.png" width="384" /></p>
<p><code>coord</code> で各変数 (node) の座標を指定した以外、DAG自体には変化がない。
コントロールすべき変数はどれだろうか？</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="regression.html#cb330-1"></a><span class="kw">ggdag_adjustment_set</span>(tidy_dag_<span class="dv">3</span>)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-196-1.png" width="480" /></p>
<p>先ほどとは異なり、Z は未観測でコントロールできないので、X だけが候補としてあげられる。</p>
<p>複数のコントロールが必要な場合は次のようになる。</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="regression.html#cb331-1"></a>tidy_dag_<span class="dv">4</span> &lt;-<span class="st"> </span><span class="kw">dagify</span>(</span>
<span id="cb331-2"><a href="regression.html#cb331-2"></a>  Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2,</span>
<span id="cb331-3"><a href="regression.html#cb331-3"></a>  D <span class="op">~</span><span class="st"> </span>L <span class="op">+</span><span class="st"> </span>X2,</span>
<span id="cb331-4"><a href="regression.html#cb331-4"></a>  X1 <span class="op">~</span><span class="st"> </span>L,</span>
<span id="cb331-5"><a href="regression.html#cb331-5"></a>  <span class="dt">outcome =</span> <span class="st">&quot;Y&quot;</span>,</span>
<span id="cb331-6"><a href="regression.html#cb331-6"></a>  <span class="dt">exposure =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb331-7"><a href="regression.html#cb331-7"></a>  <span class="dt">latent =</span> <span class="st">&quot;L&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb331-8"><a href="regression.html#cb331-8"></a><span class="st">  </span><span class="kw">tidy_dagitty</span>()</span>
<span id="cb331-9"><a href="regression.html#cb331-9"></a><span class="kw">ggdag</span>(tidy_dag_<span class="dv">4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-197-1.png" width="384" /></p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="regression.html#cb332-1"></a><span class="kw">ggdag_adjustment_set</span>(tidy_dag_<span class="dv">4</span>) </span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-198-1.png" width="576" /></p>
<p>X1 と X2 の両者をコントロールする必要があることがわかる。</p>
<p>次に、処置後変数がある DAG を作り、コントロールすべきかどうか調べてみよう。</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="regression.html#cb333-1"></a>dag_pt1 &lt;-<span class="st"> </span><span class="kw">dagitty</span>(<span class="st">&quot;dag{</span></span>
<span id="cb333-2"><a href="regression.html#cb333-2"></a><span class="st">  D -&gt; X -&gt; Y; D -&gt; Y</span></span>
<span id="cb333-3"><a href="regression.html#cb333-3"></a><span class="st">  D [exposure]</span></span>
<span id="cb333-4"><a href="regression.html#cb333-4"></a><span class="st">  Y [outcome]</span></span>
<span id="cb333-5"><a href="regression.html#cb333-5"></a><span class="st">}&quot;</span>) </span>
<span id="cb333-6"><a href="regression.html#cb333-6"></a><span class="kw">coordinates</span>(dag_pt1) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">Y =</span> <span class="dv">2</span>, <span class="dt">X =</span> <span class="dv">1</span>),</span>
<span id="cb333-7"><a href="regression.html#cb333-7"></a>                             <span class="dt">y =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">Y =</span> <span class="dv">0</span>, <span class="dt">X =</span> <span class="dv">1</span>))</span>
<span id="cb333-8"><a href="regression.html#cb333-8"></a>tidy_dag_pt1 &lt;-<span class="st"> </span><span class="kw">tidy_dagitty</span>(dag_pt1)</span>
<span id="cb333-9"><a href="regression.html#cb333-9"></a><span class="kw">ggdag</span>(tidy_dag_pt1) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-199-1.png" width="384" /></p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="regression.html#cb334-1"></a><span class="kw">ggdag_adjustment_set</span>(tidy_dag_pt1) </span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-200-1.png" width="576" /></p>
<p>“Backdoor Paths Unconditionally Closed” （コントロールなしでバックドアは閉じています）と表示され、X　をコントールする必要がないことがわかる。</p>
<p>次のような場合はどうだろうか？</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="regression.html#cb335-1"></a>tidy_dag_pt2 &lt;-<span class="st"> </span><span class="kw">dagify</span>(</span>
<span id="cb335-2"><a href="regression.html#cb335-2"></a>  Y <span class="op">~</span><span class="st"> </span>D,</span>
<span id="cb335-3"><a href="regression.html#cb335-3"></a>  X <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>Y,</span>
<span id="cb335-4"><a href="regression.html#cb335-4"></a>  <span class="dt">exposure =</span> <span class="st">&quot;D&quot;</span>,</span>
<span id="cb335-5"><a href="regression.html#cb335-5"></a>  <span class="dt">outcome =</span> <span class="st">&quot;Y&quot;</span>,</span>
<span id="cb335-6"><a href="regression.html#cb335-6"></a>  <span class="dt">coords =</span> <span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">0</span>, <span class="dt">Y =</span> <span class="dv">2</span>, <span class="dt">X =</span> <span class="dv">1</span>),</span>
<span id="cb335-7"><a href="regression.html#cb335-7"></a>                <span class="dt">y =</span> <span class="kw">c</span>(<span class="dt">D =</span> <span class="dv">1</span>, <span class="dt">Y =</span> <span class="dv">1</span>, <span class="dt">X =</span> <span class="dv">0</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb335-8"><a href="regression.html#cb335-8"></a><span class="st">  </span><span class="kw">tidy_dagitty</span>()</span>
<span id="cb335-9"><a href="regression.html#cb335-9"></a><span class="kw">ggdag</span>(tidy_dag_pt2) <span class="op">+</span><span class="st"> </span><span class="kw">theme_dag</span>()</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-201-1.png" width="384" /></p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="regression.html#cb336-1"></a><span class="kw">ggdag_adjustment_set</span>(tidy_dag_pt2) </span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-202-1.png" width="576" />
先ほどと同様に、“Backdoor Paths Unconditionally Closed” （コントロールなしでバックドアは閉じています）と表示され、X をコントールする必要がないことがわかる。</p>
<p>さらに詳しい説明は、<strong>dagitty</strong> と <strong>ggdag</strong> の公式サイトと Michael Taylor氏による解説を参照されたい。</p>
<ul>
<li><a href="http://dagitty.net/">DAGitty</a></li>
<li><a href="https://ggdag.malco.io/">ggdag</a></li>
<li>“<a href="http://michaelntaylor.ca/post/2018/06/01/ggdag/">An Introduction to Directed Acyclic Graphs</a>” by Michael Taylor</li>
</ul>
</div>
<div id="トピック4の課題" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> トピック4の課題</h2>
<p>以下の2つを実行しなさい。</p>
<ol style="list-style-type: decimal">
<li>回帰分析のシミュレーション</li>
</ol>
<ul>
<li>上で行ったシミュレーションから1つ以上を取り上げ、シミュレーションの設定を変えて（例：gamma の値を変える）実行しなさい。</li>
<li>シミュレーションの結果からどのようなことを学んだか、簡潔に説明しなさい。</li>
<li><strong>シミュレーション結果は、図または表にまとめること</strong>。</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>コントロール変数の選択</li>
</ol>
<ul>
<li>以下の図と同じ構造のDAGを作りなさい。</li>
<li>作ったDAG を利用して、重回帰分析によって D が Y に与える処置効果を推定するためにどの変数をコントロールすべきか答えなさい。
<img src="kut-metrics2_files/figure-html/unnamed-chunk-203-1.png" width="480" /></li>
</ul>
<p><strong>注意事項</strong></p>
<ul>
<li>課題レポートは R Markdown で作成し、PDF に knit して提出すること。</li>
<li>提出するファイル：metrics_hw04_LastFirst.pdf
<ul>
<li>提出する課題としては2つ目だが、ファイル名の番号はトピックに合わせる。</li>
</ul></li>
<li>提出方法：Slack のダイレクトメッセージで提出。</li>
<li><strong>提出期限：2020年6月29日（月）正午</strong>（日本時間）</li>
</ul>

</div>
</div>
<h3>参考文献</h3>
<div id="refs" class="references">
<div id="ref-ang2009">
<p>Angrist, Joshua D., and Jörn-Steffen Pischke. 2009. <em>Mostly Harmless Econometrics: An Empiricist’s Companion</em>. Princeton: Princeton University Press.</p>
</div>
<div id="ref-hansen2020">
<p>Hansen, Bruce E. 2020. <em>Econometrics</em>. University of Wisconsin. <a href="https://www.ssc.wisc.edu/~bhansen/econometrics/">https://www.ssc.wisc.edu/~bhansen/econometrics/</a>.</p>
</div>
<div id="ref-montgomery2018">
<p>Montgomery, Jacob M., Brendan Nyhan, and Michelle Torres. 2018. “How Conditioning on Posttreatment Variables Can Ruin Your Experiment and What to Do About It.” <em>American Journal of Political Science</em> 62 (3): 760–75. <a href="https://doi.org/10.1111/ajps.12357">https://doi.org/10.1111/ajps.12357</a>.</p>
</div>
<div id="ref-yasui2020">
<p>安井翔太. 2020. <em>効果検証入門：正しい比較のための因果推論/計量経済学の基礎</em>. 技術評論社.</p>
</div>
<div id="ref-sueishi2015">
<p>末石直也. 2015. <em>計量経済学：ミクロデータ分析へのいざない</em>. 日本評論社.</p>
</div>
<div id="ref-asano-yanai2018">
<p>浅野正彦, and 矢内勇生. 2018. <em>Rによる計量政治学</em>. オーム社. <a href="https://github.com/yukiyanai/quant-methods-R">https://github.com/yukiyanai/quant-methods-R</a>.</p>
</div>
<div id="ref-nawata2013">
<p>縄田和満. 2013. <em>確率・統計 I</em>. 丸善出版.</p>
</div>
<div id="ref-nishiyama2019">
<p>西山慶彦, 新谷元嗣, 川口大司, and 奥井亮. 2019. <em>計量経済学</em>. 有斐閣.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="RCT.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="propensity-score.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
