<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Topic 9 操作変数法 | KUT 計量経済学応用</title>
  <meta name="description" content="Topic 9 操作変数法 | KUT 計量経済学応用" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Topic 9 操作変数法 | KUT 計量経済学応用" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Topic 9 操作変数法 | KUT 計量経済学応用" />
  
  
  

<meta name="author" content="矢内 勇生" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="regression-discontinuity.html"/>
<link rel="next" href="final-presentation.html"/>
<script src="libs/header-attrs-2.2/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.11/datatables.js"></script>
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.19/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">KUT 計量経済学応用</a></li>
<li><a href="https://yukiyanai.github.io/" target="_blank">矢内 勇生 (Yuki Yanai)</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>はじめに</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#この資料について"><i class="fa fa-check"></i><b>0.1</b> この資料について</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#履修条件"><i class="fa fa-check"></i><b>0.2</b> 履修条件</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#r-とrstudio-のインストール"><i class="fa fa-check"></i><b>0.3</b> R とRStudio のインストール</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#授業計画"><i class="fa fa-check"></i><b>0.4</b> 授業計画</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> イントロダクション</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#予習と講義動画の視聴"><i class="fa fa-check"></i><b>1.1</b> 予習と講義動画の視聴</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#slack"><i class="fa fa-check"></i><b>1.2</b> Slack</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="introduction.html"><a href="introduction.html#slack-とは"><i class="fa fa-check"></i><b>1.2.1</b> Slack とは？</a></li>
<li class="chapter" data-level="1.2.2" data-path="introduction.html"><a href="introduction.html#授業用ワークスペースへの登録"><i class="fa fa-check"></i><b>1.2.2</b> 授業用ワークスペースへの登録</a></li>
<li class="chapter" data-level="1.2.3" data-path="introduction.html"><a href="introduction.html#利用上の注意"><i class="fa fa-check"></i><b>1.2.3</b> 利用上の注意</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#rstudio-cloud-の初期設定"><i class="fa fa-check"></i><b>1.3</b> RStudio Cloud の初期設定</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#ユーザ登録"><i class="fa fa-check"></i><b>1.3.1</b> ユーザ登録</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#授業用のプロジェクトを作る"><i class="fa fa-check"></i><b>1.3.2</b> 授業用のプロジェクトを作る</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#rstudio-のカスタマイズ"><i class="fa fa-check"></i><b>1.3.3</b> RStudio のカスタマイズ</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#パッケージのインストール"><i class="fa fa-check"></i><b>1.3.4</b> パッケージのインストール</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#ディレクトリの作成"><i class="fa fa-check"></i><b>1.3.5</b> ディレクトリの作成</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#図で日本語が使えるようにする"><i class="fa fa-check"></i><b>1.3.6</b> 図で日本語が使えるようにする</a></li>
<li class="chapter" data-level="1.3.7" data-path="introduction.html"><a href="introduction.html#r-markdown-からpdfファイルを作る"><i class="fa fa-check"></i><b>1.3.7</b> R Markdown からPDFファイルを作る</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#トピック1の課題"><i class="fa fa-check"></i><b>1.4</b> トピック1の課題</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="selection-bias.html"><a href="selection-bias.html"><i class="fa fa-check"></i><b>2</b> セレクションバイアス</a>
<ul>
<li class="chapter" data-level="2.1" data-path="selection-bias.html"><a href="selection-bias.html#準備"><i class="fa fa-check"></i><b>2.1</b> 準備</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="selection-bias.html"><a href="selection-bias.html#予習講義動画実習課題"><i class="fa fa-check"></i><b>2.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="2.1.2" data-path="selection-bias.html"><a href="selection-bias.html#rパッケージの読み込み"><i class="fa fa-check"></i><b>2.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="2.1.3" data-path="selection-bias.html"><a href="selection-bias.html#このトピックで使うrコードの説明"><i class="fa fa-check"></i><b>2.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="selection-bias.html"><a href="selection-bias.html#セレクションバイアスのシミュレーション"><i class="fa fa-check"></i><b>2.2</b> セレクションバイアスのシミュレーション</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="selection-bias.html"><a href="selection-bias.html#メールによる販促の効果"><i class="fa fa-check"></i><b>2.2.1</b> メールによる販促の効果</a></li>
<li class="chapter" data-level="2.2.2" data-path="selection-bias.html"><a href="selection-bias.html#通院と健康状態セルフセレクション"><i class="fa fa-check"></i><b>2.2.2</b> 通院と健康状態：セルフセレクション</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="selection-bias.html"><a href="selection-bias.html#トピック2の課題"><i class="fa fa-check"></i><b>2.3</b> トピック2の課題</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="RCT.html"><a href="RCT.html"><i class="fa fa-check"></i><b>3</b> RCT（ランダム化比較試験）</a>
<ul>
<li class="chapter" data-level="3.1" data-path="RCT.html"><a href="RCT.html#準備-1"><i class="fa fa-check"></i><b>3.1</b> 準備</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="RCT.html"><a href="RCT.html#予習講義動画実習課題-1"><i class="fa fa-check"></i><b>3.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="3.1.2" data-path="RCT.html"><a href="RCT.html#rパッケージの読み込み-1"><i class="fa fa-check"></i><b>3.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="3.1.3" data-path="RCT.html"><a href="RCT.html#このトピックで使うrコードの説明-1"><i class="fa fa-check"></i><b>3.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="RCT.html"><a href="RCT.html#ランダム化のシミュレーション"><i class="fa fa-check"></i><b>3.2</b> ランダム化のシミュレーション</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="RCT.html"><a href="RCT.html#母集団の設定"><i class="fa fa-check"></i><b>3.2.1</b> 母集団の設定</a></li>
<li class="chapter" data-level="3.2.2" data-path="RCT.html"><a href="RCT.html#ベルヌーイ実験"><i class="fa fa-check"></i><b>3.2.2</b> ベルヌーイ実験</a></li>
<li class="chapter" data-level="3.2.3" data-path="RCT.html"><a href="RCT.html#完全ランダム化実験"><i class="fa fa-check"></i><b>3.2.3</b> 完全ランダム化実験</a></li>
<li class="chapter" data-level="3.2.4" data-path="RCT.html"><a href="RCT.html#ブロック別ランダム化実験"><i class="fa fa-check"></i><b>3.2.4</b> ブロック別ランダム化実験</a></li>
<li class="chapter" data-level="3.2.5" data-path="RCT.html"><a href="RCT.html#ペア毎のランダム化実験"><i class="fa fa-check"></i><b>3.2.5</b> ペア毎のランダム化実験</a></li>
<li class="chapter" data-level="3.2.6" data-path="RCT.html"><a href="RCT.html#つのrct-を比較する"><i class="fa fa-check"></i><b>3.2.6</b> 4つのRCT を比較する</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="RCT.html"><a href="RCT.html#トピック3の課題"><i class="fa fa-check"></i><b>3.3</b> トピック3の課題</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regression.html"><a href="regression.html"><i class="fa fa-check"></i><b>4</b> 回帰分析</a>
<ul>
<li class="chapter" data-level="4.1" data-path="regression.html"><a href="regression.html#準備-2"><i class="fa fa-check"></i><b>4.1</b> 準備</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="regression.html"><a href="regression.html#予習講義動画実習課題-2"><i class="fa fa-check"></i><b>4.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="4.1.2" data-path="regression.html"><a href="regression.html#rパッケージの読み込み-2"><i class="fa fa-check"></i><b>4.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="4.1.3" data-path="regression.html"><a href="regression.html#関数の自作"><i class="fa fa-check"></i><b>4.1.3</b> 関数の自作</a></li>
<li class="chapter" data-level="4.1.4" data-path="regression.html"><a href="regression.html#このトピックで使うrコードの説明-2"><i class="fa fa-check"></i><b>4.1.4</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="regression.html"><a href="regression.html#回帰分析のシミュレーション"><i class="fa fa-check"></i><b>4.2</b> 回帰分析のシミュレーション</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="regression.html"><a href="regression.html#単回帰"><i class="fa fa-check"></i><b>4.2.1</b> 単回帰</a></li>
<li class="chapter" data-level="4.2.2" data-path="regression.html"><a href="regression.html#重回帰"><i class="fa fa-check"></i><b>4.2.2</b> 重回帰</a></li>
<li class="chapter" data-level="4.2.3" data-path="regression.html"><a href="regression.html#重回帰によるブロッキング"><i class="fa fa-check"></i><b>4.2.3</b> 重回帰によるブロッキング</a></li>
<li class="chapter" data-level="4.2.4" data-path="regression.html"><a href="regression.html#重回帰分析によるセレクションバイアスの除去"><i class="fa fa-check"></i><b>4.2.4</b> 重回帰分析によるセレクションバイアスの除去</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="regression.html"><a href="regression.html#脱落変数バイアスと処置後変数バイアス"><i class="fa fa-check"></i><b>4.3</b> 脱落変数バイアスと処置後変数バイアス</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="regression.html"><a href="regression.html#脱落変数バイアス-ovb"><i class="fa fa-check"></i><b>4.3.1</b> 脱落変数バイアス (OVB)</a></li>
<li class="chapter" data-level="4.3.2" data-path="regression.html"><a href="regression.html#処置後変数バイアス"><i class="fa fa-check"></i><b>4.3.2</b> 処置後変数バイアス</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="regression.html"><a href="regression.html#dag有向非巡回グラフ"><i class="fa fa-check"></i><b>4.4</b> DAG（有向非巡回グラフ）</a></li>
<li class="chapter" data-level="4.5" data-path="regression.html"><a href="regression.html#トピック4の課題"><i class="fa fa-check"></i><b>4.5</b> トピック4の課題</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="propensity-score.html"><a href="propensity-score.html"><i class="fa fa-check"></i><b>5</b> 傾向スコア</a>
<ul>
<li class="chapter" data-level="5.1" data-path="propensity-score.html"><a href="propensity-score.html#準備-3"><i class="fa fa-check"></i><b>5.1</b> 準備</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="propensity-score.html"><a href="propensity-score.html#予習講義動画実習課題-3"><i class="fa fa-check"></i><b>5.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="5.1.2" data-path="propensity-score.html"><a href="propensity-score.html#rパッケージの読み込み-3"><i class="fa fa-check"></i><b>5.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="5.1.3" data-path="propensity-score.html"><a href="propensity-score.html#関数の自作-1"><i class="fa fa-check"></i><b>5.1.3</b> 関数の自作</a></li>
<li class="chapter" data-level="5.1.4" data-path="propensity-score.html"><a href="propensity-score.html#このトピックで使うrコードの説明-3"><i class="fa fa-check"></i><b>5.1.4</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="propensity-score.html"><a href="propensity-score.html#傾向スコアを用いた因果推論の手順"><i class="fa fa-check"></i><b>5.2</b> 傾向スコアを用いた因果推論の手順</a></li>
<li class="chapter" data-level="5.3" data-path="propensity-score.html"><a href="propensity-score.html#共変量の選定"><i class="fa fa-check"></i><b>5.3</b> 共変量の選定</a></li>
<li class="chapter" data-level="5.4" data-path="propensity-score.html"><a href="propensity-score.html#傾向スコアの推定"><i class="fa fa-check"></i><b>5.4</b> 傾向スコアの推定</a></li>
<li class="chapter" data-level="5.5" data-path="propensity-score.html"><a href="propensity-score.html#バランス調整バランスチェック因果効果の推定"><i class="fa fa-check"></i><b>5.5</b> バランス調整、バランスチェック、因果効果の推定</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="propensity-score.html"><a href="propensity-score.html#重み付け"><i class="fa fa-check"></i><b>5.5.1</b> 重み付け</a></li>
<li class="chapter" data-level="5.5.2" data-path="propensity-score.html"><a href="propensity-score.html#層別"><i class="fa fa-check"></i><b>5.5.2</b> 層別</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="propensity-score.html"><a href="propensity-score.html#トピック5-の課題"><i class="fa fa-check"></i><b>5.6</b> トピック5 の課題</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="difference-in-differences.html"><a href="difference-in-differences.html"><i class="fa fa-check"></i><b>6</b> 差分の差分法</a>
<ul>
<li class="chapter" data-level="6.1" data-path="difference-in-differences.html"><a href="difference-in-differences.html#準備-4"><i class="fa fa-check"></i><b>6.1</b> 準備</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="difference-in-differences.html"><a href="difference-in-differences.html#予習講義動画実習課題-4"><i class="fa fa-check"></i><b>6.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="6.1.2" data-path="difference-in-differences.html"><a href="difference-in-differences.html#rパッケージの読み込み-4"><i class="fa fa-check"></i><b>6.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="6.1.3" data-path="difference-in-differences.html"><a href="difference-in-differences.html#このトピックで使うrコードの説明-4"><i class="fa fa-check"></i><b>6.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="difference-in-differences.html"><a href="difference-in-differences.html#最低賃金の影響"><i class="fa fa-check"></i><b>6.2</b> 最低賃金の影響</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="difference-in-differences.html"><a href="difference-in-differences.html#card-and-krueger-1994-の研究"><i class="fa fa-check"></i><b>6.2.1</b> Card and Krueger (1994) の研究</a></li>
<li class="chapter" data-level="6.2.2" data-path="difference-in-differences.html"><a href="difference-in-differences.html#処置の確認"><i class="fa fa-check"></i><b>6.2.2</b> 処置の確認</a></li>
<li class="chapter" data-level="6.2.3" data-path="difference-in-differences.html"><a href="difference-in-differences.html#単純比較-i-個体間比較"><i class="fa fa-check"></i><b>6.2.3</b> 単純比較 I： 個体間比較</a></li>
<li class="chapter" data-level="6.2.4" data-path="difference-in-differences.html"><a href="difference-in-differences.html#単純比較-ii前後比較"><i class="fa fa-check"></i><b>6.2.4</b> 単純比較 II：前後比較</a></li>
<li class="chapter" data-level="6.2.5" data-path="difference-in-differences.html"><a href="difference-in-differences.html#did"><i class="fa fa-check"></i><b>6.2.5</b> DID</a></li>
<li class="chapter" data-level="6.2.6" data-path="difference-in-differences.html"><a href="difference-in-differences.html#回帰分析によるdid-の推定"><i class="fa fa-check"></i><b>6.2.6</b> 回帰分析によるDID の推定</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="difference-in-differences.html"><a href="difference-in-differences.html#法定飲酒年齢の影響"><i class="fa fa-check"></i><b>6.3</b> 法定飲酒年齢の影響</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="difference-in-differences.html"><a href="difference-in-differences.html#angrist-and-pischke-2009-の例"><i class="fa fa-check"></i><b>6.3.1</b> Angrist and Pischke (2009) の例</a></li>
<li class="chapter" data-level="6.3.2" data-path="difference-in-differences.html"><a href="difference-in-differences.html#did-回帰"><i class="fa fa-check"></i><b>6.3.2</b> DID 回帰</a></li>
<li class="chapter" data-level="6.3.3" data-path="difference-in-differences.html"><a href="difference-in-differences.html#平行トレンドの仮定"><i class="fa fa-check"></i><b>6.3.3</b> 平行トレンドの仮定</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="difference-in-differences.html"><a href="difference-in-differences.html#シミュレーション"><i class="fa fa-check"></i><b>6.4</b> シミュレーション</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="difference-in-differences.html"><a href="difference-in-differences.html#シミュレーションの設定"><i class="fa fa-check"></i><b>6.4.1</b> シミュレーションの設定</a></li>
<li class="chapter" data-level="6.4.2" data-path="difference-in-differences.html"><a href="difference-in-differences.html#シミュレーションの繰り返し実行"><i class="fa fa-check"></i><b>6.4.2</b> シミュレーションの繰り返し実行</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="difference-in-differences.html"><a href="difference-in-differences.html#トピック6の課題"><i class="fa fa-check"></i><b>6.5</b> トピック6の課題</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="midterm-presentation.html"><a href="midterm-presentation.html"><i class="fa fa-check"></i><b>7</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#このトピックでやるべきこと"><i class="fa fa-check"></i><b>7.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="7.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#分析計画のプレゼンテーション-1"><i class="fa fa-check"></i><b>7.2</b> 分析計画のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの内容"><i class="fa fa-check"></i><b>7.2.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="7.2.2" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーションの方法"><i class="fa fa-check"></i><b>7.2.2</b> プレゼンテーションの方法</a></li>
<li class="chapter" data-level="7.2.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#プレゼンテーション動画の作成法"><i class="fa fa-check"></i><b>7.2.3</b> プレゼンテーション動画の作成法</a></li>
<li class="chapter" data-level="7.2.4" data-path="midterm-presentation.html"><a href="midterm-presentation.html#提出方法と提出期限"><i class="fa fa-check"></i><b>7.2.4</b> 提出方法と提出期限</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="midterm-presentation.html"><a href="midterm-presentation.html#他の受講生へのコメントについて"><i class="fa fa-check"></i><b>7.3</b> 他の受講生へのコメントについて</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html"><i class="fa fa-check"></i><b>8</b> 回帰不連続デザイン</a>
<ul>
<li class="chapter" data-level="8.1" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#準備-5"><i class="fa fa-check"></i><b>8.1</b> 準備</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#予習講義動画実習課題-5"><i class="fa fa-check"></i><b>8.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="8.1.2" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#rパッケージの読み込み-5"><i class="fa fa-check"></i><b>8.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="8.1.3" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#このトピックで使うrコードの説明-5"><i class="fa fa-check"></i><b>8.1.3</b> このトピックで使うRコードの説明</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#法定飲酒年齢の影響-1"><i class="fa fa-check"></i><b>8.2</b> 法定飲酒年齢の影響</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#angrist-and-pischke-2009-の例-1"><i class="fa fa-check"></i><b>8.2.1</b> Angrist and Pischke (2009) の例</a></li>
<li class="chapter" data-level="8.2.2" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#パラメトリックrd"><i class="fa fa-check"></i><b>8.2.2</b> パラメトリックRD</a></li>
<li class="chapter" data-level="8.2.3" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#ノンパラメトリックrd"><i class="fa fa-check"></i><b>8.2.3</b> ノンパラメトリックRD</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="regression-discontinuity.html"><a href="regression-discontinuity.html#トピック8の課題"><i class="fa fa-check"></i><b>8.3</b> トピック8の課題</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="instrumental-variable.html"><a href="instrumental-variable.html"><i class="fa fa-check"></i><b>9</b> 操作変数法</a>
<ul>
<li class="chapter" data-level="9.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#準備-6"><i class="fa fa-check"></i><b>9.1</b> 準備</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#予習講義動画実習課題-6"><i class="fa fa-check"></i><b>9.1.1</b> 予習、講義動画、実習課題</a></li>
<li class="chapter" data-level="9.1.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#rパッケージの読み込み-6"><i class="fa fa-check"></i><b>9.1.2</b> Rパッケージの読み込み</a></li>
<li class="chapter" data-level="9.1.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#自作関数の定義"><i class="fa fa-check"></i><b>9.1.3</b> 自作関数の定義</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#操作変数のシミュレーション"><i class="fa fa-check"></i><b>9.2</b> 操作変数のシミュレーション</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#シミュレーションの設定-1"><i class="fa fa-check"></i><b>9.2.1</b> シミュレーションの設定</a></li>
<li class="chapter" data-level="9.2.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#操作変数法-1"><i class="fa fa-check"></i><b>9.2.2</b> 操作変数法</a></li>
<li class="chapter" data-level="9.2.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#シミュレーションの繰り返し"><i class="fa fa-check"></i><b>9.2.3</b> シミュレーションの繰り返し</a></li>
<li class="chapter" data-level="9.2.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#弱い操作変数"><i class="fa fa-check"></i><b>9.2.4</b> 弱い操作変数</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#操作変数を利用した-mdve-の分析"><i class="fa fa-check"></i><b>9.3</b> 操作変数を利用した MDVE の分析</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#angrist-and-pischke-2009-の例-2"><i class="fa fa-check"></i><b>9.3.1</b> Angrist and Pischke (2009) の例</a></li>
<li class="chapter" data-level="9.3.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#データの準備"><i class="fa fa-check"></i><b>9.3.2</b> データの準備</a></li>
<li class="chapter" data-level="9.3.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#short-regression"><i class="fa fa-check"></i><b>9.3.3</b> Short Regression</a></li>
<li class="chapter" data-level="9.3.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#操作変数法による推定"><i class="fa fa-check"></i><b>9.3.4</b> 操作変数法による推定</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#トピック9の課題"><i class="fa fa-check"></i><b>9.4</b> トピック9の課題</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="final-presentation.html"><a href="final-presentation.html"><i class="fa fa-check"></i><b>10</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.1" data-path="final-presentation.html"><a href="final-presentation.html#このトピックでやるべきこと-1"><i class="fa fa-check"></i><b>10.1</b> このトピックでやるべきこと</a></li>
<li class="chapter" data-level="10.2" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のレポート期末レポート"><i class="fa fa-check"></i><b>10.2</b> 分析結果のレポート（期末レポート）</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="final-presentation.html"><a href="final-presentation.html#レポートの内容"><i class="fa fa-check"></i><b>10.2.1</b> レポートの内容</a></li>
<li class="chapter" data-level="10.2.2" data-path="final-presentation.html"><a href="final-presentation.html#レポートの形式と提出方法"><i class="fa fa-check"></i><b>10.2.2</b> レポートの形式と提出方法</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="final-presentation.html"><a href="final-presentation.html#分析結果のプレゼンテーション-1"><i class="fa fa-check"></i><b>10.3</b> 分析結果のプレゼンテーション</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="final-presentation.html"><a href="final-presentation.html#プレゼンテーションの内容-1"><i class="fa fa-check"></i><b>10.3.1</b> プレゼンテーションの内容</a></li>
<li class="chapter" data-level="10.3.2" data-path="final-presentation.html"><a href="final-presentation.html#提出方法と提出期限-1"><i class="fa fa-check"></i><b>10.3.2</b> 提出方法と提出期限</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>実行環境</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>参考文献</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="_blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">KUT 計量経済学応用</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="操作変数法" class="section level1" number="9">
<h1><span class="header-section-number">Topic 9</span> 操作変数法</h1>
<ul>
<li><a href="http://yukiyanai.github.io/jp/classes/econometrics2/contents/slides/metrics2_topic09_slides.pdf">トピック9の講義スライド</a> (PDF, 1.2MB)</li>
</ul>
<div id="準備-6" class="section level2" number="9.1">
<h2><span class="header-section-number">9.1</span> 準備</h2>
<div id="予習講義動画実習課題-6" class="section level3" number="9.1.1">
<h3><span class="header-section-number">9.1.1</span> 予習、講義動画、実習課題</h3>
<p>このトピックでやるべきことは、以下のとおりである。</p>
<ol style="list-style-type: decimal">
<li><a href="http://yukiyanai.github.io/jp/classes/econometrics2/docs/syllabus-applied-econometrics_2020-2Q.pdf">シラバス(PDFファイル)</a> に記載されているトピック9の予習課題を読む。</li>
<li><a href="https://lms.kochi-tech.ac.jp/course/view.php?id=793">KUTLMS (Moodle)</a> にあるトピック9の講義動画を視聴する。</li>
<li>この資料の続きを読み、Rを使った実習を行うことで、操作変数法の使い方を学ぶ。</li>
<li>課題を提出する（選択制）。</li>
</ol>
</div>
<div id="rパッケージの読み込み-6" class="section level3" number="9.1.2">
<h3><span class="header-section-number">9.1.2</span> Rパッケージの読み込み</h3>
<p>必要なパッケージを読み込み、作図用の日本語フォントを設定する。</p>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb528-1"><a href="instrumental-variable.html#cb528-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(tidyverse, broom, haven, estimatr, AER)</span>
<span id="cb528-2"><a href="instrumental-variable.html#cb528-2"></a><span class="kw">theme_set</span>(<span class="kw">theme_gray</span>(<span class="dt">base_size =</span> <span class="dv">10</span>, <span class="dt">base_family =</span> <span class="st">&quot;HiraginoSans-W3&quot;</span>))  <span class="co"># macOS用</span></span>
<span id="cb528-3"><a href="instrumental-variable.html#cb528-3"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;Meiryo&quot;))           # Windows用</span></span>
<span id="cb528-4"><a href="instrumental-variable.html#cb528-4"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;IPAGothic&quot;))        # Ubuntu用</span></span>
<span id="cb528-5"><a href="instrumental-variable.html#cb528-5"></a><span class="co">#showtext::showtext_auto()                                               # Cloud用</span></span>
<span id="cb528-6"><a href="instrumental-variable.html#cb528-6"></a><span class="co">#theme_set(theme_gray(base_size = 10, base_family = &quot;noto&quot;))             # Cloud用</span></span></code></pre></div>
</div>
<div id="自作関数の定義" class="section level3" number="9.1.3">
<h3><span class="header-section-number">9.1.3</span> 自作関数の定義</h3>
<p>ロジットの逆関数を定義する。</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb529-1"><a href="instrumental-variable.html#cb529-1"></a>inv_logit &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb529-2"><a href="instrumental-variable.html#cb529-2"></a>  <span class="kw">return</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>x)))</span>
<span id="cb529-3"><a href="instrumental-variable.html#cb529-3"></a>}</span></code></pre></div>
</div>
</div>
<div id="操作変数のシミュレーション" class="section level2" number="9.2">
<h2><span class="header-section-number">9.2</span> 操作変数のシミュレーション</h2>
<p>まず、簡単なシミュレーションによって操作変数法の仕組みを理解しよう。</p>
<div id="シミュレーションの設定-1" class="section level3" number="9.2.1">
<h3><span class="header-section-number">9.2.1</span> シミュレーションの設定</h3>
<p>次の変数を考える。</p>
<ul>
<li>結果変数 <span class="math inline">\(Y \in \mathbb{R}\)</span></li>
<li>処置変数（内生変数）<span class="math inline">\(D \in \{0, 1\}\)</span>
<ul>
<li>D0: <span class="math inline">\(Z = 0\)</span> のときの潜在的処置 <span class="math inline">\(D(0)\)</span></li>
<li>D1: <span class="math inline">\(Z = 1\)</span> のときの潜在的処置 <span class="math inline">\(D(1)\)</span></li>
</ul></li>
<li>未観測の交絡 <span class="math inline">\(A \in \mathbb{R}\)</span></li>
<li>操作変数 <span class="math inline">\(Z \in \{0, 1\}\)</span></li>
</ul>
<p>これらの変数のうち、<span class="math inline">\(A\)</span>、<span class="math inline">\(D(0)\)</span>、<span class="math inline">\(D(1)\)</span>は調査・観察データでは手に入らないが、シミュレーションでは確認できる変数である。</p>
<p>以下の手順でデータを生成する。</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(A\)</span> と <span class="math inline">\(Z\)</span> をランダムに生成する。</li>
<li><span class="math inline">\(A\)</span> の値を利用して、<span class="math inline">\(p(D(0) = 1)\)</span> と <span class="math inline">\(p(D(1) = 1)\)</span> を作る。これにより、<span class="math inline">\(D\)</span>の値が<span class="math inline">\(A\)</span>に依存することになる。</li>
<li>2で作った確率を利用して、ベルヌーイ試行で <span class="math inline">\(D(0)\)</span> と <span class="math inline">\(D(1)\)</span> を生成する。</li>
<li><span class="math inline">\(Z\)</span> の値によって、<span class="math inline">\(D\)</span> が <span class="math inline">\(D(0)\)</span> になるか <span class="math inline">\(D(1)\)</span>になるかを決める。</li>
<li><span class="math inline">\(Y\)</span> を、<span class="math inline">\(A\)</span> と<span class="math inline">\(D\)</span> の値に基づいて決める。「正しい」処置効果は <span class="math inline">\(\beta\)</span> とする。ここでは、<code>beta = 0.3</code> と設定する。</li>
<li><span class="math inline">\(D(0)\)</span> と <span class="math inline">\(D(1)\)</span> の値を確認し、各個体を4つのタイプに分ける。</li>
</ol>
<ul>
<li>c: complier</li>
<li>a: always-taker</li>
<li>n: never-taker</li>
<li>d: defier</li>
</ul>
<p>このルールによって、1つのデータセットを作ってみよう。</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb530-1"><a href="instrumental-variable.html#cb530-1"></a><span class="kw">set.seed</span>(<span class="dv">2020-07-07</span>)</span>
<span id="cb530-2"><a href="instrumental-variable.html#cb530-2"></a>N &lt;-<span class="st"> </span><span class="dv">200</span></span>
<span id="cb530-3"><a href="instrumental-variable.html#cb530-3"></a>beta &lt;-<span class="st"> </span><span class="fl">0.3</span></span>
<span id="cb530-4"><a href="instrumental-variable.html#cb530-4"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">A =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>),</span>
<span id="cb530-5"><a href="instrumental-variable.html#cb530-5"></a>             <span class="dt">Z =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.4</span>),</span>
<span id="cb530-6"><a href="instrumental-variable.html#cb530-6"></a>             <span class="dt">prob_D0 =</span> <span class="kw">inv_logit</span>(<span class="op">-</span><span class="fl">0.8</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A),</span>
<span id="cb530-7"><a href="instrumental-variable.html#cb530-7"></a>             <span class="dt">prob_D1 =</span> <span class="kw">inv_logit</span>(<span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb530-8"><a href="instrumental-variable.html#cb530-8"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">D0 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D0),</span>
<span id="cb530-9"><a href="instrumental-variable.html#cb530-9"></a>         <span class="dt">D1 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D1),</span>
<span id="cb530-10"><a href="instrumental-variable.html#cb530-10"></a>         <span class="dt">D =</span> <span class="kw">ifelse</span>(Z <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, D1, D0),</span>
<span id="cb530-11"><a href="instrumental-variable.html#cb530-11"></a>         <span class="dt">Y =</span> beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>),</span>
<span id="cb530-12"><a href="instrumental-variable.html#cb530-12"></a>         <span class="dt">type =</span> <span class="kw">case_when</span>(</span>
<span id="cb530-13"><a href="instrumental-variable.html#cb530-13"></a>           D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;c&quot;</span>,</span>
<span id="cb530-14"><a href="instrumental-variable.html#cb530-14"></a>           D0 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;a&quot;</span>,</span>
<span id="cb530-15"><a href="instrumental-variable.html#cb530-15"></a>           D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;n&quot;</span>,</span>
<span id="cb530-16"><a href="instrumental-variable.html#cb530-16"></a>           <span class="ot">TRUE</span>              <span class="op">~</span><span class="st"> &quot;d&quot;</span>),</span>
<span id="cb530-17"><a href="instrumental-variable.html#cb530-17"></a>         <span class="dt">type =</span> <span class="kw">factor</span>(type, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;c&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;d&quot;</span>)))</span></code></pre></div>
<p>実際には観測できない <span class="math inline">\(A\)</span> を観測できれば、重回帰によって<span class="math inline">\(\beta\)</span> を推定することができる。
やってみよう。</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb531-1"><a href="instrumental-variable.html#cb531-1"></a>fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span>A, <span class="dt">data =</span> df)</span>
<span id="cb531-2"><a href="instrumental-variable.html#cb531-2"></a><span class="kw">tidy</span>(fit1) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb531-3"><a href="instrumental-variable.html#cb531-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb531-4"><a href="instrumental-variable.html#cb531-4"></a><span class="st">  </span><span class="kw">select</span>(estimate, std.error) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb531-5"><a href="instrumental-variable.html#cb531-5"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.342</td>
<td align="right">0.034</td>
</tr>
</tbody>
</table>
<p>1つのデータセットだけでははっきりしたことはわからないが、この回帰分析で得られた推定値は、設定した処置効果である 0.3 からそれほど大きく離れていない。</p>
<p>しかし、実際には <span class="math inline">\(A\)</span> を観測することはできないので、観測できる変数を使って単回帰を実行してみよう。</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="instrumental-variable.html#cb532-1"></a>fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> df)</span>
<span id="cb532-2"><a href="instrumental-variable.html#cb532-2"></a><span class="kw">tidy</span>(fit2) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-3"><a href="instrumental-variable.html#cb532-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-4"><a href="instrumental-variable.html#cb532-4"></a><span class="st">  </span><span class="kw">select</span>(estimate, std.error) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-5"><a href="instrumental-variable.html#cb532-5"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.742</td>
<td align="right">0.064</td>
</tr>
</tbody>
</table>
<p>脱落変数バイアスにより、効果が過大推定されていることがわかる。</p>
</div>
<div id="操作変数法-1" class="section level3" number="9.2.2">
<h3><span class="header-section-number">9.2.2</span> 操作変数法</h3>
<p>操作変数法によって、処置効果の推定を試みよう。
操作変数法を使うために、「defierが存在しない」という仮定が必要なので、まず defier を取り除く。現実のデータ分析では誰が defier かわからないので、この作業をすることは不可能であることに注意されたい。</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb533-1"><a href="instrumental-variable.html#cb533-1"></a>df_sub &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb533-2"><a href="instrumental-variable.html#cb533-2"></a><span class="st">  </span><span class="kw">filter</span>(type <span class="op">!=</span><span class="st"> &quot;d&quot;</span>)</span></code></pre></div>
<p>次に、「操作変数と内生変数に相関がある」かどうか確かめる。検定によってこれを確かめるため、第1段階の回帰を行う。つまり、<span class="math inline">\(D\)</span> を <span class="math inline">\(Z\)</span> に回帰する。</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb534-1"><a href="instrumental-variable.html#cb534-1"></a>fs1 &lt;-<span class="st"> </span><span class="kw">lm</span>(D <span class="op">~</span><span class="st"> </span>Z, <span class="dt">data =</span> df_sub)</span>
<span id="cb534-2"><a href="instrumental-variable.html#cb534-2"></a><span class="kw">tidy</span>(fs1) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb534-3"><a href="instrumental-variable.html#cb534-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;Z&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb534-4"><a href="instrumental-variable.html#cb534-4"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Z</td>
<td align="right">0.298</td>
<td align="right">0.07</td>
<td align="right">4.237</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(t\)</span> 値 (statisitc) が 4.24 であり、目安である3.2を超えているので、弱くない相関があると判断する。（
ここでは共変量がない場合について考えているので、<code>cor.test()</code> でも同じ結果が出る。）</p>
<p>次に、除外制約を確認する必要がある。<strong>実際の研究においてはここが最も重要なポイント</strong>になりうるが、シミュレーションでは除外制約が成り立つことがわかっているので、この議論は省略する。</p>
<p>IVの公式を使って推定値を求めよう。</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb535-1"><a href="instrumental-variable.html#cb535-1"></a><span class="kw">with</span>(df_sub, <span class="kw">cov</span>(Y, Z) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Z))</span></code></pre></div>
<pre><code>## [1] 0.23175</code></pre>
<p>このシミュレーションデータでは、効果が過小推定されている。しかし、単回帰によって得られた脱落変数バイアスを含む推定値よりは、真の値に近い推定値が得られた。</p>
<p>Defier がいる場合にはどうなるだろうか。</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb537-1"><a href="instrumental-variable.html#cb537-1"></a><span class="kw">with</span>(df, <span class="kw">cov</span>(Y, Z) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Z))</span></code></pre></div>
<pre><code>## [1] 0.179756</code></pre>
<p>Defier がいないという仮定が破られた結果、効果がさらに過小に推定されている。</p>
</div>
<div id="シミュレーションの繰り返し" class="section level3" number="9.2.3">
<h3><span class="header-section-number">9.2.3</span> シミュレーションの繰り返し</h3>
<p>上のシミュレーションを繰り返せるように、関数を作ろう。</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb539-1"><a href="instrumental-variable.html#cb539-1"></a>iv_sim &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">200</span>, <span class="dt">beta =</span> <span class="fl">0.3</span>) {</span>
<span id="cb539-2"><a href="instrumental-variable.html#cb539-2"></a>  df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">A =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>),</span>
<span id="cb539-3"><a href="instrumental-variable.html#cb539-3"></a>               <span class="dt">Z =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.4</span>),</span>
<span id="cb539-4"><a href="instrumental-variable.html#cb539-4"></a>               <span class="dt">prob_D0 =</span> <span class="kw">inv_logit</span>(<span class="op">-</span><span class="fl">0.8</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A),</span>
<span id="cb539-5"><a href="instrumental-variable.html#cb539-5"></a>               <span class="dt">prob_D1 =</span> <span class="kw">inv_logit</span>(<span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb539-6"><a href="instrumental-variable.html#cb539-6"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">D0 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D0),</span>
<span id="cb539-7"><a href="instrumental-variable.html#cb539-7"></a>           <span class="dt">D1 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D1),</span>
<span id="cb539-8"><a href="instrumental-variable.html#cb539-8"></a>           <span class="dt">D =</span> <span class="kw">ifelse</span>(Z <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, D1, D0),</span>
<span id="cb539-9"><a href="instrumental-variable.html#cb539-9"></a>           <span class="dt">Y =</span> beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>),</span>
<span id="cb539-10"><a href="instrumental-variable.html#cb539-10"></a>           <span class="dt">type =</span> <span class="kw">case_when</span>(</span>
<span id="cb539-11"><a href="instrumental-variable.html#cb539-11"></a>             D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;c&quot;</span>,</span>
<span id="cb539-12"><a href="instrumental-variable.html#cb539-12"></a>             D0 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;a&quot;</span>,</span>
<span id="cb539-13"><a href="instrumental-variable.html#cb539-13"></a>             D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;n&quot;</span>,</span>
<span id="cb539-14"><a href="instrumental-variable.html#cb539-14"></a>             <span class="ot">TRUE</span>              <span class="op">~</span><span class="st"> &quot;d&quot;</span>),</span>
<span id="cb539-15"><a href="instrumental-variable.html#cb539-15"></a>           <span class="dt">type =</span> <span class="kw">factor</span>(type, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;c&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;d&quot;</span>)))</span>
<span id="cb539-16"><a href="instrumental-variable.html#cb539-16"></a></span>
<span id="cb539-17"><a href="instrumental-variable.html#cb539-17"></a>  df_sub &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(type <span class="op">!=</span><span class="st"> &quot;d&quot;</span>)</span>
<span id="cb539-18"><a href="instrumental-variable.html#cb539-18"></a>  </span>
<span id="cb539-19"><a href="instrumental-variable.html#cb539-19"></a>  reg_short &lt;-<span class="st"> </span><span class="kw">with</span>(df_sub, <span class="kw">cov</span>(Y, D) <span class="op">/</span><span class="st"> </span><span class="kw">var</span>(D))</span>
<span id="cb539-20"><a href="instrumental-variable.html#cb539-20"></a>  iv &lt;-<span class="st"> </span><span class="kw">with</span>(df_sub, <span class="kw">cov</span>(Y, Z) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Z))</span>
<span id="cb539-21"><a href="instrumental-variable.html#cb539-21"></a>  prop_c &lt;-<span class="st"> </span><span class="kw">mean</span>(df_sub<span class="op">$</span>type <span class="op">==</span><span class="st"> &quot;c&quot;</span>)   <span class="co"># compliers の割合</span></span>
<span id="cb539-22"><a href="instrumental-variable.html#cb539-22"></a>  <span class="kw">return</span>(<span class="kw">c</span>(<span class="dt">reg_s =</span> reg_short, </span>
<span id="cb539-23"><a href="instrumental-variable.html#cb539-23"></a>           <span class="dt">iv =</span> iv, </span>
<span id="cb539-24"><a href="instrumental-variable.html#cb539-24"></a>           <span class="dt">prop_c =</span> prop_c))</span>
<span id="cb539-25"><a href="instrumental-variable.html#cb539-25"></a>}</span></code></pre></div>
<p>この関数を1回だけ使ってみる。</p>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="instrumental-variable.html#cb540-1"></a><span class="kw">iv_sim</span>()</span></code></pre></div>
<pre><code>##     reg_s        iv    prop_c 
## 0.5618581 0.2117467 0.4566474</code></pre>
<p>reg_s は short regression による推定値、iv は IV による推定値、prop_c はデータセットに含まれる complier の割合（ただし、defier の割合は0）である。</p>
<p>この関数を使って1000回シミュレーションを行う。</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="instrumental-variable.html#cb542-1"></a>iv_sim_<span class="dv">1000</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">iv_sim</span>()) </span></code></pre></div>
<p>シミュレーション結果をデータフレーム (tibble) に変換する。</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb543-1"><a href="instrumental-variable.html#cb543-1"></a>p_df &lt;-<span class="st"> </span>iv_sim_<span class="dv">1000</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb543-2"><a href="instrumental-variable.html#cb543-2"></a><span class="st">  </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb543-3"><a href="instrumental-variable.html#cb543-3"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span></code></pre></div>
<p>まず、short regression の推定結果を可視化する。</p>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb544-1"><a href="instrumental-variable.html#cb544-1"></a>p_short &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df, <span class="kw">aes</span>(<span class="dt">x =</span> reg_s, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb544-2"><a href="instrumental-variable.html#cb544-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb544-3"><a href="instrumental-variable.html#cb544-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb544-4"><a href="instrumental-variable.html#cb544-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Short regression による推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb544-5"><a href="instrumental-variable.html#cb544-5"></a><span class="kw">plot</span>(p_short)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-359-1.png" width="384" /></p>
<p>脱落変数バイアスによって処置効果が過大推定されており、設定した値である0.3 を推定できていないことがわかる。</p>
<p>次に、IVによる推定値を確認してみよう。</p>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb545-1"><a href="instrumental-variable.html#cb545-1"></a>p_iv &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df, <span class="kw">aes</span>(<span class="dt">x =</span> iv, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb545-2"><a href="instrumental-variable.html#cb545-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb545-3"><a href="instrumental-variable.html#cb545-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb545-4"><a href="instrumental-variable.html#cb545-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;IV による推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb545-5"><a href="instrumental-variable.html#cb545-5"></a><span class="kw">plot</span>(p_iv)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-360-1.png" width="384" /></p>
<p>平均すれば、処置効果をうまく推定できていることがわかる。このシミュレーションにおける推定値の平均値は、</p>
<div class="sourceCode" id="cb546"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb546-1"><a href="instrumental-variable.html#cb546-1"></a><span class="kw">mean</span>(p_df<span class="op">$</span>iv)</span></code></pre></div>
<pre><code>## [1] 0.2826947</code></pre>
<p>であり、0.3 に近い値が得られている。また、推定値の標準偏差（シミュレーションによる標準誤差）は、</p>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb548-1"><a href="instrumental-variable.html#cb548-1"></a><span class="kw">sd</span>(p_df<span class="op">$</span>iv)</span></code></pre></div>
<pre><code>## [1] 0.1886498</code></pre>
<p>であり、推定値の大きさに対してばらつきが大きく、推定の不確実性が大きいことがわかる。</p>
<p>IV が推定対象とするのは complier についての LATE なので、データセットに占める complier の割合が小さいと、推定が影響を受けるかもしれない。このシミュレーションにおける complier の割合を図示しよう。</p>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb550-1"><a href="instrumental-variable.html#cb550-1"></a>p_compliers &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df, <span class="kw">aes</span>(<span class="dt">x =</span> prop_c, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb550-2"><a href="instrumental-variable.html#cb550-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb550-3"><a href="instrumental-variable.html#cb550-3"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Compliers の割合&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb550-4"><a href="instrumental-variable.html#cb550-4"></a><span class="kw">plot</span>(p_compliers)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-363-1.png" width="384" /></p>
<p>このように、complier の割合があまり大きくないデータが多かったことがわかる。</p>
<p>Complier の割合が大きいと、推定は安定するだろうか。Complier の割合が大きくなるようにシミュレーションを調整し、確認してみよう。<code>comp</code> で complier の割合の下限を設定できるようにする。また、complier になりやすいように prob_D0 と prob_D1 の生成法を修正する（注意：comp の値を大きくし過ぎると、シミュレーションに時間がかかる）。</p>
<div class="sourceCode" id="cb551"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb551-1"><a href="instrumental-variable.html#cb551-1"></a>iv_sim2 &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">200</span>, <span class="dt">beta =</span> <span class="fl">0.3</span>, <span class="dt">comp =</span> <span class="fl">0.6</span>) {</span>
<span id="cb551-2"><a href="instrumental-variable.html#cb551-2"></a>  prop_c &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb551-3"><a href="instrumental-variable.html#cb551-3"></a>  <span class="cf">while</span> (prop_c <span class="op">&lt;</span><span class="st"> </span>comp) {</span>
<span id="cb551-4"><a href="instrumental-variable.html#cb551-4"></a>    df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">A =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>),</span>
<span id="cb551-5"><a href="instrumental-variable.html#cb551-5"></a>                 <span class="dt">Z =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.4</span>),</span>
<span id="cb551-6"><a href="instrumental-variable.html#cb551-6"></a>                 <span class="dt">prob_D0 =</span> <span class="kw">inv_logit</span>(<span class="op">-</span><span class="fl">1.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A),</span>
<span id="cb551-7"><a href="instrumental-variable.html#cb551-7"></a>                 <span class="dt">prob_D1 =</span> <span class="kw">inv_logit</span>(<span class="fl">1.2</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb551-8"><a href="instrumental-variable.html#cb551-8"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">D0 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D0),</span>
<span id="cb551-9"><a href="instrumental-variable.html#cb551-9"></a>             <span class="dt">D1 =</span> <span class="kw">rbinom</span>(N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> prob_D1),</span>
<span id="cb551-10"><a href="instrumental-variable.html#cb551-10"></a>             <span class="dt">D =</span> <span class="kw">ifelse</span>(Z <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, D1, D0),</span>
<span id="cb551-11"><a href="instrumental-variable.html#cb551-11"></a>             <span class="dt">Y =</span> beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb551-12"><a href="instrumental-variable.html#cb551-12"></a>             <span class="dt">type =</span> <span class="kw">case_when</span>(</span>
<span id="cb551-13"><a href="instrumental-variable.html#cb551-13"></a>               D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;c&quot;</span>,</span>
<span id="cb551-14"><a href="instrumental-variable.html#cb551-14"></a>               D0 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;a&quot;</span>,</span>
<span id="cb551-15"><a href="instrumental-variable.html#cb551-15"></a>               D0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>D1 <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;n&quot;</span>,</span>
<span id="cb551-16"><a href="instrumental-variable.html#cb551-16"></a>               <span class="ot">TRUE</span>              <span class="op">~</span><span class="st"> &quot;d&quot;</span>),</span>
<span id="cb551-17"><a href="instrumental-variable.html#cb551-17"></a>             <span class="dt">type =</span> <span class="kw">factor</span>(type, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;c&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;d&quot;</span>)))</span>
<span id="cb551-18"><a href="instrumental-variable.html#cb551-18"></a></span>
<span id="cb551-19"><a href="instrumental-variable.html#cb551-19"></a>    df_sub &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(type <span class="op">!=</span><span class="st"> &quot;d&quot;</span>)</span>
<span id="cb551-20"><a href="instrumental-variable.html#cb551-20"></a>    prop_c &lt;-<span class="st"> </span><span class="kw">mean</span>(df_sub<span class="op">$</span>type <span class="op">==</span><span class="st"> &quot;c&quot;</span>)   <span class="co"># compliers の割合</span></span>
<span id="cb551-21"><a href="instrumental-variable.html#cb551-21"></a>  }</span>
<span id="cb551-22"><a href="instrumental-variable.html#cb551-22"></a>  </span>
<span id="cb551-23"><a href="instrumental-variable.html#cb551-23"></a>  reg_short &lt;-<span class="st"> </span><span class="kw">with</span>(df_sub, <span class="kw">cov</span>(Y, D) <span class="op">/</span><span class="st"> </span><span class="kw">var</span>(D))</span>
<span id="cb551-24"><a href="instrumental-variable.html#cb551-24"></a>  iv &lt;-<span class="st"> </span><span class="kw">with</span>(df_sub, <span class="kw">cov</span>(Y, Z) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Z))</span>
<span id="cb551-25"><a href="instrumental-variable.html#cb551-25"></a></span>
<span id="cb551-26"><a href="instrumental-variable.html#cb551-26"></a>  <span class="kw">return</span>(<span class="kw">c</span>(<span class="dt">reg_s =</span> reg_short, <span class="dt">iv =</span> iv, <span class="dt">prop_c =</span> prop_c))</span>
<span id="cb551-27"><a href="instrumental-variable.html#cb551-27"></a>}</span></code></pre></div>
<p>この関数を1回だけ使ってみる。</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb552-1"><a href="instrumental-variable.html#cb552-1"></a><span class="kw">iv_sim2</span>()</span></code></pre></div>
<pre><code>##     reg_s        iv    prop_c 
## 0.5186895 0.2664188 0.6073298</code></pre>
<p>1000回シミュレーションを行う。</p>
<div class="sourceCode" id="cb554"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb554-1"><a href="instrumental-variable.html#cb554-1"></a>iv_sim2_<span class="dv">1000</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">iv_sim2</span>()) </span></code></pre></div>
<p>シミュレーションの結果をデータフレーム (tibble) に変換する。</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb555-1"><a href="instrumental-variable.html#cb555-1"></a>p_df2 &lt;-<span class="st"> </span>iv_sim2_<span class="dv">1000</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb555-2"><a href="instrumental-variable.html#cb555-2"></a><span class="st">  </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb555-3"><a href="instrumental-variable.html#cb555-3"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span></code></pre></div>
<p>Complier の割合を可視化する。</p>
<div class="sourceCode" id="cb556"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb556-1"><a href="instrumental-variable.html#cb556-1"></a>p_compliers2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df2, <span class="kw">aes</span>(<span class="dt">x =</span> prop_c, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb556-2"><a href="instrumental-variable.html#cb556-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb556-3"><a href="instrumental-variable.html#cb556-3"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Compliers の割合&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb556-4"><a href="instrumental-variable.html#cb556-4"></a><span class="kw">plot</span>(p_compliers2)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-368-1.png" width="384" /></p>
<p>Complierの割合が0.6以上になっていることがわかる。</p>
<p>IVの推定値の分布を確認しよう。</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb557-1"><a href="instrumental-variable.html#cb557-1"></a>p_iv2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df2, <span class="kw">aes</span>(<span class="dt">x =</span> iv, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb557-2"><a href="instrumental-variable.html#cb557-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb557-3"><a href="instrumental-variable.html#cb557-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb557-4"><a href="instrumental-variable.html#cb557-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;IV による推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb557-5"><a href="instrumental-variable.html#cb557-5"></a><span class="kw">plot</span>(p_iv2)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-369-1.png" width="384" /></p>
<p>平均すれば、処置効果をうまく推定できていることがわかる。このシミュレーションにおける推定値の平均値は、</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb558-1"><a href="instrumental-variable.html#cb558-1"></a><span class="kw">mean</span>(p_df2<span class="op">$</span>iv)</span></code></pre></div>
<pre><code>## [1] 0.2995411</code></pre>
<p>であり、0.3 に近い値が得られている。また、推定値の標準偏差（シミュレーションによる標準誤差）は、</p>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb560-1"><a href="instrumental-variable.html#cb560-1"></a><span class="kw">sd</span>(p_df2<span class="op">$</span>iv)</span></code></pre></div>
<pre><code>## [1] 0.09758286</code></pre>
<p>であり、complierの割合が小さい場合に比べ、推定の不確実性が小さくなったことがわかる。IV推定では complier の LATE を推定するため、分析するデータのなかに complier が多数含まれていることが重要であることが示唆される。観測個体に complier が多いかどうかをデータから確かめることはできないので、complier が多いと信じられる理論的な根拠が必要である。</p>
</div>
<div id="弱い操作変数" class="section level3" number="9.2.4">
<h3><span class="header-section-number">9.2.4</span> 弱い操作変数</h3>
<p>続いて、弱い操作変数を使うとどのような問題が生じるか、シミュレーションで確かめよう。
以下の変数を考える。</p>
<ul>
<li>結果変数 <span class="math inline">\(Y \in \mathbb{R}\)</span></li>
<li>処置変数（内生変数）<span class="math inline">\(D \in \mathbb{R}\)</span></li>
<li>未観測の交絡 <span class="math inline">\(A \in \mathbb{R}\)</span></li>
<li>操作変数1（<span class="math inline">\(D\)</span>と強い相関） <span class="math inline">\(Z_s \in \mathbb{R}\)</span></li>
<li>操作変数2（<span class="math inline">\(D\)</span>と弱い相関） <span class="math inline">\(Z_w \in \mathbb{R}\)</span></li>
</ul>
<p>以下の手順でデータを生成する。</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(A\)</span> と <span class="math inline">\(Z_s\)</span>、<span class="math inline">\(Z_w\)</span> をランダムに生成する。</li>
<li><span class="math inline">\(A\)</span> と <span class="math inline">\(Z_s\)</span>、<span class="math inline">\(Z_w\)</span> の値を利用して、<span class="math inline">\(D\)</span> の値を決める。</li>
<li><span class="math inline">\(Y\)</span> を、<span class="math inline">\(A\)</span> と<span class="math inline">\(D\)</span> の値に基づいて決める。「正しい」処置効果は <span class="math inline">\(\beta\)</span> とする。ここでは、<code>beta = 0.3</code> と設定する。</li>
</ol>
<p>上記3の手順にある通り、このデータ生成仮定では、どちらの操作変数も除外制約を満たしている。よって、「理論的には」操作変数による推定がうまくいくはずである。しかし、実際には弱い操作変数が問題であることを確認しよう。ただし、defier は存在しないと仮定する。</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb562-1"><a href="instrumental-variable.html#cb562-1"></a>sim_weak &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">N =</span> <span class="dv">200</span>, <span class="dt">beta =</span> <span class="fl">0.3</span>) {</span>
<span id="cb562-2"><a href="instrumental-variable.html#cb562-2"></a>  df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">A  =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>),</span>
<span id="cb562-3"><a href="instrumental-variable.html#cb562-3"></a>               <span class="dt">Zs =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>),</span>
<span id="cb562-4"><a href="instrumental-variable.html#cb562-4"></a>               <span class="dt">Zw =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb562-5"><a href="instrumental-variable.html#cb562-5"></a><span class="st">     </span><span class="kw">mutate</span>(<span class="dt">D =</span> <span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="fl">0.6</span> <span class="op">*</span><span class="st"> </span>Zs <span class="op">+</span><span class="st"> </span><span class="fl">0.05</span> <span class="op">*</span><span class="st"> </span>Zw <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N),</span>
<span id="cb562-6"><a href="instrumental-variable.html#cb562-6"></a>            <span class="dt">Y =</span> beta <span class="op">*</span><span class="st"> </span>D <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>))</span>
<span id="cb562-7"><a href="instrumental-variable.html#cb562-7"></a>  </span>
<span id="cb562-8"><a href="instrumental-variable.html#cb562-8"></a>  reg_short &lt;-<span class="st"> </span><span class="kw">with</span>(df, <span class="kw">cov</span>(Y, D) <span class="op">/</span><span class="st"> </span><span class="kw">var</span>(D))</span>
<span id="cb562-9"><a href="instrumental-variable.html#cb562-9"></a>  cor_s &lt;-<span class="st"> </span><span class="kw">with</span>(df, <span class="kw">cor</span>(Y, Zs))</span>
<span id="cb562-10"><a href="instrumental-variable.html#cb562-10"></a>  iv_s &lt;-<span class="st"> </span><span class="kw">with</span>(df, <span class="kw">cov</span>(Y, Zs) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Zs))</span>
<span id="cb562-11"><a href="instrumental-variable.html#cb562-11"></a>  cor_w &lt;-<span class="st"> </span><span class="kw">with</span>(df, <span class="kw">cor</span>(Y, Zw))</span>
<span id="cb562-12"><a href="instrumental-variable.html#cb562-12"></a>  iv_w &lt;-<span class="st"> </span><span class="kw">with</span>(df, <span class="kw">cov</span>(Y, Zw) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Zw))</span>
<span id="cb562-13"><a href="instrumental-variable.html#cb562-13"></a>  <span class="kw">return</span>(<span class="kw">c</span>(<span class="dt">reg_s =</span> reg_short, </span>
<span id="cb562-14"><a href="instrumental-variable.html#cb562-14"></a>           <span class="dt">cor_strong =</span> cor_s,</span>
<span id="cb562-15"><a href="instrumental-variable.html#cb562-15"></a>           <span class="dt">iv_strong =</span> iv_s, </span>
<span id="cb562-16"><a href="instrumental-variable.html#cb562-16"></a>           <span class="dt">cor_weak =</span> cor_w,</span>
<span id="cb562-17"><a href="instrumental-variable.html#cb562-17"></a>           <span class="dt">iv_weak =</span> iv_w))</span>
<span id="cb562-18"><a href="instrumental-variable.html#cb562-18"></a>}</span></code></pre></div>
<p>この関数を1回だけ使ってみる。</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb563-1"><a href="instrumental-variable.html#cb563-1"></a><span class="kw">sim_weak</span>()</span></code></pre></div>
<pre><code>##      reg_s cor_strong  iv_strong   cor_weak    iv_weak 
## 0.44458812 0.40073227 0.32185842 0.02289725 0.70974011</code></pre>
<p>この関数で、short regression の推定値 (reg_s)、D と Zs の相関係数 (cor_strong)、Zs を使ったIV推定値 (iv_strong)、D と Zw の相関係数 (cor_weak)、Zw を使ったIV推定値 (iv_weak) が得られる。</p>
<p>これを1000回繰り返そう。</p>
<div class="sourceCode" id="cb565"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb565-1"><a href="instrumental-variable.html#cb565-1"></a>weak_sim_<span class="dv">1000</span> &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">sim_weak</span>())</span></code></pre></div>
<p>シミュレーションの結果をデータフレーム (tibble) に変換する。</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb566-1"><a href="instrumental-variable.html#cb566-1"></a>p_df_w &lt;-<span class="st"> </span>weak_sim_<span class="dv">1000</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb566-2"><a href="instrumental-variable.html#cb566-2"></a><span class="st">  </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb566-3"><a href="instrumental-variable.html#cb566-3"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span></code></pre></div>
<p>まず、short regression の推定値を確認しよう。</p>
<div class="sourceCode" id="cb567"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb567-1"><a href="instrumental-variable.html#cb567-1"></a>p_short3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df_w, <span class="kw">aes</span>(<span class="dt">x =</span> reg_s, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb567-2"><a href="instrumental-variable.html#cb567-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb567-3"><a href="instrumental-variable.html#cb567-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb567-4"><a href="instrumental-variable.html#cb567-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Short regression による推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb567-5"><a href="instrumental-variable.html#cb567-5"></a><span class="kw">plot</span>(p_short3)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-376-1.png" width="384" /></p>
<p>やはり、short regression は脱落変数バイアスによって因果効果を過大推定している。推定値の平均値は、</p>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb568-1"><a href="instrumental-variable.html#cb568-1"></a><span class="kw">mean</span>(p_df_w<span class="op">$</span>reg_s)</span></code></pre></div>
<pre><code>## [1] 0.403764</code></pre>
<p>次に、（強い）操作変数 Zs の推定値を確認しよう。推定値の前に、D と Zs の相関係数を確認する。</p>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb570-1"><a href="instrumental-variable.html#cb570-1"></a><span class="kw">mean</span>(p_df_w<span class="op">$</span>cor_strong)</span></code></pre></div>
<pre><code>## [1] 0.4390823</code></pre>
<p>平均すると 0.4 程度の相関があることがわかる。IV推定値の分布を可視化する。</p>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb572-1"><a href="instrumental-variable.html#cb572-1"></a>p_strong &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df_w, <span class="kw">aes</span>(<span class="dt">x =</span> iv_strong, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb572-2"><a href="instrumental-variable.html#cb572-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb572-3"><a href="instrumental-variable.html#cb572-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb572-4"><a href="instrumental-variable.html#cb572-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;強いIVによる推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb572-5"><a href="instrumental-variable.html#cb572-5"></a><span class="kw">plot</span>(p_strong)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-379-1.png" width="384" /></p>
<p>平均的には推定がうまくいっているようだ。推定値の平均値は、</p>
<div class="sourceCode" id="cb573"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb573-1"><a href="instrumental-variable.html#cb573-1"></a><span class="kw">mean</span>(p_df_w<span class="op">$</span>iv_strong)</span></code></pre></div>
<pre><code>## [1] 0.2988726</code></pre>
<p>で 0.3 に近い。推定値のばらつきは、</p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb575-1"><a href="instrumental-variable.html#cb575-1"></a><span class="kw">sd</span>(p_df_w<span class="op">$</span>iv_strong)</span></code></pre></div>
<pre><code>## [1] 0.0268729</code></pre>
<p>であり、推定値の大きさと比較して不確実性もそれほど大きくない。</p>
<p>弱い操作変数はどうだろうか？まず、D と Zw の相関係数を確認してみよう。</p>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb577-1"><a href="instrumental-variable.html#cb577-1"></a><span class="kw">mean</span>(p_df_w<span class="op">$</span>cor_weak)</span></code></pre></div>
<pre><code>## [1] 0.03684498</code></pre>
<p>平均すると 0.04 程度の非常に弱い相関しかないことがわかる。IV推定値の分布を可視化する。</p>
<div class="sourceCode" id="cb579"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb579-1"><a href="instrumental-variable.html#cb579-1"></a>p_weak &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_df_w, <span class="kw">aes</span>(<span class="dt">x =</span> iv_weak, <span class="dt">y =</span> <span class="kw">after_stat</span>(density))) <span class="op">+</span></span>
<span id="cb579-2"><a href="instrumental-variable.html#cb579-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb579-3"><a href="instrumental-variable.html#cb579-3"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;弱いIVによる推定値&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;確率密度&quot;</span>)</span>
<span id="cb579-4"><a href="instrumental-variable.html#cb579-4"></a><span class="kw">plot</span>(p_weak)</span></code></pre></div>
<p><img src="kut-metrics2_files/figure-html/unnamed-chunk-383-1.png" width="384" /></p>
<p>分布範囲が非常に広く、ヒストグラムではうまく可視化できない（範囲が広いことはわかる）。
推定の平均値は、</p>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb580-1"><a href="instrumental-variable.html#cb580-1"></a><span class="kw">mean</span>(p_df_w<span class="op">$</span>iv_weak)</span></code></pre></div>
<pre><code>## [1] 0.4621742</code></pre>
<p>中央値は、</p>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb582-1"><a href="instrumental-variable.html#cb582-1"></a><span class="kw">median</span>(p_df_w<span class="op">$</span>iv_weak)</span></code></pre></div>
<pre><code>## [1] 0.3661183</code></pre>
<p>である。中央値は0.3からそれほど大きく離れていないが、平均的には効果を過大推定している。Short regression の推定の平均値が 0.4 なので、弱い操作変数によるIV推定値のバイアスは、short regression のバイアスよりも大きくなってしまっている。</p>
<p>また、推定のばらつきは、</p>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb584-1"><a href="instrumental-variable.html#cb584-1"></a><span class="kw">sd</span>(p_df_w<span class="op">$</span>iv_weak)</span></code></pre></div>
<pre><code>## [1] 3.594002</code></pre>
<p>である。推定値の大きさに対して不確実性が非常に大きく、推定がまったく信頼できないことがわかる。</p>
<p>このように、弱い操作変数を使うと推定が不安定になり、交絡を無視した単回帰よりもむしろバイアスが大きい推定値を得る可能性が高くなってしまう。よって、弱い操作変数を使ってはいけない。</p>
</div>
</div>
<div id="操作変数を利用した-mdve-の分析" class="section level2" number="9.3">
<h2><span class="header-section-number">9.3</span> 操作変数を利用した MDVE の分析</h2>
<div id="angrist-and-pischke-2009-の例-2" class="section level3" number="9.3.1">
<h3><span class="header-section-number">9.3.1</span> Angrist and Pischke (2009) の例</h3>
<p><span class="citation">Angrist and Pischke (<a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> の第3章にある、ミネアポリス家庭内暴力実験 (Minneapolis Domestic Violence Experiment; MDVE) の例を見てみよう。実験の詳細については <span class="citation">Angrist and Pischke (<a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> の3.2節と <span class="citation">Sherman and Berk (<a href="#ref-sherman1984" role="doc-biblioref">1984</a>)</span> を参照されたい。</p>
<p>この実験は、家庭内暴力 (DV) の通報があったとき（かつ、特定の条件を満たす場合）に警官が取る対応をランダムに決めることにより、警官の対応がDVの再発に与える影響を調査しようとしたものである。警官は、DVの被疑者を「逮捕する (arrest)」か、「被害者から8時間隔離する (seprate)」か、DVをやめるように「助言する (advise)」かの3つの選択肢のうちの1つをランダムに割付けられる。</p>
<p>すべての警官がランダムに決められた通りの行動をとるなら、この実験は RCT として分析することができる。しかし、
実際にはすべての警官が割付に従うわけではない。例えば、「助言」を割付けらけれたとしても、現場で被疑者が暴れて警官に殴りかかってきたような場合や、逮捕しないと明らかにDVを繰り返しそうな場合には、逮捕せざるを得ないだろう。よって、実際に警官がとった行動は、ランダムではない。そのため、DVを再発しそうな被疑者ほど逮捕されやすいというセレクションバイアスが存在すると考えられるので、この「実験」は “RCT” ではない。</p>
<p>そこで、実際に警官がとった行動を内生変数、ランダム割付を操作変数として、警官の行動がDVの再発に与える因果効果を推定してみよう。</p>
</div>
<div id="データの準備" class="section level3" number="9.3.2">
<h3><span class="header-section-number">9.3.2</span> データの準備</h3>
<p>データは、<a href="https://www.masteringmetrics.com/resources/">Mastering ’Metrics</a> から入手できる。
<code>download.file()</code> でファイルがうまくダウンロードできない場合は、ウェブブラウザで指定のURLにアクセスして手動でデータを入手する。</p>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb586-1"><a href="instrumental-variable.html#cb586-1"></a><span class="kw">download.file</span>(<span class="dt">url =</span> <span class="st">&quot;http://masteringmetrics.com/wp-content/uploads/2015/02/mdve.dta&quot;</span>,</span>
<span id="cb586-2"><a href="instrumental-variable.html#cb586-2"></a>              <span class="dt">dest =</span> <span class="st">&quot;data/mdve.dta&quot;</span>)</span></code></pre></div>
<p>Stata形式のデータなので、<code>haven::read_dta()</code> で読み込む。</p>
<div class="sourceCode" id="cb587"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb587-1"><a href="instrumental-variable.html#cb587-1"></a>MDVE &lt;-<span class="st"> </span><span class="kw">read_dta</span>(<span class="st">&quot;data/mdve.dta&quot;</span>)</span></code></pre></div>
<p>実験でランダムに割付られた処置は、T_RANDOMに記録されている。T_RANDOM が1なら「逮捕」、2なら「助言」、3なら「隔離」が割付けられた行動である。
それに対し、警官が実際にとった行動は、T_FINAL に記録されている。T_FINAL の値が1, 2, 3の場合は、T_RANDOM
と同じ意味である。これらに加え T_FINAL には4があり、「その他」を意味する。ランダム割付と実際の行動の関係を確認してみよう。</p>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb588-1"><a href="instrumental-variable.html#cb588-1"></a><span class="kw">with</span>(MDVE, <span class="kw">table</span>(T_RANDOM, T_FINAL))</span></code></pre></div>
<pre><code>##         T_FINAL
## T_RANDOM  1  2  3  4
##        1 91  0  1  1
##        2 19 84  5  2
##        3 26  5 83 13</code></pre>
<p>この表から、警官は実験の割付どおりに行動したとは限らないことがわかる。よって、この実験データを “RCT” の結果として分析することはできない。</p>
<p>しかし、実験の割付はほとんどの場合守られているので、操作変数と内生変数の間には相関がある。また、割付が実際の警官の行動（内生変数）以外の経路で結果変数に影響を与えるとは考えにくいので、除外制約も満たしているといえそうである。</p>
<p>ここでは、<span class="citation">Angrist and Pischke (<a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> に倣い、操作変数と実際の処置を、「逮捕しないこと（大目に見る; coddling）」を表すダミー変数に変換して分析する。これは、「助言」または「隔離」のときに1をとり、「逮捕」の時に0をとるダミー変数である。また、実際の処置（T_FINAL）が「その他」のものは除外する。</p>
<div class="sourceCode" id="cb590"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb590-1"><a href="instrumental-variable.html#cb590-1"></a>myd &lt;-<span class="st"> </span>MDVE <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb590-2"><a href="instrumental-variable.html#cb590-2"></a><span class="st">  </span><span class="kw">filter</span>(T_FINAL <span class="op">!=</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb590-3"><a href="instrumental-variable.html#cb590-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Z =</span> <span class="kw">ifelse</span>(T_RANDOM <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb590-4"><a href="instrumental-variable.html#cb590-4"></a>         <span class="dt">D =</span> <span class="kw">ifelse</span>(T_FINAL <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code></pre></div>
<p>上で読み込んだデータセットには結果変数である「DVの再発」を示すダミー変数がない。そこで、 <span class="citation">Berk and Sherman (<a href="#ref-berk1988" role="doc-biblioref">1988</a>)</span> の表2 (p.72) を基に結果変数を再構成する（このコードは理解しなくても良い）。</p>
<div class="sourceCode" id="cb591"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb591-1"><a href="instrumental-variable.html#cb591-1"></a>Y_ar_ar &lt;-<span class="st"> </span><span class="dv">63</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.11</span> <span class="op">+</span><span class="st"> </span><span class="dv">28</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.11</span></span>
<span id="cb591-2"><a href="instrumental-variable.html#cb591-2"></a>Y_ar_ad &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb591-3"><a href="instrumental-variable.html#cb591-3"></a>Y_ar_sp &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb591-4"><a href="instrumental-variable.html#cb591-4"></a>Y_ad_ar &lt;-<span class="st"> </span><span class="dv">18</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.17</span> <span class="op">+</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb591-5"><a href="instrumental-variable.html#cb591-5"></a>Y_ad_ad &lt;-<span class="st"> </span><span class="dv">45</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.16</span> <span class="op">+</span><span class="st"> </span><span class="dv">39</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.21</span></span>
<span id="cb591-6"><a href="instrumental-variable.html#cb591-6"></a>Y_ad_sp &lt;-<span class="st"> </span><span class="dv">4</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb591-7"><a href="instrumental-variable.html#cb591-7"></a>Y_sp_ar &lt;-<span class="st"> </span><span class="dv">22</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.18</span> <span class="op">+</span><span class="st"> </span><span class="dv">4</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.25</span></span>
<span id="cb591-8"><a href="instrumental-variable.html#cb591-8"></a>Y_sp_ad &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb591-9"><a href="instrumental-variable.html#cb591-9"></a>Y_sp_sp &lt;-<span class="st"> </span><span class="dv">40</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.23</span> <span class="op">+</span><span class="st"> </span><span class="dv">42</span> <span class="op">*</span><span class="st"> </span><span class="fl">0.26</span></span>
<span id="cb591-10"><a href="instrumental-variable.html#cb591-10"></a>n_ar_ar &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb591-11"><a href="instrumental-variable.html#cb591-11"></a>n_ar_ad &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">2</span>))</span>
<span id="cb591-12"><a href="instrumental-variable.html#cb591-12"></a>n_ar_sp &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb591-13"><a href="instrumental-variable.html#cb591-13"></a>n_ad_ar &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb591-14"><a href="instrumental-variable.html#cb591-14"></a>n_ad_ad &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">2</span>))</span>
<span id="cb591-15"><a href="instrumental-variable.html#cb591-15"></a>n_ad_sp &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb591-16"><a href="instrumental-variable.html#cb591-16"></a>n_sp_ar &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb591-17"><a href="instrumental-variable.html#cb591-17"></a>n_sp_ad &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">2</span>))</span>
<span id="cb591-18"><a href="instrumental-variable.html#cb591-18"></a>n_sp_sp &lt;-<span class="st"> </span><span class="kw">with</span>(myd, <span class="kw">sum</span>(T_RANDOM <span class="op">==</span><span class="st"> </span><span class="dv">3</span> <span class="op">&amp;</span><span class="st"> </span>T_FINAL <span class="op">==</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb591-19"><a href="instrumental-variable.html#cb591-19"></a>Y_ar_ar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ar_ar)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ar_ar <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ar_ar)))</span>
<span id="cb591-20"><a href="instrumental-variable.html#cb591-20"></a>Y_ar_ad &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ar_ad)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ar_ad <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ar_ad)))</span>
<span id="cb591-21"><a href="instrumental-variable.html#cb591-21"></a>Y_ar_sp &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ar_sp)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ar_sp <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ar_sp)))</span>
<span id="cb591-22"><a href="instrumental-variable.html#cb591-22"></a>Y_ad_ar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ad_ar)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ad_ar <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ad_ar)))</span>
<span id="cb591-23"><a href="instrumental-variable.html#cb591-23"></a>Y_ad_ad &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ad_ad)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ad_ad <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ad_ad)))</span>
<span id="cb591-24"><a href="instrumental-variable.html#cb591-24"></a>Y_ad_sp &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_ad_sp)), <span class="kw">rep</span>(<span class="dv">0</span>, n_ad_sp <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_ad_sp)))</span>
<span id="cb591-25"><a href="instrumental-variable.html#cb591-25"></a>Y_sp_ar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_sp_ar)), <span class="kw">rep</span>(<span class="dv">0</span>, n_sp_ar <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_sp_ar)))</span>
<span id="cb591-26"><a href="instrumental-variable.html#cb591-26"></a>Y_sp_ad &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_sp_ad)), <span class="kw">rep</span>(<span class="dv">0</span>, n_sp_ad <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_sp_ad)))</span>
<span id="cb591-27"><a href="instrumental-variable.html#cb591-27"></a>Y_sp_sp &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">round</span>(Y_sp_sp)), <span class="kw">rep</span>(<span class="dv">0</span>, n_sp_sp <span class="op">-</span><span class="st"> </span><span class="kw">round</span>(Y_sp_sp)))</span>
<span id="cb591-28"><a href="instrumental-variable.html#cb591-28"></a>myd &lt;-<span class="st"> </span>myd <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb591-29"><a href="instrumental-variable.html#cb591-29"></a><span class="st">  </span><span class="kw">arrange</span>(T_RANDOM, T_FINAL) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb591-30"><a href="instrumental-variable.html#cb591-30"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Y =</span> <span class="kw">c</span>(Y_ar_ar, Y_ar_ad, Y_ar_sp,</span>
<span id="cb591-31"><a href="instrumental-variable.html#cb591-31"></a>               Y_ad_ar, Y_ad_ad, Y_ad_sp,</span>
<span id="cb591-32"><a href="instrumental-variable.html#cb591-32"></a>               Y_sp_ar, Y_sp_ad, Y_sp_sp))</span></code></pre></div>
<p><span class="citation">Angrist and Pischke (<a href="#ref-ang2009" role="doc-biblioref">2009</a>)</span> によると「DVの再発」率は18%である。再構築した結果変数を使うと、</p>
<div class="sourceCode" id="cb592"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb592-1"><a href="instrumental-variable.html#cb592-1"></a><span class="kw">mean</span>(myd<span class="op">$</span>Y)</span></code></pre></div>
<pre><code>## [1] 0.1815287</code></pre>
<p>となる。このデータで分析を進めてみよう。</p>
</div>
<div id="short-regression" class="section level3" number="9.3.3">
<h3><span class="header-section-number">9.3.3</span> Short Regression</h3>
<p>まず、<span class="math inline">\(Y\)</span> を実際の警官の行動である <span class="math inline">\(D\)</span> に回帰してみよう。</p>
<div class="sourceCode" id="cb594"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb594-1"><a href="instrumental-variable.html#cb594-1"></a>dv_<span class="dv">0</span> &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D, <span class="dt">data =</span> myd)</span>
<span id="cb594-2"><a href="instrumental-variable.html#cb594-2"></a><span class="kw">tidy</span>(dv_<span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb594-3"><a href="instrumental-variable.html#cb594-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb594-4"><a href="instrumental-variable.html#cb594-4"></a><span class="st">  </span><span class="kw">select</span>(term, estimate, std.error) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb594-5"><a href="instrumental-variable.html#cb594-5"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">D</td>
<td align="right">0.087</td>
<td align="right">0.044</td>
</tr>
</tbody>
</table>
<p>逮捕しない（大目に見る）と、DVの再発率が 8.7 ポイント上昇するという推定結果が得られた。（<span class="citation">Angrist (<a href="#ref-angrist2006" role="doc-biblioref">2006</a>)</span> の Table 3 (p.34) と同じ結果である。）</p>
<p>しかし、この結果をそのまま「逮捕しないこと」の効果だと考えることはできない。警官の行動はランダムに決まっていない（ランダムに決めた行動から逸脱しているケースがある）ので、セレクションバイアスの存在が疑われる。</p>
<p>そこで、以下では操作変数を使って処置効果の推定を試みる。</p>
</div>
<div id="操作変数法による推定" class="section level3" number="9.3.4">
<h3><span class="header-section-number">9.3.4</span> 操作変数法による推定</h3>
<div id="相関の確認" class="section level4" number="9.3.4.1">
<h4><span class="header-section-number">9.3.4.1</span> 相関の確認</h4>
<p>念のため、操作変数と内生変数の相関の強さを確かめておこう。そのために、第1段階の回帰を行う。</p>
<div class="sourceCode" id="cb595"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb595-1"><a href="instrumental-variable.html#cb595-1"></a>iv_first &lt;-<span class="st"> </span><span class="kw">lm</span>(D <span class="op">~</span><span class="st"> </span>Z, <span class="dt">data =</span> myd)</span>
<span id="cb595-2"><a href="instrumental-variable.html#cb595-2"></a><span class="kw">tidy</span>(iv_first) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb595-3"><a href="instrumental-variable.html#cb595-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;Z&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb595-4"><a href="instrumental-variable.html#cb595-4"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Z</td>
<td align="right">0.786</td>
<td align="right">0.043</td>
<td align="right">18.451</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(t\)</span> 値が18.45 であり、目安である3.2を超えているので、弱くない相関があると判断する。</p>
</div>
<div id="iv公式" class="section level4" number="9.3.4.2">
<h4><span class="header-section-number">9.3.4.2</span> IV公式</h4>
<p>まず、IV 公式によって局所的平均処置効果 (LATE) を推定してみよう。</p>
<div class="sourceCode" id="cb596"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb596-1"><a href="instrumental-variable.html#cb596-1"></a><span class="kw">with</span>(myd, <span class="kw">cov</span>(Y, Z) <span class="op">/</span><span class="st"> </span><span class="kw">cov</span>(D, Z))</span></code></pre></div>
<pre><code>## [1] 0.1309924</code></pre>
<p>推定値は 0.13 であり、short regression の推定値よりも大きい（<span class="citation">Angrist (<a href="#ref-angrist2006" role="doc-biblioref">2006</a>)</span> では推定値が0.140 である）。単純に観察された処置（内生変数）<span class="math inline">\(D\)</span> に回帰すると、効果が過小推定されるということが示唆される。</p>
<p>実際にやることは IV 公式とまったく同じだが、念のために第1段階の回帰（既に実行済み）と誘導型回帰を行うことで、IV推定値を求めてみよう。</p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb598-1"><a href="instrumental-variable.html#cb598-1"></a>iv_reduced &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">data =</span> myd)</span>
<span id="cb598-2"><a href="instrumental-variable.html#cb598-2"></a><span class="kw">coef</span>(iv_reduced)[<span class="dv">2</span>] <span class="op">/</span><span class="st"> </span><span class="kw">coef</span>(iv_first)[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>##         Z 
## 0.1309924</code></pre>
<p>（当然だが）同じ結果が得られた。</p>
</div>
<div id="sls" class="section level4" number="9.3.4.3">
<h4><span class="header-section-number">9.3.4.3</span> 2SLS</h4>
<p>次に、2段階回帰 (2SLS, TSLS) で推定値を求めてみよう。上で実行した第1段階の回帰の結果から、<span class="math inline">\(D\)</span>の予測値 <span class="math inline">\(\hat{D}\)</span> を求める。</p>
<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb600-1"><a href="instrumental-variable.html#cb600-1"></a>myd &lt;-<span class="st"> </span>myd <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb600-2"><a href="instrumental-variable.html#cb600-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">D_hat =</span> <span class="kw">fitted</span>(iv_first))</span></code></pre></div>
<p>第2段階として、<span class="math inline">\(Y\)</span> を <span class="math inline">\(\hat{D}\)</span> に回帰する。</p>
<div class="sourceCode" id="cb601"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb601-1"><a href="instrumental-variable.html#cb601-1"></a>iv_second &lt;-<span class="st"> </span><span class="kw">lm</span>(Y <span class="op">~</span><span class="st"> </span>D_hat, <span class="dt">data =</span> myd)</span>
<span id="cb601-2"><a href="instrumental-variable.html#cb601-2"></a><span class="kw">tidy</span>(iv_second) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb601-3"><a href="instrumental-variable.html#cb601-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D_hat&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb601-4"><a href="instrumental-variable.html#cb601-4"></a><span class="st">  </span><span class="kw">select</span>(estimate)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   estimate
##      &lt;dbl&gt;
## 1    0.131</code></pre>
<p>2SLS でも、IV公式と同じ推定値が得られることがわかる。</p>
</div>
<div id="iv-用の関数を使う" class="section level4" number="9.3.4.4">
<h4><span class="header-section-number">9.3.4.4</span> IV 用の関数を使う</h4>
<p>推定値を得るだけなら、IV公式や2SLS を使えば良い。しかし、それらの方法では推定の不確実性を表す標準誤差を得ることができない（一般に、2SLS で得られる標準誤差は正しくない）。よって、実際に操作変数法を使う場合には、操作変数用に用意された関数を用いたほうが良い（もちろん、手動で正しい標準誤差を求めても良い）。</p>
<p>ここでは、<strong>estimatr</strong> パッケージの <code>iv_robust()</code> 関数を使う。推定する formula の途中に <code>|</code> を書き、その左側に内生変数を、右側に操作変数を書く。MDVE の例では、次のようにする。（<code>se_type</code> は指定しなくても良いが、そうすると標準誤差の計算方法が変わり、後で紹介する <code>AER::ivreg()</code> と異なる結果になる。）</p>
<div class="sourceCode" id="cb603"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb603-1"><a href="instrumental-variable.html#cb603-1"></a>iv_fit1 &lt;-<span class="st"> </span><span class="kw">iv_robust</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">|</span><span class="st"> </span>Z, <span class="dt">data =</span> myd, </span>
<span id="cb603-2"><a href="instrumental-variable.html#cb603-2"></a>                     <span class="dt">se_type =</span> <span class="st">&quot;classical&quot;</span>)</span>
<span id="cb603-3"><a href="instrumental-variable.html#cb603-3"></a><span class="kw">tidy</span>(iv_fit1) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb603-4"><a href="instrumental-variable.html#cb603-4"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb603-5"><a href="instrumental-variable.html#cb603-5"></a><span class="st">  </span><span class="kw">select</span>(term, estimate, std.error) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb603-6"><a href="instrumental-variable.html#cb603-6"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">D</td>
<td align="right">0.131</td>
<td align="right">0.061</td>
</tr>
</tbody>
</table>
<p>上と同じ推定結果が得られた。標準誤差は0.061 であり、推定された効果が5%水準で統計的に有意であることがわかる。</p>
<p>また、<strong>AER</strong> パッケージの<code>ivreg()</code> 関数を使うこともできる。</p>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb604-1"><a href="instrumental-variable.html#cb604-1"></a>iv_fit2 &lt;-<span class="st"> </span><span class="kw">ivreg</span>(Y <span class="op">~</span><span class="st"> </span>D <span class="op">|</span><span class="st"> </span>Z, <span class="dt">data =</span> myd)</span>
<span id="cb604-2"><a href="instrumental-variable.html#cb604-2"></a><span class="kw">tidy</span>(iv_fit2) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb604-3"><a href="instrumental-variable.html#cb604-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;D&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb604-4"><a href="instrumental-variable.html#cb604-4"></a><span class="st">  </span><span class="kw">select</span>(term, estimate, std.error) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb604-5"><a href="instrumental-variable.html#cb604-5"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">D</td>
<td align="right">0.131</td>
<td align="right">0.061</td>
</tr>
</tbody>
</table>
<p>先ほどとまったく同じ結果が得られた。</p>
<p>どちらの関数を使う場合も、共変量がある場合には <code>|</code> の <strong>両側に</strong>共変量を加える。例えば、X1 と X2 という2つの共変量がある場合には、<code>ivreg(Y ~ D + X1 + X2 | X1 + X2 + Z, data = myd)</code> のように書く。</p>
</div>
</div>
</div>
<div id="トピック9の課題" class="section level2" number="9.4">
<h2><span class="header-section-number">9.4</span> トピック9の課題</h2>
<p>タバコの価格は、タバコの売り上げにどのような影響を与えるだろうか。
この疑問に関して、<strong>AER</strong> パッケージの CigarettesSW データを利用して、以下の問いに答えなさい。
このデータは、以下のようにして取り出せる。</p>
<div class="sourceCode" id="cb605"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb605-1"><a href="instrumental-variable.html#cb605-1"></a><span class="kw">library</span>(AER)</span>
<span id="cb605-2"><a href="instrumental-variable.html#cb605-2"></a><span class="kw">data</span>(<span class="st">&quot;CigarettesSW&quot;</span>)</span></code></pre></div>
<p>また、このデータセットに含まれる主な変数は、</p>
<ul>
<li>packs：1人当たりのタバコの購入数（単位：箱）</li>
<li>price：タバコ1箱の税込価格</li>
<li>cpi：CPI（消費者物価指数）</li>
<li>tax：平均的な税額</li>
<li>taxs：消費税</li>
</ul>
<p>である。データの詳細は、<code>help(CigarettesSW)</code> で確認できる。</p>
<p>課題で実行する内容：</p>
<ol style="list-style-type: decimal">
<li>タバコの売り上げ (packs) をタバコの価格 (price) に回帰するだけでは、価格が需要（売り上げ）に与える効果を推定できないと考えられる理由を説明しなさい。</li>
<li>以下の変数を作りなさい</li>
</ol>
<ul>
<li>タバコの相対価格： price / cpi</li>
<li>相対化した消費税： (taxs - tax) / cpi</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>タバコの売り上げを結果変数、タバコの相対価格（2で作ったもの）を内生変数、消費税（2で作ったもの）を操作変数として、タバコの価格がタバコの売り上げに与える効果を推定しなさい。</li>
</ol>
<ul>
<li>ただし、対象は1995年 (year == “1995”) とする。</li>
<li>推定する前に、必要な変数変換を実行すること（ヒント：需要の価格<strong>弾力性</strong>を調べるためには、どのような変換が有効だろうか？）</li>
<li>単に推定値を示すだけでなく、操作変数法の仮定についても議論すること。</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>タバコの売り上げをタバコの相対価格に回帰しなさい。</li>
</ol>
<ul>
<li>ただし、3と同様に変数変換すること</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>3と4の結果を比較し、どのようなことがわかるか説明しなさい。</li>
</ol>
<p>注意：</p>
<ul>
<li>課題レポートは R Markdown で作成し、PDF に knit して提出すること。</li>
<li>提出するファイル：metrics_hw09_LastFirst.pdf</li>
<li>提出方法：Slack のダイレクトメッセージで提出。</li>
<li><strong>提出期限：2020年7月30日（木）正午</strong>（日本時間）</li>
<li><strong>トピック6, 8, 9 の課題からどれか1つを選んで提出</strong>
<ul>
<li>どれを選んでも良いが、提出期限が異なるので注意。</li>
<li>2つ以上提出した場合、最も評価が高いものを成績評価の対象とする。</li>
</ul></li>
</ul>

</div>
</div>
<h3>参考文献</h3>
<div id="refs" class="references">
<div id="ref-angrist2006">
<p>Angrist, Joshua D. 2006. “Instrumental Variables Methods in Experimental Criminological Research: What, Why and How.” <em>Journal of Experimental Criminology</em> 2: 23–44. <a href="https://doi.org/10.1007/s11292-005-5126-x">https://doi.org/10.1007/s11292-005-5126-x</a>.</p>
</div>
<div id="ref-ang2009">
<p>Angrist, Joshua D., and Jörn-Steffen Pischke. 2009. <em>Mostly Harmless Econometrics: An Empiricist’s Companion</em>. Princeton: Princeton University Press.</p>
</div>
<div id="ref-berk1988">
<p>Berk, Richard A., and Lawrence W. Sherman. 1988. “Police Responses to Family Violence Incidents.” <em>Journal of the American Statistical Association</em> 83: 70–76. <a href="https://doi.org/10.1080/01621459.1988.10478566">https://doi.org/10.1080/01621459.1988.10478566</a>.</p>
</div>
<div id="ref-sherman1984">
<p>Sherman, Lawrence W., and Richard A. Berk. 1984. “THe Specific Deterrent Effects of Arrest Fro Domestic Assault.” <em>American Sociological Review</em> 49 (2): 261–72. <a href="http://masteringmetrics.com/wp-content/uploads/2015/02/Sherman_Berk_1984.pdf">http://masteringmetrics.com/wp-content/uploads/2015/02/Sherman_Berk_1984.pdf</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="regression-discontinuity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="final-presentation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
